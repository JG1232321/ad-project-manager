<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>광고 프로젝트 관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* 드래그 앤 드롭 스타일 */
        .bucket-card {
            transition: all 0.2s ease;
        }
        
        .bucket-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .drop-zone.drag-active {
            background-color: #f0f9ff;
            border: 2px dashed #3b82f6;
            border-radius: 8px;
        }
        
        .drop-zone.drag-over {
            background-color: #e0f2fe;
            border: 2px solid #0ea5e9;
            transform: scale(1.02);
        }
        
        .bucket-card[draggable="true"] {
            cursor: move;
        }
        
        .bucket-card:active {
            cursor: grabbing;
        }
        
        /* 드래그 중일 때 선택 방지 */
        .drop-zone.drag-active * {
            pointer-events: none;
        }
        
        .drop-zone.drag-active .bucket-card {
            pointer-events: auto;
        }
        
        /* 드래그 핸들 스타일 */
        .bucket-card .cursor-move:hover {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 로그인 모달 -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-center mb-6">🔐 업무관리앱 로그인</h2>
            
            <!-- 로그인 폼 -->
            <div id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">사용자 ID</label>
                    <input type="text" id="loginUserId" placeholder="사용자 ID를 입력하세요" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">비밀번호</label>
                    <input type="password" id="loginPassword" placeholder="비밀번호를 입력하세요" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-3">
                    <button onclick="handleLogin()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        로그인
                    </button>
                    <button onclick="showSignupForm()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        회원가입
                    </button>
                </div>
            </div>

            <!-- 회원가입 폼 -->
            <div id="signupForm" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">사용자 ID</label>
                    <input type="text" id="signupUserId" placeholder="사용할 ID를 입력하세요" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">비밀번호</label>
                    <input type="password" id="signupPassword" placeholder="비밀번호를 입력하세요" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">이름</label>
                    <input type="text" id="signupName" placeholder="이름을 입력하세요" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-3">
                    <button onclick="handleSignup()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        회원가입
                    </button>
                    <button onclick="showLoginForm()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        로그인으로
                    </button>
                </div>
            </div>

            <div id="authStatus" class="mt-4 text-sm text-center text-gray-600"></div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-6">
        <!-- 헤더 -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-gray-800 mb-3">📊 광고 프로젝트 관리</h1>
                <p class="text-gray-600 text-lg">광고주별 버킷으로 업무를 체계적으로 관리하세요</p>
            </div>
            <div id="userInfo" class="text-right hidden">
                <p class="text-sm text-gray-600">환영합니다!</p>
                <p class="font-semibold text-gray-800" id="userName"></p>
                <button onclick="logout()" class="mt-1 px-3 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                    로그아웃
                </button>
            </div>
        </div>

        <!-- 로딩 상태 -->
        <div id="loadingIndicator" class="text-center py-8 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">데이터를 불러오는 중...</p>
        </div>

        <!-- 오늘 마감 알림 -->
        <div id="todayDeadlines" class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg hidden">
            <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-red-700 font-semibold">오늘 마감인 업무</h3>
            </div>
            <div id="todayDeadlinesList"></div>
        </div>

        <!-- 뷰 전환 탭 -->
        <div class="mb-6">
            <div class="flex border-b border-gray-200">
                <button id="bucketsViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600">
                    버킷 뷰
                </button>
                <button id="stageViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    단계별 뷰
                </button>
                <button id="todoViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    투두리스트
                </button>
                <button id="recurringViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    반복 규칙
                </button>
                <button id="memoViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    메모장
                </button>
            </div>
        </div>

        <!-- 새 버킷 추가 섹션 -->
        <div id="addBucketSection" class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <button id="addBucketBtn" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    ➕ 새 광고주 추가
                </button>
                <div class="flex gap-2">
                    <button id="toggleBucketCompletedBtn" class="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm">
                        <span>👁️</span>
                        <span id="toggleBucketCompletedText">완료항목 숨기기</span>
                    </button>
                    <button id="sortBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        <span>📅</span>
                        <span id="sortText">마감일 오름차순</span>
                    </button>
                </div>
            </div>
            
            <!-- 추가 폼 -->
            <div id="addBucketForm" class="bg-white p-6 rounded-lg shadow hidden">
                <h3 class="text-lg font-semibold mb-4">새 광고주 정보</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">광고주명 *</label>
                        <input type="text" id="bucketNameInput" placeholder="광고주명을 입력하세요" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">단가 (원)</label>
                        <input type="text" id="unitPriceInput" placeholder="예: 1,000,000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">수량</label>
                        <input type="text" id="quantityInput" placeholder="예: 100회 노출" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">상품</label>
                        <select id="productInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">상품 선택</option>
                            <option value="CPM">CPM</option>
                            <option value="CPA">CPA</option>
                            <option value="CPA+">CPA+</option>
                            <option value="CPR">CPR</option>
                            <option value="CPR+">CPR+</option>
                            <option value="CPS">CPS</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">계약조건 및 기타사항</label>
                    <textarea id="contractTermsInput" placeholder="계약 조건 및 기타사항을 입력하세요..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                </div>
                <div class="flex gap-3">
                    <button id="confirmAddBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">추가</button>
                    <button id="cancelAddBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">취소</button>
                </div>
            </div>
        </div>

        <!-- 버킷 뷰 -->
        <div id="bucketsView">
            <div id="bucketsContainer" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
            <div id="emptyState" class="text-center py-16">
                <div class="text-6xl mb-4">📋</div>
                <p class="text-gray-500 text-xl mb-2">아직 등록된 광고주가 없습니다.</p>
                <p class="text-gray-400">새 광고주를 추가해서 업무 관리를 시작하세요.</p>
            </div>
        </div>

        <!-- 단계별 뷰 -->
        <div id="stageView" class="hidden">
            <div class="grid gap-6 lg:grid-cols-4">
                <!-- 대기 단계 -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="bg-gray-100 px-4 py-3 rounded-t-lg border-b">
                        <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                            ⏳ 대기
                            <span id="waitingCount" class="bg-gray-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="waitingStage" class="p-4 space-y-3 min-h-[400px] drop-zone" data-stage="대기"></div>
                </div>

                <!-- 광고제작 단계 -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="bg-blue-100 px-4 py-3 rounded-t-lg border-b">
                        <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                            🎨 광고제작
                            <span id="creativeCount" class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="creativeStage" class="p-4 space-y-3 min-h-[400px] drop-zone" data-stage="진행_광고제작"></div>
                </div>

                <!-- 광고운영 단계 -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="bg-green-100 px-4 py-3 rounded-t-lg border-b">
                        <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                            📈 광고운영
                            <span id="operationCount" class="bg-green-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="operationStage" class="p-4 space-y-3 min-h-[400px] drop-zone" data-stage="진행_광고운영"></div>
                </div>

                <!-- 매출정산 단계 -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="bg-purple-100 px-4 py-3 rounded-t-lg border-b">
                        <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                            💰 매출정산
                            <span id="settlementCount" class="bg-purple-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="settlementStage" class="p-4 space-y-3 min-h-[400px] drop-zone" data-stage="진행_매출정산"></div>
                </div>
            </div>
        </div>

        <!-- 투두리스트 뷰 -->
        <div id="todoView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">전체 액션아이템</h2>
                <div class="flex gap-2">
                    <button id="addTodoBtn" class="flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        <span>➕</span>
                        <span>새 액션아이템</span>
                    </button>
                    <button id="exportExcelBtn" class="flex items-center gap-2 px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                        <span>📊</span>
                        <span>엑셀 다운로드</span>
                    </button>
                    <button id="toggleCompletedBtn" class="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm">
                        <span>👁️</span>
                        <span id="toggleCompletedText">완료항목 숨기기</span>
                    </button>
                    <button id="todoSortBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        <span>📅</span>
                        <span id="todoSortText">마감일 오름차순</span>
                    </button>
                </div>
            </div>
            
            <!-- 새 액션아이템 추가 폼 -->
            <div id="addTodoForm" class="bg-gray-50 p-4 rounded-lg mb-4 hidden">
                <h3 class="text-lg font-semibold mb-3">새 액션아이템 추가</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">광고주 선택 *</label>
                        <select id="todoBucketSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">광고주를 선택하세요</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">마감일</label>
                        <input type="date" id="todoDeadlineInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">액션아이템 내용 *</label>
                    <input type="text" id="todoTextInput" placeholder="액션아이템 내용을 입력하세요" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-3">
                    <button id="confirmAddTodoBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">추가</button>
                    <button id="cancelAddTodoBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">취소</button>
                </div>
            </div>
            
            <div id="todoList" class="space-y-3"></div>
            <div id="todoEmpty" class="text-gray-500 text-center py-8 hidden">등록된 액션아이템이 없습니다.</div>
        </div>

        <!-- 반복 규칙 뷰 -->
        <div id="recurringView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">반복 규칙 관리</h2>
                <button id="addRecurringRuleBtn" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    <span>🔄</span>
                    <span>새 반복 규칙</span>
                </button>
            </div>
            
            <!-- 새 반복 규칙 추가 폼 -->
            <div id="addRecurringForm" class="bg-gray-50 p-6 rounded-lg mb-6 hidden">
                <h3 class="text-lg font-semibold mb-4">새 반복 규칙 생성</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">규칙명 *</label>
                        <input type="text" id="ruleNameInput" placeholder="예: 일일 성과 체크" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">광고주 선택 *</label>
                        <select id="ruleBucketSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">광고주를 선택하세요</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">액션아이템 내용 *</label>
                    <input type="text" id="ruleActionInput" placeholder="생성될 액션아이템 내용" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- 반복 설정 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">반복 주기 *</label>
                        <select id="repeatTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="daily">매일</option>
                            <option value="weekly">매주</option>
                            <option value="monthly">매월</option>
                        </select>
                    </div>
                    <div id="weeklyDayContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">요일 선택</label>
                        <select id="weeklyDaySelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1">월요일</option>
                            <option value="2">화요일</option>
                            <option value="3">수요일</option>
                            <option value="4">목요일</option>
                            <option value="5">금요일</option>
                            <option value="6">토요일</option>
                            <option value="0">일요일</option>
                        </select>
                    </div>
                    <div id="monthlyDateContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">날짜 선택</label>
                        <select id="monthlyDateSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- 1일부터 31일까지 옵션 생성 -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">생성 시간</label>
                        <input type="time" id="createTimeInput" value="09:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- 마감일 설정 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">마감일 설정</label>
                        <select id="deadlineTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="none">마감일 없음</option>
                            <option value="same_day">당일 마감</option>
                            <option value="next_day">다음날 마감</option>
                            <option value="days_after">N일 후 마감</option>
                        </select>
                    </div>
                    <div id="deadlineDaysContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">마감까지 일수</label>
                        <input type="number" id="deadlineDaysInput" value="1" min="1" max="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- 활성 기간 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">시작일 *</label>
                        <input type="date" id="startDateInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">종료일 (선택사항)</label>
                        <input type="date" id="endDateInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">상태</label>
                        <select id="ruleStatusSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="active">활성</option>
                            <option value="inactive">비활성</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="confirmAddRuleBtn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">생성</button>
                    <button id="cancelAddRuleBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">취소</button>
                </div>
            </div>

            <!-- 반복 규칙 목록 -->
            <div id="recurringRulesList" class="space-y-3"></div>
            <div id="recurringEmpty" class="text-gray-500 text-center py-8">등록된 반복 규칙이 없습니다.</div>
        </div>

        <!-- 메모장 뷰 -->
        <div id="memoView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">메모장</h2>
                <div class="flex gap-2">
                    <button id="saveMemoBtn" class="flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        <span>💾</span>
                        <span>저장</span>
                    </button>
                    <button id="clearMemoBtn" class="flex items-center gap-2 px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                        <span>🗑️</span>
                        <span>전체 삭제</span>
                    </button>
                </div>
            </div>
            <textarea id="memoTextarea" placeholder="자유롭게 메모를 작성하세요..." class="w-full h-[600px] px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
            <div id="memoStatus" class="mt-2 text-sm text-gray-500"></div>
        </div>
    </div>

    <!-- 푸터 -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-sm">© 2025 광고 프로젝트 관리 시스템 | 제작자: 이재광</p>
        </div>
    </footer>

    <script>
        // ⚠️ 여기에 새로운 Supabase URL과 KEY를 입력하세요 ⚠️
        const SUPABASE_URL = 'https://tnnmmdrzscylsqbmkbnq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRubm1tZHJ6c2N5bHNxYm1rYm5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNTU4ODMsImV4cCI6MjA2OTkzMTg4M30.AQbxl7n_b-yLbC46X9F9kQI_AHOO9cmXtYSu9eUifvI';
        
        // 전역 변수
        let supabase;
        let buckets = [];
        let recurringRules = [];
        let userId;
        let currentUser = null;
        let currentView = 'buckets';
        let sortOrder = 'asc';
        let collapsedBuckets = {};
        let collapsedContracts = {};
        let editingBucket = null;
        let editingAction = null;
        let editingRule = null;
        let showCompletedTodos = true;
        let showCompletedInBuckets = true;

        // DOM 요소들
        let bucketsViewBtn, stageViewBtn, todoViewBtn, recurringViewBtn, memoViewBtn, addBucketSection, addBucketBtn, addBucketForm;
        let bucketNameInput, unitPriceInput, quantityInput, productInput, contractTermsInput;
        let confirmAddBtn, cancelAddBtn, sortBtn, sortText, loadingIndicator;
        let todayDeadlines, todayDeadlinesList, todoView, memoView, bucketsView, stageView, recurringView;
        let todoList, todoEmpty, todoSortBtn, todoSortText;
        let toggleCompletedBtn, toggleCompletedText, bucketsContainer, emptyState;
        let exportExcelBtn, toggleBucketCompletedBtn, toggleBucketCompletedText;
        let addTodoBtn, addTodoForm, todoBucketSelect, todoDeadlineInput, todoTextInput;
        let confirmAddTodoBtn, cancelAddTodoBtn, memoTextarea, saveMemoBtn, clearMemoBtn, memoStatus;
        
        // 인증 관련 DOM 요소들
        let loginModal, loginUserId, loginPassword, signupUserId, signupPassword, signupName;
        let loginForm, signupForm, authStatus, userInfo, userName;
        
        // 단계별 뷰 DOM 요소들
        let waitingStage, creativeStage, operationStage, settlementStage;
        let waitingCount, creativeCount, operationCount, settlementCount;

        // 반복 규칙 DOM 요소들
        let addRecurringRuleBtn, addRecurringForm, ruleNameInput, ruleBucketSelect, ruleActionInput;
        let repeatTypeSelect, weeklyDayContainer, weeklyDaySelect, monthlyDateContainer, monthlyDateSelect;
        let createTimeInput, deadlineTypeSelect, deadlineDaysContainer, deadlineDaysInput;
        let startDateInput, endDateInput, ruleStatusSelect, confirmAddRuleBtn, cancelAddRuleBtn;
        let recurringRulesList, recurringEmpty;

        // 앱 초기화
        async function initApp() {
            try {
                console.log('앱 초기화 시작');
                
                // Supabase 클라이언트 초기화
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // DOM 요소 초기화
                initializeElements();
                initializeAuthElements();
                initializeStageElements();
                initializeRecurringElements();
                
                // 이벤트 리스너 설정
                setupEventListeners();
                setupAuthEventListeners();
                setupRecurringEventListeners();
                
                // 로그인 상태 확인
                await checkAuthStatus();
                
                console.log('앱 초기화 완료');
            } catch (error) {
                console.error('앱 초기화 오류:', error);
                showError('앱 초기화 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // DOM 요소 초기화
        function initializeElements() {
            bucketsViewBtn = document.getElementById('bucketsViewBtn');
            stageViewBtn = document.getElementById('stageViewBtn');
            todoViewBtn = document.getElementById('todoViewBtn');
            recurringViewBtn = document.getElementById('recurringViewBtn');
            memoViewBtn = document.getElementById('memoViewBtn');
            addBucketSection = document.getElementById('addBucketSection');
            addBucketBtn = document.getElementById('addBucketBtn');
            addBucketForm = document.getElementById('addBucketForm');
            bucketNameInput = document.getElementById('bucketNameInput');
            unitPriceInput = document.getElementById('unitPriceInput');
            quantityInput = document.getElementById('quantityInput');
            productInput = document.getElementById('productInput');
            contractTermsInput = document.getElementById('contractTermsInput');
            confirmAddBtn = document.getElementById('confirmAddBtn');
            cancelAddBtn = document.getElementById('cancelAddBtn');
            sortBtn = document.getElementById('sortBtn');
            sortText = document.getElementById('sortText');
            loadingIndicator = document.getElementById('loadingIndicator');
            todayDeadlines = document.getElementById('todayDeadlines');
            todayDeadlinesList = document.getElementById('todayDeadlinesList');
            todoView = document.getElementById('todoView');
            memoView = document.getElementById('memoView');
            bucketsView = document.getElementById('bucketsView');
            stageView = document.getElementById('stageView');
            recurringView = document.getElementById('recurringView');
            todoList = document.getElementById('todoList');
            todoEmpty = document.getElementById('todoEmpty');
            todoSortBtn = document.getElementById('todoSortBtn');
            todoSortText = document.getElementById('todoSortText');
            toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
            toggleCompletedText = document.getElementById('toggleCompletedText');
            bucketsContainer = document.getElementById('bucketsContainer');
            emptyState = document.getElementById('emptyState');
            exportExcelBtn = document.getElementById('exportExcelBtn');
            toggleBucketCompletedBtn = document.getElementById('toggleBucketCompletedBtn');
            toggleBucketCompletedText = document.getElementById('toggleBucketCompletedText');
            addTodoBtn = document.getElementById('addTodoBtn');
            addTodoForm = document.getElementById('addTodoForm');
            todoBucketSelect = document.getElementById('todoBucketSelect');
            todoDeadlineInput = document.getElementById('todoDeadlineInput');
            todoTextInput = document.getElementById('todoTextInput');
            confirmAddTodoBtn = document.getElementById('confirmAddTodoBtn');
            cancelAddTodoBtn = document.getElementById('cancelAddTodoBtn');
            memoTextarea = document.getElementById('memoTextarea');
            saveMemoBtn = document.getElementById('saveMemoBtn');
            clearMemoBtn = document.getElementById('clearMemoBtn');
            memoStatus = document.getElementById('memoStatus');
        }

        // 인증 관련 DOM 요소 초기화
        function initializeAuthElements() {
            loginModal = document.getElementById('loginModal');
            loginUserId = document.getElementById('loginUserId');
            loginPassword = document.getElementById('loginPassword');
            signupUserId = document.getElementById('signupUserId');
            signupPassword = document.getElementById('signupPassword');
            signupName = document.getElementById('signupName');
            loginForm = document.getElementById('loginForm');
            signupForm = document.getElementById('signupForm');
            authStatus = document.getElementById('authStatus');
            userInfo = document.getElementById('userInfo');
            userName = document.getElementById('userName');
        }

        // 단계별 뷰 DOM 요소 초기화
        function initializeStageElements() {
            waitingStage = document.getElementById('waitingStage');
            creativeStage = document.getElementById('creativeStage');
            operationStage = document.getElementById('operationStage');
            settlementStage = document.getElementById('settlementStage');
            waitingCount = document.getElementById('waitingCount');
            creativeCount = document.getElementById('creativeCount');
            operationCount = document.getElementById('operationCount');
            settlementCount = document.getElementById('settlementCount');
        }

        // 반복 규칙 DOM 요소 초기화
        function initializeRecurringElements() {
            addRecurringRuleBtn = document.getElementById('addRecurringRuleBtn');
            addRecurringForm = document.getElementById('addRecurringForm');
            ruleNameInput = document.getElementById('ruleNameInput');
            ruleBucketSelect = document.getElementById('ruleBucketSelect');
            ruleActionInput = document.getElementById('ruleActionInput');
            repeatTypeSelect = document.getElementById('repeatTypeSelect');
            weeklyDayContainer = document.getElementById('weeklyDayContainer');
            weeklyDaySelect = document.getElementById('weeklyDaySelect');
            monthlyDateContainer = document.getElementById('monthlyDateContainer');
            monthlyDateSelect = document.getElementById('monthlyDateSelect');
            createTimeInput = document.getElementById('createTimeInput');
            deadlineTypeSelect = document.getElementById('deadlineTypeSelect');
            deadlineDaysContainer = document.getElementById('deadlineDaysContainer');
            deadlineDaysInput = document.getElementById('deadlineDaysInput');
            startDateInput = document.getElementById('startDateInput');
            endDateInput = document.getElementById('endDateInput');
            ruleStatusSelect = document.getElementById('ruleStatusSelect');
            confirmAddRuleBtn = document.getElementById('confirmAddRuleBtn');
            cancelAddRuleBtn = document.getElementById('cancelAddRuleBtn');
            recurringRulesList = document.getElementById('recurringRulesList');
            recurringEmpty = document.getElementById('recurringEmpty');

            // 월별 날짜 옵션 생성
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}일`;
                monthlyDateSelect.appendChild(option);
            }

            // 기본값 설정
            const today = new Date();
            startDateInput.value = today.toISOString().split('T')[0];
        }

        // 이벤트 리스너 등록
        function setupEventListeners() {
            bucketsViewBtn.addEventListener('click', () => switchView('buckets'));
            stageViewBtn.addEventListener('click', () => switchView('stage'));
            todoViewBtn.addEventListener('click', () => switchView('todo'));
            recurringViewBtn.addEventListener('click', () => switchView('recurring'));
            memoViewBtn.addEventListener('click', () => switchView('memo'));
            addBucketBtn.addEventListener('click', showAddForm);
            confirmAddBtn.addEventListener('click', addBucket);
            cancelAddBtn.addEventListener('click', hideAddForm);
            sortBtn.addEventListener('click', toggleSort);
            todoSortBtn.addEventListener('click', toggleTodoSort);
            toggleCompletedBtn.addEventListener('click', toggleCompletedVisibility);
            toggleBucketCompletedBtn.addEventListener('click', toggleBucketCompletedVisibility);
            exportExcelBtn.addEventListener('click', exportToExcel);
            addTodoBtn.addEventListener('click', showAddTodoForm);
            confirmAddTodoBtn.addEventListener('click', addTodoItem);
            cancelAddTodoBtn.addEventListener('click', hideAddTodoForm);
            saveMemoBtn.addEventListener('click', saveMemo);
            clearMemoBtn.addEventListener('click', clearMemo);

            bucketNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addBucket();
                }
            });
            
            todoTextInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addTodoItem();
                }
            });

            // 메모 자동저장
            memoTextarea.addEventListener('input', autoSaveMemo);
        }

        // 인증 이벤트 리스너
        function setupAuthEventListeners() {
            loginUserId.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginPassword.focus();
            });
            
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            signupUserId.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signupPassword.focus();
            });
            
            signupPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signupName.focus();
            });
            
            signupName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSignup();
            });
        }

        // 반복 규칙 이벤트 리스너
        function setupRecurringEventListeners() {
            addRecurringRuleBtn.addEventListener('click', showAddRecurringForm);
            confirmAddRuleBtn.addEventListener('click', addRecurringRule);
            cancelAddRuleBtn.addEventListener('click', hideAddRecurringForm);

            repeatTypeSelect.addEventListener('change', function() {
                weeklyDayContainer.classList.add('hidden');
                monthlyDateContainer.classList.add('hidden');
                
                if (this.value === 'weekly') {
                    weeklyDayContainer.classList.remove('hidden');
                } else if (this.value === 'monthly') {
                    monthlyDateContainer.classList.remove('hidden');
                }
            });

            deadlineTypeSelect.addEventListener('change', function() {
                if (this.value === 'days_after') {
                    deadlineDaysContainer.classList.remove('hidden');
                } else {
                    deadlineDaysContainer.classList.add('hidden');
                }
            });

            ruleNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addRecurringRule();
                }
            });
        }

        // 로그인 상태 확인
        async function checkAuthStatus() {
            const savedAuth = localStorage.getItem('userAuth');
            if (savedAuth) {
                try {
                    const authData = JSON.parse(savedAuth);
                    
                    const { data: userData, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('user_id', authData.userId)
                        .eq('password_hash', authData.passwordHash)
                        .single();

                    if (!error && userData) {
                        currentUser = userData;
                        userId = userData.user_id;
                        userName.textContent = userData.name;
                        userInfo.classList.remove('hidden');
                        hideLoginModal();
                        await loadData();
                        updateTodayDeadlines();
                        startRecurringCheck();
                        return;
                    }
                } catch (error) {
                    console.log('저장된 인증 정보가 유효하지 않습니다.');
                }
            }
            
            showLoginModal();
        }

        // 로그인 모달 표시/숨김
        function showLoginModal() {
            loginModal.classList.remove('hidden');
            loginUserId.focus();
        }

        function hideLoginModal() {
            loginModal.classList.add('hidden');
        }

        // 폼 전환
        function showSignupForm() {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            signupUserId.focus();
        }

        function showLoginForm() {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            loginUserId.focus();
        }

        // 간단한 해시 함수
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // 로그인 처리
        async function handleLogin() {
            const userIdValue = loginUserId.value.trim();
            const passwordValue = loginPassword.value.trim();
            
            if (!userIdValue || !passwordValue) {
                authStatus.textContent = '사용자 ID와 비밀번호를 모두 입력해주세요.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
                return;
            }
            
            try {
                authStatus.textContent = '로그인 중...';
                authStatus.className = 'mt-4 text-sm text-center text-blue-600';
                
                const passwordHash = simpleHash(passwordValue);
                
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('user_id', userIdValue)
                    .eq('password_hash', passwordHash)
                    .single();

                if (error || !userData) {
                    authStatus.textContent = '사용자 ID 또는 비밀번호가 올바르지 않습니다.';
                    authStatus.className = 'mt-4 text-sm text-center text-red-600';
                    return;
                }
                
                currentUser = userData;
                userId = userData.user_id;
                userName.textContent = userData.name;
                userInfo.classList.remove('hidden');
                
                localStorage.setItem('userAuth', JSON.stringify({
                    userId: userData.user_id,
                    passwordHash: passwordHash,
                    name: userData.name
                }));
                
                authStatus.textContent = `환영합니다, ${userData.name}님!`;
                authStatus.className = 'mt-4 text-sm text-center text-green-600';
                
                setTimeout(async () => {
                    hideLoginModal();
                    await loadData();
                    updateTodayDeadlines();
                    startRecurringCheck();
                    showSuccess(`${userData.name}님, 로그인되었습니다!`);
                }, 1000);
                
            } catch (error) {
                console.error('로그인 오류:', error);
                authStatus.textContent = '로그인 중 오류가 발생했습니다.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
            }
        }

        // 회원가입 처리
        async function handleSignup() {
            const userIdValue = signupUserId.value.trim();
            const passwordValue = signupPassword.value.trim();
            const nameValue = signupName.value.trim();
            
            if (!userIdValue || !passwordValue || !nameValue) {
                authStatus.textContent = '모든 필드를 입력해주세요.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
                return;
            }
            
            if (userIdValue.length < 3) {
                authStatus.textContent = '사용자 ID는 3자 이상이어야 합니다.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
                return;
            }
            
            if (passwordValue.length < 4) {
                authStatus.textContent = '비밀번호는 4자 이상이어야 합니다.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
                return;
            }
            
            try {
                authStatus.textContent = '회원가입 중...';
                authStatus.className = 'mt-4 text-sm text-center text-blue-600';
                
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('user_id')
                    .eq('user_id', userIdValue)
                    .single();

                if (existingUser) {
                    authStatus.textContent = '이미 사용 중인 사용자 ID입니다.';
                    authStatus.className = 'mt-4 text-sm text-center text-red-600';
                    return;
                }
                
                const passwordHash = simpleHash(passwordValue);
                
                const { data: newUser, error } = await supabase
                    .from('users')
                    .insert([{
                        user_id: userIdValue,
                        password_hash: passwordHash,
                        name: nameValue,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();

                if (error) {
                    throw error;
                }
                
                authStatus.textContent = '회원가입이 완료되었습니다! 로그인해주세요.';
                authStatus.className = 'mt-4 text-sm text-center text-green-600';
                
                setTimeout(() => {
                    signupUserId.value = '';
                    signupPassword.value = '';
                    signupName.value = '';
                    loginUserId.value = userIdValue;
                    showLoginForm();
                    authStatus.textContent = '';
                }, 2000);
                
            } catch (error) {
                console.error('회원가입 오류:', error);
                authStatus.textContent = '회원가입 중 오류가 발생했습니다.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
            }
        }

        // 로그아웃
        function logout() {
            if (confirm('정말 로그아웃하시겠습니까?')) {
                localStorage.removeItem('userAuth');
                currentUser = null;
                userId = null;
                buckets = [];
                recurringRules = [];
                userInfo.classList.add('hidden');
                showLoginModal();
                
                loginUserId.value = '';
                loginPassword.value = '';
                authStatus.textContent = '';
            }
        }

        // 로딩 표시/숨김
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        // 에러 표시
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg';
            errorDiv.innerHTML = `
                <h3 class="font-semibold mb-2">⚠️ 오류 발생</h3>
                <p class="text-sm">${message}</p>
                <button onclick="location.reload()" class="mt-2 px-3 py-1 bg-red-600 text-white rounded text-xs">새로고침</button>
            `;
            document.getElementById('app').insertBefore(errorDiv, document.getElementById('app').firstChild);
        }

        // 성공 알림
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // 데이터 로드
        async function loadData() {
            try {
                console.log('Supabase에서 데이터 로드 시작');
                showLoading();
                
                const { data: bucketsData, error: bucketsError } = await supabase
                    .from('buckets')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                if (bucketsError) {
                    throw new Error(`버킷 로드 오류: ${bucketsError.message}`);
                }

                let actionsData = [];
                if (bucketsData.length > 0) {
                    const { data: actions, error: actionsError } = await supabase
                        .from('actions')
                        .select('*')
                        .in('bucket_id', bucketsData.map(b => b.id))
                        .order('order_index', { ascending: true });

                    if (actionsError) {
                        throw new Error(`액션 로드 오류: ${actionsError.message}`);
                    }
                    actionsData = actions;
                }

                const { data: rulesData, error: rulesError } = await supabase
                    .from('recurring_rules')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                if (rulesError) {
                    console.error('반복 규칙 로드 오류:', rulesError);
                } else {
                    recurringRules = rulesData;
                }

                buckets = bucketsData.map(bucket => ({
                    ...bucket,
                    actions: actionsData.filter(action => action.bucket_id === bucket.id)
                }));

                console.log('로드된 버킷 수:', buckets.length);
                console.log('로드된 반복 규칙 수:', recurringRules.length);
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                } else if (currentView === 'todo') {
                    renderTodoView();
                } else if (currentView === 'recurring') {
                    renderRecurringView();
                }

                hideLoading();
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                hideLoading();
                showError('데이터를 불러오는 중 오류가 발생했습니다: ' + error.message);
                buckets = [];
                renderBuckets();
            }
        }

        // 뷰 전환
        function switchView(view) {
            currentView = view;
            
            bucketsViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            stageViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            todoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            recurringViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            memoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            
            addBucketSection.classList.add('hidden');
            todoView.classList.add('hidden');
            memoView.classList.add('hidden');
            bucketsView.classList.add('hidden');
            stageView.classList.add('hidden');
            recurringView.classList.add('hidden');
            
            if (view === 'buckets') {
                bucketsViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                addBucketSection.classList.remove('hidden');
                bucketsView.classList.remove('hidden');
                renderBuckets();
            } else if (view === 'stage') {
                stageViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                stageView.classList.remove('hidden');
                renderStageView();
            } else if (view === 'todo') {
                todoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                todoView.classList.remove('hidden');
                renderTodoView();
                updateTodoBucketSelect();
            } else if (view === 'recurring') {
                recurringViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-purple-500 text-purple-600';
                recurringView.classList.remove('hidden');
                renderRecurringView();
                updateRuleBucketSelect();
            } else if (view === 'memo') {
                memoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                memoView.classList.remove('hidden');
                loadMemo();
            }
        }

        // 단계별 뷰 렌더링
        function renderStageView() {
            const stageMap = {
                '대기': [],
                '진행_광고제작': [],
                '진행_광고운영': [],
                '진행_매출정산': []
            };

            buckets.forEach(bucket => {
                const stage = bucket.stage || '대기';
                if (stageMap[stage]) {
                    stageMap[stage].push(bucket);
                }
            });

            renderStageColumn('대기', stageMap['대기'], waitingStage, waitingCount);
            renderStageColumn('진행_광고제작', stageMap['진행_광고제작'], creativeStage, creativeCount);
            renderStageColumn('진행_광고운영', stageMap['진행_광고운영'], operationStage, operationCount);
            renderStageColumn('진행_매출정산', stageMap['진행_매출정산'], settlementStage, settlementCount);
        }

        // 단계별 컬럼 렌더링
        function renderStageColumn(stage, stageBuckets, container, countElement) {
            countElement.textContent = stageBuckets.length;
            
            container.className = 'p-4 space-y-3 min-h-[400px] drop-zone';
            container.setAttribute('data-stage', stage);
            
            if (stageBuckets.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-8 pointer-events-none">해당 단계의 광고주가 없습니다.<br><span class="text-xs">다른 단계에서 드래그해서 이동하세요.</span></p>';
            } else {
                container.innerHTML = stageBuckets.map(bucket => {
                    const incompleteActions = (bucket.actions || []).filter(action => !action.completed).length;
                    const totalActions = (bucket.actions || []).length;
                    
                    return `
                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 hover:border-blue-300 transition-all cursor-move bucket-card"
                             draggable="true"
                             data-bucket-id="${bucket.id}"
                             data-current-stage="${stage}"
                             onclick="switchToBucketView(${bucket.id})">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-400 text-xs cursor-move">⋮⋮</span>
                                    <h4 class="font-medium text-gray-800 text-sm">${bucket.name}</h4>
                                </div>
                                <button onclick="event.stopPropagation(); changeStageInStageView(${bucket.id}, event)" 
                                        class="text-gray-400 hover:text-gray-600 text-xs">
                                    📝
                                </button>
                            </div>
                            
                            ${bucket.unit_price || bucket.quantity || bucket.product ? `
                                <div class="text-xs text-gray-500 mb-2">
                                    ${bucket.unit_price ? `${bucket.unit_price}원` : ''}
                                    ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                    ${bucket.quantity ? `${bucket.quantity}` : ''}
                                    ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                    ${bucket.product ? `${bucket.product}` : ''}
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-gray-600">
                                    액션: ${totalActions - incompleteActions}/${totalActions}
                                </span>
                                <div class="w-16 bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" 
                                         style="width: ${totalActions > 0 ? ((totalActions - incompleteActions) / totalActions * 100) : 0}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            setupDragAndDropEvents(container);
        }

        // 드래그 앤 드롭 이벤트 설정
        function setupDragAndDropEvents(container) {
            container.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('bucket-card')) {
                    e.target.style.opacity = '0.5';
                    e.dataTransfer.setData('text/plain', e.target.dataset.bucketId);
                    e.dataTransfer.setData('source-stage', e.target.dataset.currentStage);
                    
                    document.querySelectorAll('.drop-zone').forEach(zone => {
                        zone.classList.add('drag-active');
                    });
                }
            });

            container.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('bucket-card')) {
                    e.target.style.opacity = '1';
                    
                    document.querySelectorAll('.drop-zone').forEach(zone => {
                        zone.classList.remove('drag-active', 'drag-over');
                    });
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.classList.add('drag-over');
            });

            container.addEventListener('dragleave', (e) => {
                if (!container.contains(e.relatedTarget)) {
                    container.classList.remove('drag-over');
                }
            });

            container.addEventListener('drop', async (e) => {
                e.preventDefault();
                
                const bucketId = parseInt(e.dataTransfer.getData('text/plain'));
                const sourceStage = e.dataTransfer.getData('source-stage');
                const targetStage = container.dataset.stage;
                
                if (sourceStage === targetStage) {
                    container.classList.remove('drag-over');
                    return;
                }
                
                await moveToStage(bucketId, targetStage);
                
                container.classList.remove('drag-over');
            });
        }

        // 단계 이동 (액션아이템 자동 생성 제거)
        async function moveToStage(bucketId, newStage) {
            try {
                showLoading();
                
                const { error: bucketError } = await supabase
                    .from('buckets')
                    .update({ stage: newStage })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (bucketError) {
                    throw new Error(`단계 변경 오류: ${bucketError.message}`);
                }

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket.stage = newStage;
                }
                
                hideLoading();
                renderStageView();
                
                const stageNames = {
                    '대기': '대기',
                    '진행_광고제작': '광고제작',
                    '진행_광고운영': '광고운영',
                    '진행_매출정산': '매출정산'
                };
                
                showSuccess(`${bucket?.name || '광고주'}가 ${stageNames[newStage]} 단계로 이동되었습니다!`);
            } catch (error) {
                console.error('단계 변경 오류:', error);
                hideLoading();
                alert('오류가 발생했습니다: ' + error.message);
                renderStageView();
            }
        }

        async function updateStageFromSelect(bucketId, newStage) {
            await moveToStage(bucketId, newStage);
        }

        function switchToBucketView(bucketId) {
            switchView('buckets');
        }

        function changeStageInStageView(bucketId, event) {
            event.stopPropagation();
            
            const stages = [
                { value: '대기', text: '⏳ 대기' },
                { value: '진행_광고제작', text: '🎨 광고제작' },
                { value: '진행_광고운영', text: '📈 광고운영' },
                { value: '진행_매출정산', text: '💰 매출정산' }
            ];
            
            const currentBucket = buckets.find(b => b.id === bucketId);
            const currentStage = currentBucket?.stage || '대기';
            
            const stageOptions = stages.map(stage => 
                `<option value="${stage.value}" ${stage.value === currentStage ? 'selected' : ''}>${stage.text}</option>`
            ).join('');
            
            const selectHtml = `
                <select onchange="updateStageFromSelect(${bucketId}, this.value)" 
                        class="text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    ${stageOptions}
                </select>
            `;
            
            event.target.closest('.bg-gray-50').innerHTML += selectHtml;
        }

        // 정렬 토글
        function toggleSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            sortText.textContent = `마감일 ${sortOrder === 'asc' ? '오름차순' : '내림차순'}`;
            if (currentView === 'buckets') {
                renderBuckets();
            }
        }

        function toggleTodoSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            todoSortText.textContent = `마감일 ${sortOrder === 'asc' ? '오름차순' : '내림차순'}`;
            if (currentView === 'todo') {
                renderTodoView();
            }
        }

        // 완료된 투두 가시성 토글
        function toggleCompletedVisibility() {
            showCompletedTodos = !showCompletedTodos;
            
            if (showCompletedTodos) {
                toggleCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm';
                toggleCompletedText.textContent = '완료항목 숨기기';
            } else {
                toggleCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm';
                toggleCompletedText.textContent = '완료항목 보기';
            }
            
            if (currentView === 'todo') {
                renderTodoView();
            }
        }

        function toggleBucketCompletedVisibility() {
            showCompletedInBuckets = !showCompletedInBuckets;
            
            if (showCompletedInBuckets) {
                toggleBucketCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm';
                toggleBucketCompletedText.textContent = '완료항목 숨기기';
            } else {
                toggleBucketCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm';
                toggleBucketCompletedText.textContent = '완료항목 보기';
            }
            
            if (currentView === 'buckets') {
                renderBuckets();
            }
        }

        // 오늘 마감 업데이트
        function updateTodayDeadlines() {
            const today = new Date().toISOString().split('T')[0];
            const todayItems = [];
            
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    if (action.deadline === today && !action.completed) {
                        todayItems.push({
                            bucketName: bucket.name,
                            actionText: action.text
                        });
                    }
                });
            });

            if (todayItems.length > 0) {
                todayDeadlinesList.innerHTML = todayItems.map(item => 
                    `<p class="text-red-600 text-sm">• [${item.bucketName}] ${item.actionText}</p>`
                ).join('');
                todayDeadlines.classList.remove('hidden');
            } else {
                todayDeadlines.classList.add('hidden');
            }
        }

        // 추가 폼 관련
        function showAddForm() {
            addBucketForm.classList.remove('hidden');
            bucketNameInput.focus();
        }

        function hideAddForm() {
            addBucketForm.classList.add('hidden');
            bucketNameInput.value = '';
            unitPriceInput.value = '';
            quantityInput.value = '';
            productInput.value = '';
            contractTermsInput.value = '';
        }

        // 새 버킷 추가 (액션아이템 자동 생성 제거)
        async function addBucket() {
            const name = bucketNameInput.value.trim();
            if (!name) {
                alert('광고주명은 필수입니다.');
                return;
            }

            try {
                showLoading();

                const bucketData = {
                    user_id: userId,
                    name: name,
                    stage: '대기',
                    unit_price: unitPriceInput.value.trim(),
                    quantity: quantityInput.value.trim(),
                    product: productInput.value.trim(),
                    contract_terms: contractTermsInput.value.trim()
                };

                const { data: newBucket, error: bucketError } = await supabase
                    .from('buckets')
                    .insert([bucketData])
                    .select()
                    .single();

                if (bucketError) {
                    throw new Error(`버킷 생성 오류: ${bucketError.message}`);
                }

                newBucket.actions = [];
                buckets.unshift(newBucket);
                
                hideLoading();
                hideAddForm();
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                }
                
                updateTodayDeadlines();
                showSuccess('새 광고주가 추가되었습니다!');
                
            } catch (error) {
                console.error('버킷 추가 오류:', error);
                hideLoading();
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        // 액션 아이템 정렬
        function getSortedActions(actions) {
            const incompleteActions = actions.filter(action => !action.completed);
            const completedActions = actions.filter(action => action.completed);
            
            const sortedIncomplete = incompleteActions.sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return sortOrder === 'asc' ? 1 : -1;
                if (!b.deadline) return sortOrder === 'asc' ? -1 : 1;
                
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            const sortedCompleted = completedActions.sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return sortOrder === 'asc' ? 1 : -1;
                if (!b.deadline) return sortOrder === 'asc' ? -1 : 1;
                
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            return [...sortedIncomplete, ...sortedCompleted];
        }

        // 투두뷰 렌더링
        function renderTodoView() {
            const allItems = [];
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    allItems.push({
                        ...action,
                        bucketName: bucket.name,
                        bucketId: bucket.id,
                        bucketStage: bucket.stage
                    });
                });
            });

            let filteredItems = allItems;
            if (!showCompletedTodos) {
                filteredItems = allItems.filter(item => !item.completed);
            }

            const sortedItems = getSortedActions(filteredItems);

            if (sortedItems.length === 0) {
                todoList.classList.add('hidden');
                todoEmpty.classList.remove('hidden');
                return;
            }

            todoList.classList.remove('hidden');
            todoEmpty.classList.add('hidden');

            todoList.innerHTML = sortedItems.map(action => {
                const today = new Date().toISOString().split('T')[0];
                const isToday = action.deadline === today && !action.completed;
                const isRecurring = action.recurring_rule_id ? '🔄 ' : '';
                
                return `
                    <div class="flex items-center justify-between p-3 rounded-lg border ${action.completed ? 'bg-gray-50 border-gray-200' : 'bg-white border-gray-200'}">
                        <div class="flex items-center gap-3 flex-1">
                            <button onclick="toggleActionItem(${action.bucketId}, ${action.id})" class="flex-shrink-0 text-lg">
                                ${action.completed ? '✅' : '⭕'}
                            </button>
                            <div class="flex-1">
                                <p class="text-sm font-medium ${action.completed ? 'line-through text-gray-500' : 'text-gray-800'}">
                                    ${isRecurring}${action.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                                </p>
                                <p class="text-xs ${action.completed ? 'text-gray-400' : 'text-gray-500'}">
                                    [${action.bucketName}] - ${action.bucketStage}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="date" value="${action.deadline || ''}" onchange="setDeadline(${action.bucketId}, ${action.id}, this.value)" class="px-2 py-1 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${isToday ? 'border-red-500 bg-red-50' : 'border-gray-200'} ${action.completed ? 'text-gray-400' : ''}"/>
                            <button onclick="deleteActionItem(${action.bucketId}, ${action.id})" class="text-red-500 hover:text-red-700">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 버킷 목록 렌더링
        function renderBuckets() {
            if (buckets.length === 0) {
                emptyState.classList.remove('hidden');
                bucketsContainer.innerHTML = '';
                return;
            }

            emptyState.classList.add('hidden');
            bucketsContainer.innerHTML = '';

            buckets.forEach(bucket => {
                const bucketElement = createBucketElement(bucket);
                bucketsContainer.appendChild(bucketElement);
            });
        }

        // 버킷 요소 생성
        function createBucketElement(bucket) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-md p-4';

            const actions = bucket.actions || [];
            const sortedActions = getSortedActions(actions);
            const isCollapsed = collapsedBuckets[bucket.id] === true;
            const isContractCollapsed = collapsedContracts[bucket.id] === true;

            div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <button onclick="toggleBucketCollapse(${bucket.id})" class="text-gray-600 hover:text-gray-800">
                                ${isCollapsed ? '▶' : '▼'}
                            </button>
                            ${editingBucket === bucket.id ? `
                                <input type="text" value="${bucket.name.replace(/"/g, '&quot;')}" 
                                       onkeypress="if(event.key==='Enter') saveEditBucket(${bucket.id}, this.value); if(event.key==='Escape') cancelEditBucket();"
                                       onblur="saveEditBucket(${bucket.id}, this.value)"
                                       class="flex-1 px-2 py-1 text-sm font-semibold border border-blue-500 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                       autofocus />
                                <button onclick="cancelEditBucket()" class="text-red-500 hover:text-red-700 text-sm">✕</button>
                            ` : `
                                <h3 class="text-sm font-semibold text-gray-800 flex-1">${bucket.name}</h3>
                                <button onclick="startEditBucket(${bucket.id})" class="text-gray-400 hover:text-gray-600 text-sm">✏️</button>
                            `}
                        </div>
                    </div>
                    <button onclick="deleteBucket(${bucket.id})" class="text-red-500 hover:text-red-700 text-sm">
                        🗑️
                    </button>
                </div>

                ${!isCollapsed ? `
                    <!-- 단계 선택 -->
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-700 mb-1">단계</label>
                        <select onchange="changeStage(${bucket.id}, this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="대기" ${bucket.stage === '대기' ? 'selected' : ''}>대기</option>
                            <option value="진행_광고제작" ${bucket.stage === '진행_광고제작' ? 'selected' : ''}>진행_광고제작</option>
                            <option value="진행_광고운영" ${bucket.stage === '진행_광고운영' ? 'selected' : ''}>진행_광고운영</option>
                            <option value="진행_매출정산" ${bucket.stage === '진행_매출정산' ? 'selected' : ''}>진행_매출정산</option>
                        </select>
                    </div>

                    <!-- 계약 정보 -->
                    <div class="mb-3 p-3 bg-gray-50 rounded">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs font-medium text-gray-700">계약 정보</h4>
                            <button onclick="toggleContractCollapse(${bucket.id})" class="text-gray-600 hover:text-gray-800">
                                ${isContractCollapsed ? '▶' : '▼'}
                            </button>
                        </div>
                        
                        ${!isContractCollapsed ? `
                            <div class="grid grid-cols-1 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">단가 (원)</label>
                                    <input type="text" value="${bucket.unit_price || ''}" onchange="updateBucketInfo(${bucket.id}, 'unit_price', this.value)" placeholder="예: 1,000,000" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"/>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">수량</label>
                                    <input type="text" value="${bucket.quantity || ''}" onchange="updateBucketInfo(${bucket.id}, 'quantity', this.value)" placeholder="예: 100회 노출" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"/>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">상품</label>
                                    <select onchange="updateBucketInfo(${bucket.id}, 'product', this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">선택</option>
                                        <option value="CPM" ${bucket.product === 'CPM' ? 'selected' : ''}>CPM</option>
                                        <option value="CPA" ${bucket.product === 'CPA' ? 'selected' : ''}>CPA</option>
                                        <option value="CPA+" ${bucket.product === 'CPA+' ? 'selected' : ''}>CPA+</option>
                                        <option value="CPR" ${bucket.product === 'CPR' ? 'selected' : ''}>CPR</option>
                                        <option value="CPR+" ${bucket.product === 'CPR+' ? 'selected' : ''}>CPR+</option>
                                        <option value="CPS" ${bucket.product === 'CPS' ? 'selected' : ''}>CPS</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">계약조건</label>
                                    <textarea onchange="updateBucketInfo(${bucket.id}, 'contract_terms', this.value)" placeholder="계약 조건..." rows="2" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none">${bucket.contract_terms || ''}</textarea>
                                </div>
                            </div>
                        ` : `
                            ${(bucket.unit_price || bucket.quantity || bucket.product) ? `
                                <div class="text-xs text-gray-500">
                                    ${bucket.unit_price ? `${bucket.unit_price}원` : ''}
                                    ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                    ${bucket.quantity ? `${bucket.quantity}` : ''}
                                    ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                    ${bucket.product ? `${bucket.product}` : ''}
                                </div>
                            ` : ''}
                        `}
                    </div>

                    <!-- 액션 아이템 -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xs font-medium text-gray-700">액션 아이템</h4>
                            <button onclick="addCustomAction(${bucket.id})" class="text-blue-600 hover:text-blue-800 text-xs">
                                ➕
                            </button>
                        </div>
                        
                        ${sortedActions.length === 0 ? `
                            <p class="text-gray-400 text-xs text-center py-4">액션아이템이 없습니다.<br>➕ 버튼을 눌러 추가해보세요.</p>
                        ` : sortedActions.map(action => {
                            if (!showCompletedInBuckets && action.completed) {
                                return '';
                            }
                            
                            const today = new Date().toISOString().split('T')[0];
                            const isToday = action.deadline === today && !action.completed;
                            const isRecurring = action.recurring_rule_id ? '🔄 ' : '';
                            
                            return `
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleActionItem(${bucket.id}, ${action.id})" class="flex-shrink-0 ${action.completed ? 'text-green-600' : 'text-gray-400'}">
                                            ${action.completed ? '✅' : '⭕'}
                                        </button>
                                        ${editingAction === action.id ? `
                                            <input type="text" value="${action.text.replace(/"/g, '&quot;')}" 
                                                   onkeypress="if(event.key==='Enter') saveEditAction(${action.id}, this.value); if(event.key==='Escape') cancelEditAction();"
                                                   onblur="saveEditAction(${action.id}, this.value)"
                                                   class="flex-1 px-1 py-0.5 text-xs border border-blue-500 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                   autofocus />
                                            <button onclick="cancelEditAction()" class="text-red-500 hover:text-red-700 text-xs">✕</button>
                                        ` : `
                                            <span class="flex-1 text-xs ${action.completed ? 'line-through text-gray-500' : 'text-gray-700'} cursor-pointer" 
                                                  onclick="startEditAction(${action.id})">
                                                ${isRecurring}${action.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                                            </span>
                                            <button onclick="deleteActionItem(${bucket.id}, ${action.id})" class="text-red-500 hover:text-red-700 text-xs">
                                                ❌
                                            </button>
                                        `}
                                    </div>
                                    ${editingAction !== action.id ? `
                                        <input type="date" value="${action.deadline || ''}" onchange="setDeadline(${bucket.id}, ${action.id}, this.value)" class="ml-5 px-1 py-0.5 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${isToday ? 'border-red-500 bg-red-50' : 'border-gray-200'}" />
                                    ` : ''}
                                </div>
                            `;
                        }).filter(html => html !== '').join('')}
                    </div>
                ` : `
                    <!-- 접혀있을 때 요약 정보 -->
                    <div class="mt-1">
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>${bucket.stage}</span>
                        </div>
                        ${(bucket.unit_price || bucket.quantity || bucket.product) ? `
                            <div class="text-xs text-gray-500 mt-1">
                                ${bucket.unit_price ? `${bucket.unit_price}원` : ''}
                                ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                ${bucket.quantity ? `${bucket.quantity}` : ''}
                                ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                ${bucket.product ? `${bucket.product}` : ''}
                            </div>
                        ` : ''}
                    </div>
                `}
            `;

            return div;
        }

        // 버킷 관련 함수들
        function toggleBucketCollapse(bucketId) {
            collapsedBuckets[bucketId] = !collapsedBuckets[bucketId];
            renderBuckets();
        }

        function toggleContractCollapse(bucketId) {
            collapsedContracts[bucketId] = !collapsedContracts[bucketId];
            renderBuckets();
        }

        function startEditBucket(bucketId) {
            editingBucket = bucketId;
            renderBuckets();
        }

        async function saveEditBucket(bucketId, newName) {
            if (!newName.trim()) return;
            
            try {
                const { error } = await supabase
                    .from('buckets')
                    .update({ name: newName.trim() })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`버킷 이름 수정 오류: ${error.message}`);
                }

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket.name = newName.trim();
                }
                
                editingBucket = null;
                renderBuckets();
                showSuccess('광고주명이 수정되었습니다!');
            } catch (error) {
                console.error('버킷 이름 수정 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        function cancelEditBucket() {
            editingBucket = null;
            renderBuckets();
        }

        function startEditAction(actionId) {
            editingAction = actionId;
            renderBuckets();
        }

        async function saveEditAction(actionId, newText) {
            if (!newText.trim()) return;
            
            try {
                const { error } = await supabase
                    .from('actions')
                    .update({ text: newText.trim() })
                    .eq('id', actionId);

                if (error) {
                    throw new Error(`액션 아이템 수정 오류: ${error.message}`);
                }

                buckets.forEach(bucket => {
                    const action = bucket.actions?.find(a => a.id === actionId);
                    if (action) {
                        action.text = newText.trim();
                    }
                });
                
                editingAction = null;
                renderBuckets();
                showSuccess('액션아이템이 수정되었습니다!');
            } catch (error) {
                console.error('액션 아이템 수정 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        function cancelEditAction() {
            editingAction = null;
            renderBuckets();
        }

        async function updateBucketInfo(bucketId, field, value) {
            try {
                const { error } = await supabase
                    .from('buckets')
                    .update({ [field]: value })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`버킷 정보 수정 오류: ${error.message}`);
                }

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket[field] = value;
                }
            } catch (error) {
                console.error('버킷 정보 수정 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        async function changeStage(bucketId, newStage) {
            await moveToStage(bucketId, newStage);
            renderBuckets();
        }

        async function addCustomAction(bucketId) {
            const text = prompt('새 액션아이템을 입력하세요:');
            if (!text || !text.trim()) return;

            try {
                const bucket = buckets.find(b => b.id === bucketId);
                if (!bucket) return;

                // 오늘 날짜 자동 설정
                const today = new Date().toISOString().split('T')[0];

                const { data: newAction, error } = await supabase
                    .from('actions')
                    .insert([{
                        bucket_id: bucketId,
                        text: text.trim(),
                        completed: false,
                        deadline: today,  // 오늘 날짜 자동 설정
                        order_index: bucket.actions.length
                    }])
                    .select()
                    .single();

                if (error) {
                    throw new Error(`액션 아이템 추가 오류: ${error.message}`);
                }

                bucket.actions.push(newAction);
                
                renderBuckets();
                updateTodayDeadlines();
                showSuccess('액션아이템이 추가되었습니다!');
            } catch (error) {
                console.error('액션 아이템 추가 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        async function toggleActionItem(bucketId, actionId) {
            try {
                const bucket = buckets.find(b => b.id === bucketId);
                const action = bucket?.actions?.find(a => a.id === actionId);
                
                if (!action) return;

                const newCompleted = !action.completed;

                const { error } = await supabase
                    .from('actions')
                    .update({ completed: newCompleted })
                    .eq('id', actionId);

                if (error) {
                    throw new Error(`액션 아이템 상태 변경 오류: ${error.message}`);
                }

                action.completed = newCompleted;
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                } else {
                    renderTodoView();
                }
                updateTodayDeadlines();
            } catch (error) {
                console.error('액션 아이템 상태 변경 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        async function setDeadline(bucketId, actionId, deadline) {
            try {
                const bucket = buckets.find(b => b.id === bucketId);
                const action = bucket?.actions?.find(a => a.id === actionId);
                
                if (!action) return;

                const { error } = await supabase
                    .from('actions')
                    .update({ deadline: deadline || null })
                    .eq('id', actionId);

                if (error) {
                    throw new Error(`마감일 설정 오류: ${error.message}`);
                }

                action.deadline = deadline || null;
                
                updateTodayDeadlines();
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                } else {
                    renderTodoView();
                }
            } catch (error) {
                console.error('마감일 설정 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        async function deleteActionItem(bucketId, actionId) {
            if (!confirm('이 액션아이템을 삭제하시겠습니까?')) return;

            try {
                const { error } = await supabase
                    .from('actions')
                    .delete()
                    .eq('id', actionId);

                if (error) {
                    throw new Error(`액션 아이템 삭제 오류: ${error.message}`);
                }

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket && bucket.actions) {
                    bucket.actions = bucket.actions.filter(a => a.id !== actionId);
                }
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                } else {
                    renderTodoView();
                }
                updateTodayDeadlines();
                showSuccess('액션아이템이 삭제되었습니다!');
            } catch (error) {
                console.error('액션 아이템 삭제 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        async function deleteBucket(bucketId) {
            if (!confirm('정말로 이 프로젝트를 삭제하시겠습니까?\n모든 액션아이템도 함께 삭제됩니다.')) return;

            try {
                const { error } = await supabase
                    .from('buckets')
                    .delete()
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`버킷 삭제 오류: ${error.message}`);
                }

                buckets = buckets.filter(b => b.id !== bucketId);
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                }
                updateTodayDeadlines();
                showSuccess('광고주가 삭제되었습니다!');
            } catch (error) {
                console.error('버킷 삭제 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        // 투두리스트 관련 함수들
        function showAddTodoForm() {
            addTodoForm.classList.remove('hidden');
            updateTodoBucketSelect();
            // 오늘 날짜 자동 설정
            const today = new Date().toISOString().split('T')[0];
            todoDeadlineInput.value = today;
            todoTextInput.focus();
        }

        function hideAddTodoForm() {
            addTodoForm.classList.add('hidden');
            todoBucketSelect.value = '';
            todoDeadlineInput.value = '';
            todoTextInput.value = '';
        }

        function updateTodoBucketSelect() {
            todoBucketSelect.innerHTML = '<option value="">광고주를 선택하세요</option>';
            buckets.forEach(bucket => {
                const option = document.createElement('option');
                option.value = bucket.id;
                option.textContent = bucket.name;
                todoBucketSelect.appendChild(option);
            });
        }

        async function addTodoItem() {
            const bucketId = parseInt(todoBucketSelect.value);
            const text = todoTextInput.value.trim();
            const deadline = todoDeadlineInput.value || null;

            if (!bucketId) {
                alert('광고주를 선택해주세요.');
                return;
            }

            if (!text) {
                alert('액션아이템 내용을 입력해주세요.');
                return;
            }

            try {
                const bucket = buckets.find(b => b.id === bucketId);
                if (!bucket) return;

                const { data: newAction, error } = await supabase
                    .from('actions')
                    .insert([{
                        bucket_id: bucketId,
                        text: text,
                        completed: false,
                        deadline: deadline,
                        order_index: bucket.actions.length
                    }])
                    .select()
                    .single();

                if (error) {
                    throw new Error(`액션 아이템 추가 오류: ${error.message}`);
                }

                bucket.actions.push(newAction);
                
                hideAddTodoForm();
                renderTodoView();
                updateTodayDeadlines();
                showSuccess('액션아이템이 추가되었습니다!');
            } catch (error) {
                console.error('액션 아이템 추가 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        // 반복 규칙 관련 함수들 (이어서...)
        function showAddRecurringForm() {
            addRecurringForm.classList.remove('hidden');
            updateRuleBucketSelect();
            ruleNameInput.focus();
            editingRule = null;
        }

        function hideAddRecurringForm() {
            addRecurringForm.classList.add('hidden');
            editingRule = null;
            ruleNameInput.value = '';
            ruleBucketSelect.value = '';
            ruleActionInput.value = '';
            repeatTypeSelect.value = 'daily';
            weeklyDaySelect.value = '1';
            monthlyDateSelect.value = '1';
            createTimeInput.value = '09:00';
            deadlineTypeSelect.value = 'none';
            deadlineDaysInput.value = '1';
            startDateInput.value = new Date().toISOString().split('T')[0];
            endDateInput.value = '';
            ruleStatusSelect.value = 'active';
            weeklyDayContainer.classList.add('hidden');
            monthlyDateContainer.classList.add('hidden');
            deadlineDaysContainer.classList.add('hidden');
        }

        function updateRuleBucketSelect() {
            ruleBucketSelect.innerHTML = '<option value="">광고주를 선택하세요</option>';
            buckets.forEach(bucket => {
                const option = document.createElement('option');
                option.value = bucket.id;
                option.textContent = bucket.name;
                ruleBucketSelect.appendChild(option);
            });
        }

        async function addRecurringRule() {
            const ruleName = ruleNameInput.value.trim();
            const bucketId = parseInt(ruleBucketSelect.value);
            const actionText = ruleActionInput.value.trim();
            const repeatType = repeatTypeSelect.value;
            const createTime = createTimeInput.value;
            const deadlineType = deadlineTypeSelect.value;
            const deadlineDays = parseInt(deadlineDaysInput.value) || 1;
            const startDate = startDateInput.value;
            const endDate = endDateInput.value || null;
            const status = ruleStatusSelect.value;

            if (!ruleName || !bucketId || !actionText || !startDate) {
                alert('필수 항목을 모두 입력해주세요.');
                return;
            }

            try {
                showLoading();

                let repeatConfig = { hour: parseInt(createTime.split(':')[0]), minute: parseInt(createTime.split(':')[1]) };
                
                if (repeatType === 'weekly') {
                    repeatConfig.day_of_week = parseInt(weeklyDaySelect.value);
                } else if (repeatType === 'monthly') {
                    repeatConfig.date = parseInt(monthlyDateSelect.value);
                }

                const ruleData = {
                    user_id: userId,
                    rule_name: ruleName,
                    bucket_id: bucketId,
                    action_template: actionText,
                    repeat_type: repeatType,
                    repeat_config: repeatConfig,
                    deadline_type: deadlineType,
                    deadline_days: deadlineDays,
                    start_date: startDate,
                    end_date: endDate,
                    is_active: status === 'active',
                    last_generated: null
                };

                if (editingRule) {
                    const { error } = await supabase
                        .from('recurring_rules')
                        .update(ruleData)
                        .eq('id', editingRule)
                        .eq('user_id', userId);

                    if (error) {
                        throw new Error(`반복 규칙 수정 오류: ${error.message}`);
                    }

                    const ruleIndex = recurringRules.findIndex(r => r.id === editingRule);
                    if (ruleIndex !== -1) {
                        recurringRules[ruleIndex] = { ...recurringRules[ruleIndex], ...ruleData };
                    }

                    showSuccess('반복 규칙이 수정되었습니다!');
                } else {
                    const { data: newRule, error } = await supabase
                        .from('recurring_rules')
                        .insert([ruleData])
                        .select()
                        .single();

                    if (error) {
                        throw new Error(`반복 규칙 생성 오류: ${error.message}`);
                    }

                    recurringRules.unshift(newRule);
                    showSuccess('반복 규칙이 생성되었습니다!');
                }

                hideLoading();
                hideAddRecurringForm();
                renderRecurringView();

            } catch (error) {
                console.error('반복 규칙 처리 오류:', error);
                hideLoading();
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        function renderRecurringView() {
            if (recurringRules.length === 0) {
                recurringRulesList.innerHTML = '';
                recurringEmpty.classList.remove('hidden');
                return;
            }

            recurringEmpty.classList.add('hidden');
            
            recurringRulesList.innerHTML = recurringRules.map(rule => {
                const bucket = buckets.find(b => b.id === rule.bucket_id);
                const bucketName = bucket ? bucket.name : '삭제된 광고주';
                
                const getRepeatText = () => {
                    const config = rule.repeat_config || {};
                    const time = `${config.hour || 9}:${String(config.minute || 0).padStart(2, '0')}`;
                    
                    if (rule.repeat_type === 'daily') {
                        return `매일 ${time}`;
                    } else if (rule.repeat_type === 'weekly') {
                        const days = ['일', '월', '화', '수', '목', '금', '토'];
                        const dayName = days[config.day_of_week || 1];
                        return `매주 ${dayName}요일 ${time}`;
                    } else if (rule.repeat_type === 'monthly') {
                        return `매월 ${config.date || 1}일 ${time}`;
                    }
                    return '설정 오류';
                };

                const getDeadlineText = () => {
                    switch(rule.deadline_type) {
                        case 'same_day': return '당일 마감';
                        case 'next_day': return '다음날 마감';
                        case 'days_after': return `${rule.deadline_days}일 후 마감`;
                        default: return '마감일 없음';
                    }
                };

                return `
                    <div class="p-4 border border-gray-200 rounded-lg ${rule.is_active ? 'bg-white' : 'bg-gray-50'}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800 flex items-center gap-2">
                                    🔄 ${rule.rule_name}
                                    <span class="px-2 py-1 text-xs rounded ${rule.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                                        ${rule.is_active ? '활성' : '비활성'}
                                    </span>
                                </h4>
                                <p class="text-sm text-gray-600 mt-1">[${bucketName}] ${rule.action_template}</p>
                                <div class="text-xs text-blue-600 mt-1">
                                    <span>${getRepeatText()}</span> · <span>${getDeadlineText()}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editRecurringRule(${rule.id})" class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                    수정
                                </button>
                                <button onclick="toggleRecurringRule(${rule.id})" class="px-2 py-1 text-xs rounded ${rule.is_active ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}">
                                    ${rule.is_active ? '일시정지' : '활성화'}
                                </button>
                                <button onclick="deleteRecurringRule(${rule.id})" class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">
                                    삭제
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            <p>기간: ${rule.start_date} ${rule.end_date ? `~ ${rule.end_date}` : '~ 무제한'}</p>
                            <p>마지막 생성: ${rule.last_generated || '아직 생성된 항목 없음'}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function editRecurringRule(ruleId) {
            const rule = recurringRules.find(r => r.id === ruleId);
            if (!rule) return;

            editingRule = ruleId;
            
            addRecurringForm.classList.remove('hidden');
            updateRuleBucketSelect();
            
            ruleNameInput.value = rule.rule_name;
            ruleBucketSelect.value = rule.bucket_id;
            ruleActionInput.value = rule.action_template;
            repeatTypeSelect.value = rule.repeat_type;
            
            const config = rule.repeat_config || {};
            const time = `${String(config.hour || 9).padStart(2, '0')}:${String(config.minute || 0).padStart(2, '0')}`;
            createTimeInput.value = time;
            
            deadlineTypeSelect.value = rule.deadline_type || 'none';
            deadlineDaysInput.value = rule.deadline_days || 1;
            startDateInput.value = rule.start_date;
            endDateInput.value = rule.end_date || '';
            ruleStatusSelect.value = rule.is_active ? 'active' : 'inactive';
            
            weeklyDayContainer.classList.add('hidden');
            monthlyDateContainer.classList.add('hidden');
            
            if (rule.repeat_type === 'weekly') {
                weeklyDayContainer.classList.remove('hidden');
                weeklyDaySelect.value = config.day_of_week || 1;
            } else if (rule.repeat_type === 'monthly') {
                monthlyDateContainer.classList.remove('hidden');
                monthlyDateSelect.value = config.date || 1;
            }
            
            if (rule.deadline_type === 'days_after') {
                deadlineDaysContainer.classList.remove('hidden');
            }
            
            ruleNameInput.focus();
        }

        async function toggleRecurringRule(ruleId) {
            try {
                const rule = recurringRules.find(r => r.id === ruleId);
                if (!rule) return;

                const newStatus = !rule.is_active;

                const { error } = await supabase
                    .from('recurring_rules')
                    .update({ is_active: newStatus })
                    .eq('id', ruleId)
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`반복 규칙 상태 변경 오류: ${error.message}`);
                }

                rule.is_active = newStatus;
                renderRecurringView();
                
                showSuccess(`반복 규칙이 ${newStatus ? '활성화' : '일시정지'}되었습니다!`);
            } catch (error) {
                console.error('반복 규칙 상태 변경 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        async function deleteRecurringRule(ruleId) {
            if (!confirm('이 반복 규칙을 삭제하시겠습니까?')) return;

            try {
                const { error } = await supabase
                    .from('recurring_rules')
                    .delete()
                    .eq('id', ruleId)
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`반복 규칙 삭제 오류: ${error.message}`);
                }

                recurringRules = recurringRules.filter(r => r.id !== ruleId);
                renderRecurringView();
                
                showSuccess('반복 규칙이 삭제되었습니다!');
            } catch (error) {
                console.error('반복 규칙 삭제 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        // 반복 규칙 체크 및 실행
        function startRecurringCheck() {
            setInterval(checkRecurringRules, 60000);
            checkRecurringRules();
        }

        async function checkRecurringRules() {
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentTime = now.getHours() * 60 + now.getMinutes();

            for (const rule of recurringRules) {
                if (!rule.is_active) continue;
                
                if (rule.end_date && currentDate > rule.end_date) continue;
                
                if (currentDate < rule.start_date) continue;
                
                if (rule.last_generated === currentDate) continue;
                
                const config = rule.repeat_config || {};
                const ruleTime = (config.hour || 9) * 60 + (config.minute || 0);
                const timeDiff = Math.abs(currentTime - ruleTime);
                
                if (timeDiff > 1) continue;
                
                let shouldGenerate = false;
                
                if (rule.repeat_type === 'daily') {
                    shouldGenerate = true;
                } else if (rule.repeat_type === 'weekly') {
                    const targetDay = config.day_of_week || 1;
                    const currentDay = now.getDay();
                    shouldGenerate = targetDay === currentDay;
                } else if (rule.repeat_type === 'monthly') {
                    const targetDate = config.date || 1;
                    const currentDateNum = now.getDate();
                    shouldGenerate = targetDate === currentDateNum;
                }
                
                if (shouldGenerate) {
                    await generateRecurringAction(rule, currentDate);
                }
            }
        }

        async function generateRecurringAction(rule, currentDate) {
            try {
                const bucket = buckets.find(b => b.id === rule.bucket_id);
                if (!bucket) return;

                let deadline = null;
                const currentDateObj = new Date(currentDate);
                
                switch(rule.deadline_type) {
                    case 'same_day':
                        deadline = currentDate;
                        break;
                    case 'next_day':
                        currentDateObj.setDate(currentDateObj.getDate() + 1);
                        deadline = currentDateObj.toISOString().split('T')[0];
                        break;
                    case 'days_after':
                        currentDateObj.setDate(currentDateObj.getDate() + (rule.deadline_days || 1));
                        deadline = currentDateObj.toISOString().split('T')[0];
                        break;
                    default:
                        deadline = null;
                }

                const newAction = {
                    bucket_id: rule.bucket_id,
                    text: `${rule.action_template} (${currentDate})`,
                    completed: false,
                    deadline: deadline,
                    recurring_rule_id: rule.id,
                    order_index: bucket.actions.length
                };

                const { data: createdAction, error: actionError } = await supabase
                    .from('actions')
                    .insert([newAction])
                    .select()
                    .single();

                if (actionError) {
                    throw new Error(`반복 액션 생성 오류: ${actionError.message}`);
                }

                const { error: ruleError } = await supabase
                    .from('recurring_rules')
                    .update({ last_generated: currentDate })
                    .eq('id', rule.id);

                if (ruleError) {
                    console.error('반복 규칙 업데이트 오류:', ruleError);
                }

                bucket.actions.push(createdAction);
                rule.last_generated = currentDate;

                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                } else if (currentView === 'todo') {
                    renderTodoView();
                }

                updateTodayDeadlines();
                
                console.log(`반복 액션 생성됨: ${rule.rule_name} -> [${bucket.name}]`);
                showSuccess(`반복 작업이 생성되었습니다: ${rule.rule_name}`);

            } catch (error) {
                console.error('반복 액션 생성 오류:', error);
            }
        }

        // 엑셀 다운로드 기능
        function exportToExcel() {
            try {
                const allItems = [];
                buckets.forEach(bucket => {
                    (bucket.actions || []).forEach(action => {
                        allItems.push({
                            '광고주ID': bucket.id,
                            '광고주명': bucket.name,
                            '액션아이템': action.text,
                            '마감일자': action.deadline || '',
                            '완료여부': action.completed ? '완료' : '미완료',
                            '반복작업': action.recurring_rule_id ? '반복' : '일반'
                        });
                    });
                });

                if (allItems.length === 0) {
                    alert('다운로드할 데이터가 없습니다.');
                    return;
                }

                let filteredItems = allItems;
                if (currentView === 'todo' && !showCompletedTodos) {
                    filteredItems = allItems.filter(item => item.완료여부 === '미완료');
                } else if (currentView === 'buckets' && !showCompletedInBuckets) {
                    filteredItems = allItems.filter(item => item.완료여부 === '미완료');
                }

                const ws = XLSX.utils.json_to_sheet(filteredItems);

                const colWidths = [
                    { wch: 10 },
                    { wch: 20 },
                    { wch: 30 },
                    { wch: 12 },
                    { wch: 10 },
                    { wch: 10 }
                ];
                ws['!cols'] = colWidths;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '액션아이템 목록');

                const today = new Date();
                const dateString = today.getFullYear() + '-' + 
                    String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(today.getDate()).padStart(2, '0');
                const filename = `광고프로젝트_액션아이템_${dateString}.xlsx`;

                XLSX.writeFile(wb, filename);

                showSuccess('엑셀 파일이 다운로드되었습니다!');

            } catch (error) {
                console.error('엑셀 내보내기 오류:', error);
                alert('엑셀 파일 생성 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 메모장 기능
        async function loadMemo() {
            try {
                const { data: memoData, error } = await supabase
                    .from('memos')
                    .select('content')
                    .eq('user_id', userId)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw new Error(`메모 로드 오류: ${error.message}`);
                }

                if (memoData) {
                    memoTextarea.value = memoData.content || '';
                    memoStatus.textContent = '저장된 메모를 불러왔습니다.';
                } else {
                    memoTextarea.value = '';
                    memoStatus.textContent = '새로운 메모를 작성하세요.';
                }
            } catch (error) {
                console.error('메모 로드 오류:', error);
                memoTextarea.value = '';
                memoStatus.textContent = '메모 로드 중 오류가 발생했습니다.';
            }
        }

        async function saveMemo() {
            try {
                const memoContent = memoTextarea.value;
                
                const { error } = await supabase
                    .from('memos')
                    .upsert([{
                        user_id: userId,
                        content: memoContent,
                        updated_at: new Date().toISOString()
                    }], {
                        onConflict: 'user_id'
                    });

                if (error) {
                    throw new Error(`메모 저장 오류: ${error.message}`);
                }

                memoStatus.textContent = '메모가 저장되었습니다.';
                showSuccess('메모가 저장되었습니다!');
            } catch (error) {
                console.error('메모 저장 오류:', error);
                memoStatus.textContent = '메모 저장 중 오류가 발생했습니다.';
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        async function clearMemo() {
            if (!confirm('정말로 모든 메모를 삭제하시겠습니까?')) return;

            try {
                const { error } = await supabase
                    .from('memos')
                    .delete()
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`메모 삭제 오류: ${error.message}`);
                }

                memoTextarea.value = '';
                memoStatus.textContent = '메모가 삭제되었습니다.';
                showSuccess('메모가 삭제되었습니다!');
            } catch (error) {
                console.error('메모 삭제 오류:', error);
                memoStatus.textContent = '메모 삭제 중 오류가 발생했습니다.';
                alert('오류가 발생했습니다: ' + error.message);
            }
        }

        let autoSaveTimeout;
        function autoSaveMemo() {
            clearTimeout(autoSaveTimeout);
            memoStatus.textContent = '입력 중...';
            
            autoSaveTimeout = setTimeout(async () => {
                try {
                    const memoContent = memoTextarea.value;
                    
                    const { error } = await supabase
                        .from('memos')
                        .upsert([{
                            user_id: userId,
                            content: memoContent,
                            updated_at: new Date().toISOString()
                        }], {
                            onConflict: 'user_id'
                        });

                    if (error) {
                        throw new Error(`자동 저장 오류: ${error.message}`);
                    }

                    memoStatus.textContent = '자동 저장됨';
                } catch (error) {
                    console.error('자동 저장 오류:', error);
                    memoStatus.textContent = '자동 저장 실패';
                }
            }, 2000);
        }

        // 페이지 로드시 앱 초기화
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
