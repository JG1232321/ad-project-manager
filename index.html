<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´‘ê³  í”„ë¡œì íŠ¸ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="app" class="max-w-6xl mx-auto p-6 bg-gray-50 min-h-screen">
        <!-- ë¡œë”© í™”ë©´ -->
        <div id="loading" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="text-gray-600 mt-4">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- ë©”ì¸ ì•± -->
        <div id="mainApp" class="hidden">
            <!-- í—¤ë” -->
            <div class="mb-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ê´‘ê³  í”„ë¡œì íŠ¸ ê´€ë¦¬</h1>
                <p class="text-gray-600">ê´‘ê³ ì£¼ë³„ ë²„í‚·ìœ¼ë¡œ ì—…ë¬´ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”</p>
            </div>

            <!-- ì˜¤ëŠ˜ ë§ˆê° ì•Œë¦¼ -->
            <div id="todayDeadlines" class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg hidden">
                <div class="flex items-center mb-2">
                    <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                    <h3 class="text-red-700 font-semibold">ì˜¤ëŠ˜ ë§ˆê°ì¸ ì—…ë¬´</h3>
                </div>
                <div id="todayDeadlinesList"></div>
            </div>

            <!-- ë·° ì „í™˜ íƒ­ -->
            <div class="mb-6">
                <div class="flex border-b border-gray-200">
                    <button id="bucketsViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600">
                        ë²„í‚· ë·°
                    </button>
                    <button id="todoViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        íˆ¬ë‘ë¦¬ìŠ¤íŠ¸
                    </button>
                </div>
            </div>

            <!-- ìƒˆ ë²„í‚· ì¶”ê°€ ë²„íŠ¼ -->
            <div id="addBucketSection" class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <button id="addBucketBtn" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        â• ìƒˆ ê´‘ê³ ì£¼ ì¶”ê°€
                    </button>
                    <button id="sortBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <span>ğŸ“…</span>
                        <span id="sortText">ë§ˆê°ì¼ ì˜¤ë¦„ì°¨ìˆœ</span>
                    </button>
                </div>
                
                <!-- ì¶”ê°€ í¼ (ìˆ¨ê¹€) -->
                <div id="addBucketForm" class="bg-white p-6 rounded-lg shadow hidden">
                    <h3 class="text-lg font-semibold mb-4">ìƒˆ ê´‘ê³ ì£¼ ì •ë³´</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ê´‘ê³ ì£¼ëª… *</label>
                            <input type="text" id="bucketNameInput" placeholder="ê´‘ê³ ì£¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë‹¨ê°€ (ì›)</label>
                            <input type="text" id="unitPriceInput" placeholder="ì˜ˆ: 1,000,000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ˜ëŸ‰</label>
                            <input type="text" id="quantityInput" placeholder="ì˜ˆ: 100íšŒ ë…¸ì¶œ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìƒí’ˆ</label>
                            <select id="productInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">ìƒí’ˆ ì„ íƒ</option>
                                <option value="CPM">CPM</option>
                                <option value="CPA">CPA</option>
                                <option value="CPA+">CPA+</option>
                                <option value="CPR">CPR</option>
                                <option value="CPR+">CPR+</option>
                                <option value="CPS">CPS</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê³„ì•½ì¡°ê±´ ë° ê¸°íƒ€ì‚¬í•­</label>
                        <textarea id="contractTermsInput" placeholder="ê³„ì•½ ì¡°ê±´ ë° ê¸°íƒ€ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                    </div>
                    <div class="flex gap-3">
                        <button id="confirmAddBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ì¶”ê°€</button>
                        <button id="cancelAddBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>

            <!-- íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ë·° -->
            <div id="todoView" class="bg-white rounded-lg shadow-md p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">ì „ì²´ ì•¡ì…˜ì•„ì´í…œ</h2>
                    <div class="flex gap-2">
                        <button id="toggleCompletedBtn" class="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
                            <span>ğŸ‘ï¸</span>
                            <span id="toggleCompletedText">ì™„ë£Œí•­ëª© ìˆ¨ê¸°ê¸°</span>
                        </button>
                        <button id="todoSortBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <span>ğŸ“…</span>
                            <span id="todoSortText">ë§ˆê°ì¼ ì˜¤ë¦„ì°¨ìˆœ</span>
                        </button>
                    </div>
                </div>
                <div id="todoList" class="space-y-3"></div>
                <div id="todoEmpty" class="text-gray-500 text-center py-8 hidden">ë“±ë¡ëœ ì•¡ì…˜ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>

            <!-- ë²„í‚· ë·° -->
            <div id="bucketsView">
                <div id="bucketsContainer" class="grid gap-4 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5"></div>
                <div id="emptyState" class="text-center py-16">
                    <div class="text-6xl mb-4">ğŸ“‹</div>
                    <p class="text-gray-500 text-xl mb-2">ì•„ì§ ë“±ë¡ëœ ê´‘ê³ ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-gray-400">ìƒˆ ê´‘ê³ ì£¼ë¥¼ ì¶”ê°€í•´ì„œ ì—…ë¬´ ê´€ë¦¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸ ì—¬ê¸°ì— ì‹¤ì œ Supabase ê°’ì„ ë„£ìœ¼ì„¸ìš”!
        const SUPABASE_URL = 'https://spuiuwgiioxohrjnywnn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWl1d2dpaW94b2hyam55d25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNTU2ODQsImV4cCI6MjA2ODgzMTY4NH0.MMJ9y_KzmluQ5AhcU58vkWD_LdwhEalKQ1fbFnZm0LI';
        
        // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ì „ì—­ ë³€ìˆ˜
        let buckets = [];
        let userId = localStorage.getItem('userId') || 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
        let currentView = 'buckets';
        let sortOrder = 'asc';
        let collapsedBuckets = {}; // ë²„í‚·ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì ‘í˜ (trueê°€ ì ‘í˜)
        let collapsedContracts = {}; // ê³„ì•½ì •ë³´ë„ ê¸°ë³¸ì ìœ¼ë¡œ ì ‘í˜ (trueê°€ ì ‘í˜)
        let editingBucket = null; // í¸ì§‘ ì¤‘ì¸ ë²„í‚· ID
        let editingAction = null; // í¸ì§‘ ì¤‘ì¸ ì•¡ì…˜ ID
        let showCompletedTodos = true; // ì™„ë£Œëœ íˆ¬ë‘ í‘œì‹œ ì—¬ë¶€

        // ë‹¨ê³„ë³„ ê¸°ë³¸ ì•¡ì…˜ ì•„ì´í…œ
        const defaultActionItems = {
            'ëŒ€ê¸°': ['ê´‘ê³ ì£¼ ìš”êµ¬ì‚¬í•­ ìˆ˜ì§‘', 'ì˜ˆì‚° ë° ì¼ì • í™•ì •', 'ê³„ì•½ì„œ ê²€í† '],
            'ì§„í–‰_ê´‘ê³ ì œì‘': ['í¬ë¦¬ì—ì´í‹°ë¸Œ ì»¨ì…‰ ê¸°íš', 'ë””ìì¸ ì‹œì•ˆ ì œì‘', 'ê´‘ê³ ì£¼ í”¼ë“œë°± ë°˜ì˜', 'ìµœì¢… ì†Œì¬ ìŠ¹ì¸'],
            'ì§„í–‰_ê´‘ê³ ìš´ì˜': ['ê´‘ê³  ê³„ì • ì„¸íŒ…', 'ìº í˜ì¸ ëŸ°ì¹­', 'ì¼ì¼ ì„±ê³¼ ëª¨ë‹ˆí„°ë§', 'ìµœì í™” ì‘ì—…'],
            'ì§„í–‰_ë§¤ì¶œì •ì‚°': ['ìµœì¢… ì„±ê³¼ ë¦¬í¬íŠ¸ ì‘ì„±', 'ë§¤ì¶œ ì •ì‚°', 'ê´‘ê³ ì£¼ ê²°ê³¼ ë³´ê³ ']
        };

        // DOM ìš”ì†Œë“¤
        const loading = document.getElementById('loading');
        const mainApp = document.getElementById('mainApp');
        const bucketsViewBtn = document.getElementById('bucketsViewBtn');
        const todoViewBtn = document.getElementById('todoViewBtn');
        const addBucketSection = document.getElementById('addBucketSection');
        const addBucketBtn = document.getElementById('addBucketBtn');
        const addBucketForm = document.getElementById('addBucketForm');
        const bucketNameInput = document.getElementById('bucketNameInput');
        const unitPriceInput = document.getElementById('unitPriceInput');
        const quantityInput = document.getElementById('quantityInput');
        const productInput = document.getElementById('productInput');
        const contractTermsInput = document.getElementById('contractTermsInput');
        const confirmAddBtn = document.getElementById('confirmAddBtn');
        const cancelAddBtn = document.getElementById('cancelAddBtn');
        const sortBtn = document.getElementById('sortBtn');
        const sortText = document.getElementById('sortText');
        const todayDeadlines = document.getElementById('todayDeadlines');
        const todayDeadlinesList = document.getElementById('todayDeadlinesList');
        const todoView = document.getElementById('todoView');
        const bucketsView = document.getElementById('bucketsView');
        const todoList = document.getElementById('todoList');
        const todoEmpty = document.getElementById('todoEmpty');
        const todoSortBtn = document.getElementById('todoSortBtn');
        const todoSortText = document.getElementById('todoSortText');
        const toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
        const toggleCompletedText = document.getElementById('toggleCompletedText');
        const bucketsContainer = document.getElementById('bucketsContainer');
        const emptyState = document.getElementById('emptyState');

        // ì•± ì´ˆê¸°í™”
        async function initApp() {
            try {
                console.log('=== ì•± ì´ˆê¸°í™” ì‹œì‘ ===');
                console.log('SUPABASE_URL:', SUPABASE_URL);
                console.log('User ID:', userId);
                
                // ë‹¨ìˆœí•œ ì—°ê²° í…ŒìŠ¤íŠ¸
                console.log('Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
                const testResult = await supabase.from('buckets').select('*').limit(1);
                console.log('ì—°ê²° í…ŒìŠ¤íŠ¸ ê²°ê³¼:', testResult);
                
                if (testResult.error) {
                    throw new Error(`Supabase ì—°ê²° ì‹¤íŒ¨: ${testResult.error.message}`);
                }
                
                console.log('ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                await loadData();
                
                loading.classList.add('hidden');
                mainApp.classList.remove('hidden');
                updateTodayDeadlines();
                console.log('=== ì•± ì´ˆê¸°í™” ì™„ë£Œ ===');
                
            } catch (error) {
                console.error('=== ì•± ì´ˆê¸°í™” ì‹¤íŒ¨ ===');
                console.error('ì˜¤ë¥˜ ìƒì„¸:', error);
                
                loading.classList.add('hidden');
                mainApp.classList.remove('hidden');
                
                // ìƒì„¸í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                const errorDiv = document.createElement('div');
                errorDiv.className = 'mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg';
                errorDiv.innerHTML = `
                    <h3 class="font-semibold mb-2">ğŸš¨ ì—°ê²° ì˜¤ë¥˜ ë°œìƒ</h3>
                    <p class="text-sm mb-2"><strong>ì˜¤ë¥˜:</strong> ${error.message}</p>
                    <div class="text-sm">
                        <p><strong>í˜„ì¬ ì„¤ì •:</strong></p>
                        <p>â€¢ Supabase URL: ${SUPABASE_URL}</p>
                        <p>â€¢ ì‚¬ìš©ì ID: ${userId}</p>
                        <p class="mt-2"><strong>í•´ê²° ë°©ë²•:</strong></p>
                        <p>1. F12 â†’ Console íƒ­ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ í™•ì¸</p>
                        <p>2. Supabaseì—ì„œ í…Œì´ë¸”ì´ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸</p>
                        <p>3. API í‚¤ê°€ ì •í™•í•œì§€ í™•ì¸</p>
                    </div>
                `;
                mainApp.insertBefore(errorDiv, mainApp.firstChild);
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        bucketsViewBtn.addEventListener('click', () => switchView('buckets'));
        todoViewBtn.addEventListener('click', () => switchView('todo'));
        addBucketBtn.addEventListener('click', showAddForm);
        confirmAddBtn.addEventListener('click', addBucket);
        cancelAddBtn.addEventListener('click', hideAddForm);
        sortBtn.addEventListener('click', toggleSort);
        todoSortBtn.addEventListener('click', toggleTodoSort);
        toggleCompletedBtn.addEventListener('click', toggleCompletedVisibility);

        bucketNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                addBucket();
            }
        });

        // ë·° ì „í™˜
        function switchView(view) {
            currentView = view;
            
            if (view === 'buckets') {
                bucketsViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                todoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                addBucketSection.classList.remove('hidden');
                todoView.classList.add('hidden');
                bucketsView.classList.remove('hidden');
            } else {
                todoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                bucketsViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                addBucketSection.classList.add('hidden');
                todoView.classList.remove('hidden');
                bucketsView.classList.add('hidden');
                renderTodoView();
            }
        }

        // ì •ë ¬ í† ê¸€ (ë²„í‚·ë·°ìš©)
        function toggleSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            sortText.textContent = `ë§ˆê°ì¼ ${sortOrder === 'asc' ? 'ì˜¤ë¦„ì°¨ìˆœ' : 'ë‚´ë¦¼ì°¨ìˆœ'}`;
            if (currentView === 'buckets') {
                renderBuckets();
            }
        }

        // íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ì •ë ¬ í† ê¸€
        function toggleTodoSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            todoSortText.textContent = `ë§ˆê°ì¼ ${sortOrder === 'asc' ? 'ì˜¤ë¦„ì°¨ìˆœ' : 'ë‚´ë¦¼ì°¨ìˆœ'}`;
            if (currentView === 'todo') {
                renderTodoView();
            }
        }

        // ì™„ë£Œëœ íˆ¬ë‘ ê°€ì‹œì„± í† ê¸€
        function toggleCompletedVisibility() {
            showCompletedTodos = !showCompletedTodos;
            
            if (showCompletedTodos) {
                toggleCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors';
                toggleCompletedText.textContent = 'ì™„ë£Œí•­ëª© ìˆ¨ê¸°ê¸°';
            } else {
                toggleCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors';
                toggleCompletedText.textContent = 'ì™„ë£Œí•­ëª© ë³´ê¸°';
            }
            
            if (currentView === 'todo') {
                renderTodoView();
            }
        }

        // ì˜¤ëŠ˜ ë§ˆê° ì—…ë°ì´íŠ¸
        function updateTodayDeadlines() {
            const today = new Date().toISOString().split('T')[0];
            const todayItems = [];
            
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    if (action.deadline === today && !action.completed) {
                        todayItems.push({
                            bucketName: bucket.name,
                            actionText: action.text
                        });
                    }
                });
            });

            if (todayItems.length > 0) {
                todayDeadlinesList.innerHTML = todayItems.map(item => 
                    `<p class="text-red-600 text-sm">â€¢ [${item.bucketName}] ${item.actionText}</p>`
                ).join('');
                todayDeadlines.classList.remove('hidden');
            } else {
                todayDeadlines.classList.add('hidden');
            }
        }

        // ì¶”ê°€ í¼ ë³´ì´ê¸°
        function showAddForm() {
            addBucketForm.classList.remove('hidden');
            bucketNameInput.focus();
        }

        // ì¶”ê°€ í¼ ìˆ¨ê¸°ê¸°
        function hideAddForm() {
            addBucketForm.classList.add('hidden');
            bucketNameInput.value = '';
            unitPriceInput.value = '';
            quantityInput.value = '';
            productInput.value = '';
            contractTermsInput.value = '';
        }

        // ìƒˆ ë²„í‚· ì¶”ê°€
        async function addBucket() {
            const name = bucketNameInput.value.trim();
            if (!name) {
                alert('ê´‘ê³ ì£¼ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            try {
                confirmAddBtn.disabled = true;
                confirmAddBtn.textContent = 'ì¶”ê°€ ì¤‘...';

                const bucketData = {
                    name: name,
                    stage: 'ëŒ€ê¸°',
                    user_id: userId,
                    unit_price: unitPriceInput.value.trim(),
                    quantity: quantityInput.value.trim(),
                    product: productInput.value.trim(),
                    contract_terms: contractTermsInput.value.trim()
                };

                const { data: newBucket, error: bucketError } = await supabase
                    .from('buckets')
                    .insert([bucketData])
                    .select()
                    .single();

                if (bucketError) throw bucketError;

                const actionsToInsert = defaultActionItems['ëŒ€ê¸°'].map((action, index) => ({
                    bucket_id: newBucket.id,
                    text: action,
                    completed: false,
                    deadline: null,
                    order_index: index
                }));

                const { error: actionsError } = await supabase
                    .from('actions')
                    .insert(actionsToInsert);

                if (actionsError) throw actionsError;

                hideAddForm();
                await loadData();
                updateTodayDeadlines();
                
            } catch (error) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                confirmAddBtn.disabled = false;
                confirmAddBtn.textContent = 'ì¶”ê°€';
            }
        }

        // ë²„í‚· ì •ë³´ ì—…ë°ì´íŠ¸
        async function updateBucketInfo(bucketId, field, value) {
            try {
                const { error } = await supabase
                    .from('buckets')
                    .update({ [field]: value })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) throw error;

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket[field] = value;
                }
            } catch (error) {
                console.error('ë²„í‚· ì •ë³´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ë‹¨ê³„ ë³€ê²½
        async function changeStage(bucketId, newStage) {
            try {
                const { error } = await supabase
                    .from('buckets')
                    .update({ stage: newStage })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) throw error;

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket.stage = newStage;
                    renderBuckets();
                }
                
            } catch (error) {
                alert('ë‹¨ê³„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                await loadData();
            }
        }

        // ìƒˆ ì•¡ì…˜ ì•„ì´í…œ ì¶”ê°€
        async function addCustomAction(bucketId) {
            const text = prompt('ìƒˆ ì•¡ì…˜ì•„ì´í…œì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!text || !text.trim()) return;

            try {
                const { error } = await supabase
                    .from('actions')
                    .insert([{
                        bucket_id: bucketId,
                        text: text.trim(),
                        completed: false,
                        deadline: null
                    }]);

                if (error) throw error;
                await loadData();
                updateTodayDeadlines();
            } catch (error) {
                alert('ì•¡ì…˜ì•„ì´í…œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì•¡ì…˜ ì•„ì´í…œ í† ê¸€
        async function toggleActionItem(bucketId, actionId) {
            try {
                const bucket = buckets.find(b => b.id === bucketId);
                const action = bucket?.actions?.find(a => a.id === actionId);
                
                if (!action) return;

                const newCompleted = !action.completed;

                const { error } = await supabase
                    .from('actions')
                    .update({ completed: newCompleted })
                    .eq('id', actionId);

                if (error) throw error;

                action.completed = newCompleted;
                if (currentView === 'buckets') {
                    renderBuckets();
                } else {
                    renderTodoView();
                }
                updateTodayDeadlines();
                
            } catch (error) {
                alert('ì•¡ì…˜ì•„ì´í…œ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                await loadData();
            }
        }

        // ë§ˆê°ì¼ ì„¤ì •
        async function setDeadline(bucketId, actionId, deadline) {
            try {
                const { error } = await supabase
                    .from('actions')
                    .update({ deadline: deadline || null })
                    .eq('id', actionId);

                if (error) throw error;

                const bucket = buckets.find(b => b.id === bucketId);
                const action = bucket?.actions?.find(a => a.id === actionId);
                if (action) {
                    action.deadline = deadline;
                }

                updateTodayDeadlines();
            } catch (error) {
                console.error('ë§ˆê°ì¼ ì„¤ì • ì˜¤ë¥˜:', error);
            }
        }

        // ì•¡ì…˜ ì•„ì´í…œ ì‚­ì œ
        async function deleteActionItem(bucketId, actionId) {
            if (!confirm('ì´ ì•¡ì…˜ì•„ì´í…œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const { error } = await supabase
                    .from('actions')
                    .delete()
                    .eq('id', actionId);

                if (error) throw error;
                await loadData();
                updateTodayDeadlines();
            } catch (error) {
                alert('ì•¡ì…˜ì•„ì´í…œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë²„í‚· ì‚­ì œ
        async function deleteBucket(bucketId) {
            if (!confirm('ì •ë§ë¡œ ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì•¡ì…˜ì•„ì´í…œë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;

            try {
                const { error } = await supabase
                    .from('buckets')
                    .delete()
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) throw error;

                await loadData();
                updateTodayDeadlines();
                
            } catch (error) {
                alert('í”„ë¡œì íŠ¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë²„í‚·ëª… í¸ì§‘ ì‹œì‘
        function startEditBucket(bucketId, currentName) {
            editingBucket = bucketId;
            renderBuckets();
        }

        // ë²„í‚·ëª… í¸ì§‘ ì €ì¥
        async function saveEditBucket(bucketId, newName) {
            if (!newName.trim()) return;
            
            try {
                const { error } = await supabase
                    .from('buckets')
                    .update({ name: newName.trim() })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) throw error;

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket.name = newName.trim();
                }
                
                editingBucket = null;
                renderBuckets();
            } catch (error) {
                alert('ë²„í‚·ëª… ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë²„í‚·ëª… í¸ì§‘ ì·¨ì†Œ
        function cancelEditBucket() {
            editingBucket = null;
            renderBuckets();
        }

        // ì•¡ì…˜ ì•„ì´í…œ í¸ì§‘ ì‹œì‘
        function startEditAction(actionId) {
            editingAction = actionId;
            renderBuckets();
        }

        // ì•¡ì…˜ ì•„ì´í…œ í¸ì§‘ ì €ì¥
        async function saveEditAction(actionId, newText) {
            if (!newText.trim()) return;
            
            try {
                const { error } = await supabase
                    .from('actions')
                    .update({ text: newText.trim() })
                    .eq('id', actionId);

                if (error) throw error;

                buckets.forEach(bucket => {
                    const action = bucket.actions?.find(a => a.id === actionId);
                    if (action) {
                        action.text = newText.trim();
                    }
                });
                
                editingAction = null;
                renderBuckets();
            } catch (error) {
                alert('ì•¡ì…˜ì•„ì´í…œ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì•¡ì…˜ ì•„ì´í…œ í¸ì§‘ ì·¨ì†Œ
        function cancelEditAction() {
            editingAction = null;
            renderBuckets();
        }

        // ë²„í‚· ì ‘ê¸°/í¼ì¹˜ê¸°
        function toggleBucketCollapse(bucketId) {
            collapsedBuckets[bucketId] = !collapsedBuckets[bucketId];
            renderBuckets();
        }

        // ê³„ì•½ ì •ë³´ ì ‘ê¸°/í¼ì¹˜ê¸°
        function toggleContractCollapse(bucketId) {
            collapsedContracts[bucketId] = !collapsedContracts[bucketId];
            renderBuckets();
        }

        // ì•¡ì…˜ ì•„ì´í…œ ì •ë ¬
        function getSortedActions(actions) {
            return [...actions].sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return sortOrder === 'asc' ? 1 : -1;
                if (!b.deadline) return sortOrder === 'asc' ? -1 : 1;
                
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
        }

        // íˆ¬ë‘ë·° ë Œë”ë§
        function renderTodoView() {
            const allItems = [];
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    allItems.push({
                        ...action,
                        bucketName: bucket.name,
                        bucketId: bucket.id,
                        bucketStage: bucket.stage
                    });
                });
            });

            // ì™„ë£Œëœ í•­ëª© í•„í„°ë§
            let filteredItems = allItems;
            if (!showCompletedTodos) {
                filteredItems = allItems.filter(item => !item.completed);
            }

            // ì™„ë£Œ ìƒíƒœë³„ë¡œ ë¶„ë¦¬í•˜ê³  ì •ë ¬
            const incompleteItems = filteredItems.filter(item => !item.completed);
            const completedItems = filteredItems.filter(item => item.completed);
            
            const sortedIncompleteItems = getSortedActions(incompleteItems);
            const sortedCompletedItems = getSortedActions(completedItems);
            
            // ë¯¸ì™„ë£Œ í•­ëª©ì„ ìœ„ì—, ì™„ë£Œ í•­ëª©ì„ ì•„ë˜ì— ë°°ì¹˜
            const sortedItems = [...sortedIncompleteItems, ...sortedCompletedItems];

            if (sortedItems.length === 0) {
                todoList.classList.add('hidden');
                todoEmpty.classList.remove('hidden');
                return;
            }

            todoList.classList.remove('hidden');
            todoEmpty.classList.add('hidden');

            todoList.innerHTML = sortedItems.map(action => {
                const today = new Date().toISOString().split('T')[0];
                const isToday = action.deadline === today && !action.completed;
                
                return `
                    <div class="flex items-center justify-between p-3 rounded-lg border ${action.completed ? 'bg-gray-50 border-gray-200' : 'bg-white border-gray-200'}">
                        <div class="flex items-center gap-3 flex-1">
                            <button onclick="toggleActionItem(${action.bucketId}, ${action.id})" class="flex-shrink-0 text-lg">
                                ${action.completed ? 'âœ…' : 'â­•'}
                            </button>
                            <div class="flex-1">
                                <p class="text-sm font-medium ${action.completed ? 'line-through text-gray-500' : 'text-gray-800'}">
                                    ${action.text}
                                </p>
                                <p class="text-xs ${action.completed ? 'text-gray-400' : 'text-gray-500'}">
                                    [${action.bucketName}] - ${action.bucketStage}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="date" value="${action.deadline || ''}" onchange="setDeadline(${action.bucketId}, ${action.id}, this.value)" class="px-2 py-1 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${isToday ? 'border-red-500 bg-red-50' : 'border-gray-200'} ${action.completed ? 'text-gray-400' : ''}"/>
                            <button onclick="deleteActionItem(${action.bucketId}, ${action.id})" class="text-red-500 hover:text-red-700">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ë²„í‚· ëª©ë¡ ë Œë”ë§
        function renderBuckets() {
            if (buckets.length === 0) {
                emptyState.classList.remove('hidden');
                bucketsContainer.innerHTML = '';
                return;
            }

            emptyState.classList.add('hidden');
            bucketsContainer.innerHTML = '';

            buckets.forEach(bucket => {
                const bucketElement = createBucketElement(bucket);
                bucketsContainer.appendChild(bucketElement);
            });
        }

        // ë²„í‚· ìš”ì†Œ ìƒì„±
        function createBucketElement(bucket) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-md p-4';

            const actions = bucket.actions || [];
            const sortedActions = getSortedActions(actions);
            const isCollapsed = collapsedBuckets[bucket.id] !== false; // ê¸°ë³¸ê°’ì€ ì ‘í˜ (true)
            const isContractCollapsed = collapsedContracts[bucket.id] !== false; // ê¸°ë³¸ê°’ì€ ì ‘í˜ (true)

            div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <button onclick="toggleBucketCollapse(${bucket.id})" class="text-gray-600 hover:text-gray-800">
                                ${isCollapsed ? 'â–¶' : 'â–¼'}
                            </button>
                            ${editingBucket === bucket.id ? `
                                <input type="text" value="${bucket.name}" 
                                       onkeypress="if(event.key==='Enter') saveEditBucket(${bucket.id}, this.value); if(event.key==='Escape') cancelEditBucket();"
                                       onblur="saveEditBucket(${bucket.id}, this.value)"
                                       class="flex-1 px-2 py-1 text-sm font-semibold border border-blue-500 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                       autofocus />
                                <button onclick="cancelEditBucket()" class="text-red-500 hover:text-red-700 text-sm">âœ•</button>
                            ` : `
                                <h3 class="text-sm font-semibold text-gray-800 flex-1">${bucket.name}</h3>
                                <button onclick="startEditBucket(${bucket.id}, '${bucket.name}')" class="text-gray-400 hover:text-gray-600 text-sm">âœï¸</button>
                            `}
                        </div>
                    </div>
                    <button onclick="deleteBucket(${bucket.id})" class="text-red-500 hover:text-red-700 text-sm">
                        ğŸ—‘ï¸
                    </button>
                </div>

                ${!isCollapsed ? `
                    <!-- ë‹¨ê³„ ì„ íƒ -->
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-700 mb-1">ë‹¨ê³„</label>
                        <select onchange="changeStage(${bucket.id}, this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="ëŒ€ê¸°" ${bucket.stage === 'ëŒ€ê¸°' ? 'selected' : ''}>ëŒ€ê¸°</option>
                            <option value="ì§„í–‰_ê´‘ê³ ì œì‘" ${bucket.stage === 'ì§„í–‰_ê´‘ê³ ì œì‘' ? 'selected' : ''}>ì§„í–‰_ê´‘ê³ ì œì‘</option>
                            <option value="ì§„í–‰_ê´‘ê³ ìš´ì˜" ${bucket.stage === 'ì§„í–‰_ê´‘ê³ ìš´ì˜' ? 'selected' : ''}>ì§„í–‰_ê´‘ê³ ìš´ì˜</option>
                            <option value="ì§„í–‰_ë§¤ì¶œì •ì‚°" ${bucket.stage === 'ì§„í–‰_ë§¤ì¶œì •ì‚°' ? 'selected' : ''}>ì§„í–‰_ë§¤ì¶œì •ì‚°</option>
                        </select>
                    </div>

                    <!-- ê³„ì•½ ì •ë³´ -->
                    <div class="mb-3 p-3 bg-gray-50 rounded">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs font-medium text-gray-700">ê³„ì•½ ì •ë³´</h4>
                            <button onclick="toggleContractCollapse(${bucket.id})" class="text-gray-600 hover:text-gray-800">
                                ${isContractCollapsed ? 'â–¶' : 'â–¼'}
                            </button>
                        </div>
                        
                        ${!isContractCollapsed ? `
                            <div class="grid grid-cols-1 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ë‹¨ê°€ (ì›)</label>
                                    <input type="text" value="${bucket.unit_price || ''}" onchange="updateBucketInfo(${bucket.id}, 'unit_price', this.value)" placeholder="ì˜ˆ: 1,000,000" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"/>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ìˆ˜ëŸ‰</label>
                                    <input type="text" value="${bucket.quantity || ''}" onchange="updateBucketInfo(${bucket.id}, 'quantity', this.value)" placeholder="ì˜ˆ: 100íšŒ ë…¸ì¶œ" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"/>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ìƒí’ˆ</label>
                                    <select onchange="updateBucketInfo(${bucket.id}, 'product', this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">ì„ íƒ</option>
                                        <option value="CPM" ${bucket.product === 'CPM' ? 'selected' : ''}>CPM</option>
                                        <option value="CPA" ${bucket.product === 'CPA' ? 'selected' : ''}>CPA</option>
                                        <option value="CPA+" ${bucket.product === 'CPA+' ? 'selected' : ''}>CPA+</option>
                                        <option value="CPR" ${bucket.product === 'CPR' ? 'selected' : ''}>CPR</option>
                                        <option value="CPR+" ${bucket.product === 'CPR+' ? 'selected' : ''}>CPR+</option>
                                        <option value="CPS" ${bucket.product === 'CPS' ? 'selected' : ''}>CPS</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ê³„ì•½ì¡°ê±´</label>
                                    <textarea onchange="updateBucketInfo(${bucket.id}, 'contract_terms', this.value)" placeholder="ê³„ì•½ ì¡°ê±´..." rows="2" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none">${bucket.contract_terms || ''}</textarea>
                                </div>
                            </div>
                        ` : `
                            ${(bucket.unit_price || bucket.quantity || bucket.product) ? `
                                <div class="text-xs text-gray-500">
                                    ${bucket.unit_price ? `${bucket.unit_price}ì›` : ''}
                                    ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                    ${bucket.quantity ? `${bucket.quantity}` : ''}
                                    ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                    ${bucket.product ? `${bucket.product}` : ''}
                                </div>
                            ` : ''}
                        `}
                    </div>

                    <!-- ì•¡ì…˜ ì•„ì´í…œ -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xs font-medium text-gray-700">ì•¡ì…˜ ì•„ì´í…œ</h4>
                            <button onclick="addCustomAction(${bucket.id})" class="text-blue-600 hover:text-blue-800 text-xs">
                                â•
                            </button>
                        </div>
                        
                        ${sortedActions.map(action => {
                            const today = new Date().toISOString().split('T')[0];
                            const isToday = action.deadline === today && !action.completed;
                            
                            return `
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleActionItem(${bucket.id}, ${action.id})" class="flex-shrink-0 ${action.completed ? 'text-green-600' : 'text-gray-400'}">
                                            ${action.completed ? 'âœ…' : 'â­•'}
                                        </button>
                                        ${editingAction === action.id ? `
                                            <input type="text" value="${action.text}" 
                                                   onkeypress="if(event.key==='Enter') saveEditAction(${action.id}, this.value); if(event.key==='Escape') cancelEditAction();"
                                                   onblur="saveEditAction(${action.id}, this.value)"
                                                   class="flex-1 px-1 py-0.5 text-xs border border-blue-500 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                   autofocus />
                                            <button onclick="cancelEditAction()" class="text-red-500 hover:text-red-700 text-xs">âœ•</button>
                                        ` : `
                                            <span class="flex-1 text-xs ${action.completed ? 'line-through text-gray-500' : 'text-gray-700'} cursor-pointer" 
                                                  onclick="startEditAction(${action.id})">
                                                ${action.text}
                                            </span>
                                            <button onclick="deleteActionItem(${bucket.id}, ${action.id})" class="text-red-500 hover:text-red-700 text-xs">
                                                âŒ
                                            </button>
                                        `}
                                    </div>
                                    ${editingAction !== action.id ? `
                                        <input type="date" value="${action.deadline || ''}" onchange="setDeadline(${bucket.id}, ${action.id}, this.value)" class="ml-5 px-1 py-0.5 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${isToday ? 'border-red-500 bg-red-50' : 'border-gray-200'}" />
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : `
                    <!-- ì ‘í˜€ìˆì„ ë•Œ ìš”ì•½ ì •ë³´ -->
                    <div class="mt-1">
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>${bucket.stage}</span>
                        </div>
                        ${(bucket.unit_price || bucket.quantity || bucket.product) ? `
                            <div class="text-xs text-gray-500 mt-1">
                                ${bucket.unit_price ? `${bucket.unit_price}ì›` : ''}
                                ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                ${bucket.quantity ? `${bucket.quantity}` : ''}
                                ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                ${bucket.product ? `${bucket.product}` : ''}
                            </div>
                        ` : ''}
                    </div>
                `}
            `;

            return div;
        }
                        <div class="w-full bg-gray-200 rounded-full h-1 mt-2">
                            <div class="bg-blue-600 h-1 rounded-full transition-all duration-300" style="width: ${progressPercentage}%"></div>
                        </div>
                    </div>
                `}
            `;

            return div;
        }

        // ì•± ì‹œì‘ì‹œ ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                console.log('ë°ì´í„° ë¡œë“œ ì‹œì‘, userId:', userId);
                
                const { data, error } = await supabase
                    .from('buckets')
                    .select(`
                        *,
                        actions (*)
                    `)
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                console.log('Supabase ì‘ë‹µ:', { data, error });

                if (error) {
                    console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    throw error;
                }

                buckets = data || [];
                console.log('ë¡œë“œëœ ë²„í‚· ìˆ˜:', buckets.length);
                
                renderBuckets();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì „ì²´ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        initApp();
    </script>
</body>
</html>
