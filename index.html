<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´‘ê³  í”„ë¡œì íŠ¸ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
        .bucket-card {
            transition: all 0.2s ease;
        }
        
        .bucket-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .drop-zone.drag-active {
            background-color: #f0f9ff;
            border: 2px dashed #3b82f6;
            border-radius: 8px;
        }
        
        .drop-zone.drag-over {
            background-color: #e0f2fe;
            border: 2px solid #0ea5e9;
            transform: scale(1.02);
        }
        
        .bucket-card[draggable="true"] {
            cursor: move;
        }
        
        .bucket-card:active {
            cursor: grabbing;
        }
        
        /* ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ ì„ íƒ ë°©ì§€ */
        .drop-zone.drag-active * {
            pointer-events: none;
        }
        
        .drop-zone.drag-active .bucket-card {
            pointer-events: auto;
        }
        
        /* ë“œë˜ê·¸ í•¸ë“¤ ìŠ¤íƒ€ì¼ */
        .bucket-card .cursor-move:hover {
            color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-center mb-6">ğŸ” ì—…ë¬´ê´€ë¦¬ì•± ë¡œê·¸ì¸</h2>
            
            <!-- ë¡œê·¸ì¸ í¼ -->
            <div id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì‚¬ìš©ì ID</label>
                    <input type="text" id="loginUserId" placeholder="ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-3">
                    <button onclick="handleLogin()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        ë¡œê·¸ì¸
                    </button>
                    <button onclick="showSignupForm()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        íšŒì›ê°€ì…
                    </button>
                </div>
            </div>

            <!-- íšŒì›ê°€ì… í¼ -->
            <div id="signupForm" class="hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì‚¬ìš©ì ID</label>
                    <input type="text" id="signupUserId" placeholder="ì‚¬ìš©í•  IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="signupPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„</label>
                    <input type="text" id="signupName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-3">
                    <button onclick="handleSignup()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        íšŒì›ê°€ì…
                    </button>
                    <button onclick="showLoginForm()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                        ë¡œê·¸ì¸ìœ¼ë¡œ
                    </button>
                </div>
            </div>

            <div id="authStatus" class="mt-4 text-sm text-center text-gray-600"></div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-6">
        <!-- í—¤ë” -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-bold text-gray-800 mb-3">ğŸ“Š ê´‘ê³  í”„ë¡œì íŠ¸ ê´€ë¦¬</h1>
                <p class="text-gray-600 text-lg">ê´‘ê³ ì£¼ë³„ ë²„í‚·ìœ¼ë¡œ ì—…ë¬´ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”</p>
            </div>
            <div id="userInfo" class="text-right hidden">
                <p class="text-sm text-gray-600">í™˜ì˜í•©ë‹ˆë‹¤!</p>
                <p class="font-semibold text-gray-800" id="userName"></p>
                <button onclick="logout()" class="mt-1 px-3 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>

        <!-- ë¡œë”© ìƒíƒœ -->
        <div id="loadingIndicator" class="text-center py-8 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- ì˜¤ëŠ˜ ë§ˆê° ì•Œë¦¼ -->
        <div id="todayDeadlines" class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg hidden">
            <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-red-700 font-semibold">ì˜¤ëŠ˜ ë§ˆê°ì¸ ì—…ë¬´</h3>
            </div>
            <div id="todayDeadlinesList"></div>
        </div>

        <!-- ë·° ì „í™˜ íƒ­ -->
        <div class="mb-6">
            <div class="flex border-b border-gray-200">
                <button id="bucketsViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600">
                    ë²„í‚· ë·°
                </button>
                <button id="stageViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    ë‹¨ê³„ë³„ ë·°
                </button>
                <button id="todoViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    íˆ¬ë‘ë¦¬ìŠ¤íŠ¸
                </button>
                <button id="recurringViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    ë°˜ë³µ ê·œì¹™
                </button>
                <button id="memoViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    ë©”ëª¨ì¥
                </button>
            </div>
        </div>

        <!-- ìƒˆ ë²„í‚· ì¶”ê°€ ì„¹ì…˜ -->
        <div id="addBucketSection" class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <button id="addBucketBtn" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    â• ìƒˆ ê´‘ê³ ì£¼ ì¶”ê°€
                </button>
                <div class="flex gap-2">
                    <button id="toggleBucketCompletedBtn" class="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm">
                        <span>ğŸ‘ï¸</span>
                        <span id="toggleBucketCompletedText">ì™„ë£Œí•­ëª© ìˆ¨ê¸°ê¸°</span>
                    </button>
                    <button id="sortBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        <span>ğŸ“…</span>
                        <span id="sortText">ë§ˆê°ì¼ ì˜¤ë¦„ì°¨ìˆœ</span>
                    </button>
                </div>
            </div>
            
            <!-- ì¶”ê°€ í¼ -->
            <div id="addBucketForm" class="bg-white p-6 rounded-lg shadow hidden">
                <h3 class="text-lg font-semibold mb-4">ìƒˆ ê´‘ê³ ì£¼ ì •ë³´</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê´‘ê³ ì£¼ëª… *</label>
                        <input type="text" id="bucketNameInput" placeholder="ê´‘ê³ ì£¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë‹¨ê°€ (ì›)</label>
                        <input type="text" id="unitPriceInput" placeholder="ì˜ˆ: 1,000,000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ˜ëŸ‰</label>
                        <input type="text" id="quantityInput" placeholder="ì˜ˆ: 100íšŒ ë…¸ì¶œ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìƒí’ˆ</label>
                        <select id="productInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">ìƒí’ˆ ì„ íƒ</option>
                            <option value="CPM">CPM</option>
                            <option value="CPA">CPA</option>
                            <option value="CPA+">CPA+</option>
                            <option value="CPR">CPR</option>
                            <option value="CPR+">CPR+</option>
                            <option value="CPS">CPS</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê³„ì•½ì¡°ê±´ ë° ê¸°íƒ€ì‚¬í•­</label>
                    <textarea id="contractTermsInput" placeholder="ê³„ì•½ ì¡°ê±´ ë° ê¸°íƒ€ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                </div>
                <div class="flex gap-3">
                    <button id="confirmAddBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ì¶”ê°€</button>
                    <button id="cancelAddBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>

        <!-- ë²„í‚· ë·° -->
        <div id="bucketsView">
            <div id="bucketsContainer" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
            <div id="emptyState" class="text-center py-16">
                <div class="text-6xl mb-4">ğŸ“‹</div>
                <p class="text-gray-500 text-xl mb-2">ì•„ì§ ë“±ë¡ëœ ê´‘ê³ ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p class="text-gray-400">ìƒˆ ê´‘ê³ ì£¼ë¥¼ ì¶”ê°€í•´ì„œ ì—…ë¬´ ê´€ë¦¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
            </div>
        </div>

        <!-- ë‹¨ê³„ë³„ ë·° -->
        <div id="stageView" class="hidden">
            <div class="grid gap-6 lg:grid-cols-4">
                <!-- ëŒ€ê¸° ë‹¨ê³„ -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="bg-gray-100 px-4 py-3 rounded-t-lg border-b">
                        <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                            â³ ëŒ€ê¸°
                            <span id="waitingCount" class="bg-gray-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="waitingStage" class="p-4 space-y-3 min-h-[400px] drop-zone" data-stage="ëŒ€ê¸°"></div>
                </div>

                <!-- ê´‘ê³ ì œì‘ ë‹¨ê³„ -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="bg-blue-100 px-4 py-3 rounded-t-lg border-b">
                        <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                            ğŸ¨ ê´‘ê³ ì œì‘
                            <span id="creativeCount" class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="creativeStage" class="p-4 space-y-3 min-h-[400px] drop-zone" data-stage="ì§„í–‰_ê´‘ê³ ì œì‘"></div>
                </div>

                <!-- ê´‘ê³ ìš´ì˜ ë‹¨ê³„ -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="bg-green-100 px-4 py-3 rounded-t-lg border-b">
                        <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                            ğŸ“ˆ ê´‘ê³ ìš´ì˜
                            <span id="operationCount" class="bg-green-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="operationStage" class="p-4 space-y-3 min-h-[400px] drop-zone" data-stage="ì§„í–‰_ê´‘ê³ ìš´ì˜"></div>
                </div>

                <!-- ë§¤ì¶œì •ì‚° ë‹¨ê³„ -->
                <div class="bg-white rounded-lg shadow-md">
                    <div class="bg-purple-100 px-4 py-3 rounded-t-lg border-b">
                        <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                            ğŸ’° ë§¤ì¶œì •ì‚°
                            <span id="settlementCount" class="bg-purple-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </h3>
                    </div>
                    <div id="settlementStage" class="p-4 space-y-3 min-h-[400px] drop-zone" data-stage="ì§„í–‰_ë§¤ì¶œì •ì‚°"></div>
                </div>
            </div>
        </div>

        <!-- íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ë·° -->
        <div id="todoView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">ì „ì²´ ì•¡ì…˜ì•„ì´í…œ</h2>
                <div class="flex gap-2">
                    <button id="addTodoBtn" class="flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        <span>â•</span>
                        <span>ìƒˆ ì•¡ì…˜ì•„ì´í…œ</span>
                    </button>
                    <button id="exportExcelBtn" class="flex items-center gap-2 px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                        <span>ğŸ“Š</span>
                        <span>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</span>
                    </button>
                    <button id="toggleCompletedBtn" class="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm">
                        <span>ğŸ‘ï¸</span>
                        <span id="toggleCompletedText">ì™„ë£Œí•­ëª© ìˆ¨ê¸°ê¸°</span>
                    </button>
                    <button id="todoSortBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        <span>ğŸ“…</span>
                        <span id="todoSortText">ë§ˆê°ì¼ ì˜¤ë¦„ì°¨ìˆœ</span>
                    </button>
                </div>
            </div>
            
            <!-- ìƒˆ ì•¡ì…˜ì•„ì´í…œ ì¶”ê°€ í¼ -->
            <div id="addTodoForm" class="bg-gray-50 p-4 rounded-lg mb-4 hidden">
                <h3 class="text-lg font-semibold mb-3">ìƒˆ ì•¡ì…˜ì•„ì´í…œ ì¶”ê°€</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê´‘ê³ ì£¼ ì„ íƒ *</label>
                        <select id="todoBucketSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">ê´‘ê³ ì£¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë§ˆê°ì¼</label>
                        <input type="date" id="todoDeadlineInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì•¡ì…˜ì•„ì´í…œ ë‚´ìš© *</label>
                    <input type="text" id="todoTextInput" placeholder="ì•¡ì…˜ì•„ì´í…œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-3">
                    <button id="confirmAddTodoBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ì¶”ê°€</button>
                    <button id="cancelAddTodoBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
                </div>
            </div>
            
            <div id="todoList" class="space-y-3"></div>
            <div id="todoEmpty" class="text-gray-500 text-center py-8 hidden">ë“±ë¡ëœ ì•¡ì…˜ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <!-- ë°˜ë³µ ê·œì¹™ ë·° -->
        <div id="recurringView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">ë°˜ë³µ ê·œì¹™ ê´€ë¦¬</h2>
                <button id="addRecurringRuleBtn" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    <span>ğŸ”„</span>
                    <span>ìƒˆ ë°˜ë³µ ê·œì¹™</span>
                </button>
            </div>
            
            <!-- ìƒˆ ë°˜ë³µ ê·œì¹™ ì¶”ê°€ í¼ -->
            <div id="addRecurringForm" class="bg-gray-50 p-6 rounded-lg mb-6 hidden">
                <h3 class="text-lg font-semibold mb-4">ìƒˆ ë°˜ë³µ ê·œì¹™ ìƒì„±</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê·œì¹™ëª… *</label>
                        <input type="text" id="ruleNameInput" placeholder="ì˜ˆ: ì¼ì¼ ì„±ê³¼ ì²´í¬" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê´‘ê³ ì£¼ ì„ íƒ *</label>
                        <select id="ruleBucketSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">ê´‘ê³ ì£¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì•¡ì…˜ì•„ì´í…œ ë‚´ìš© *</label>
                    <input type="text" id="ruleActionInput" placeholder="ìƒì„±ë  ì•¡ì…˜ì•„ì´í…œ ë‚´ìš©" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- ë°˜ë³µ ì„¤ì • -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë°˜ë³µ ì£¼ê¸° *</label>
                        <select id="repeatTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="daily">ë§¤ì¼</option>
                            <option value="weekly">ë§¤ì£¼</option>
                            <option value="monthly">ë§¤ì›”</option>
                        </select>
                    </div>
                    <div id="weeklyDayContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìš”ì¼ ì„ íƒ</label>
                        <select id="weeklyDaySelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1">ì›”ìš”ì¼</option>
                            <option value="2">í™”ìš”ì¼</option>
                            <option value="3">ìˆ˜ìš”ì¼</option>
                            <option value="4">ëª©ìš”ì¼</option>
                            <option value="5">ê¸ˆìš”ì¼</option>
                            <option value="6">í† ìš”ì¼</option>
                            <option value="0">ì¼ìš”ì¼</option>
                        </select>
                    </div>
                    <div id="monthlyDateContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë‚ ì§œ ì„ íƒ</label>
                        <select id="monthlyDateSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- 1ì¼ë¶€í„° 31ì¼ê¹Œì§€ ì˜µì…˜ ìƒì„± -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìƒì„± ì‹œê°„</label>
                        <input type="time" id="createTimeInput" value="09:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- ë§ˆê°ì¼ ì„¤ì • -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë§ˆê°ì¼ ì„¤ì •</label>
                        <select id="deadlineTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="none">ë§ˆê°ì¼ ì—†ìŒ</option>
                            <option value="same_day">ë‹¹ì¼ ë§ˆê°</option>
                            <option value="next_day">ë‹¤ìŒë‚  ë§ˆê°</option>
                            <option value="days_after">Nì¼ í›„ ë§ˆê°</option>
                        </select>
                    </div>
                    <div id="deadlineDaysContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë§ˆê°ê¹Œì§€ ì¼ìˆ˜</label>
                        <input type="number" id="deadlineDaysInput" value="1" min="1" max="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <!-- í™œì„± ê¸°ê°„ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì‹œì‘ì¼ *</label>
                        <input type="date" id="startDateInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì¢…ë£Œì¼ (ì„ íƒì‚¬í•­)</label>
                        <input type="date" id="endDateInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìƒíƒœ</label>
                        <select id="ruleStatusSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="active">í™œì„±</option>
                            <option value="inactive">ë¹„í™œì„±</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="confirmAddRuleBtn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">ìƒì„±</button>
                    <button id="cancelAddRuleBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
                </div>
            </div>

            <!-- ë°˜ë³µ ê·œì¹™ ëª©ë¡ -->
            <div id="recurringRulesList" class="space-y-3"></div>
            <div id="recurringEmpty" class="text-gray-500 text-center py-8">ë“±ë¡ëœ ë°˜ë³µ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <!-- ë©”ëª¨ì¥ ë·° -->
        <div id="memoView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">ë©”ëª¨ì¥</h2>
                <div class="flex gap-2">
                    <button id="saveMemoBtn" class="flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        <span>ğŸ’¾</span>
                        <span>ì €ì¥</span>
                    </button>
                    <button id="clearMemoBtn" class="flex items-center gap-2 px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                        <span>ğŸ—‘ï¸</span>
                        <span>ì „ì²´ ì‚­ì œ</span>
                    </button>
                </div>
            </div>
            <textarea id="memoTextarea" placeholder="ììœ ë¡­ê²Œ ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”..." class="w-full h-[600px] px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
            <div id="memoStatus" class="mt-2 text-sm text-gray-500"></div>
        </div>
    </div>

    <!-- í‘¸í„° -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-sm">Â© 2025 ê´‘ê³  í”„ë¡œì íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ | ì œì‘ì: ì´ì¬ê´‘</p>
        </div>
    </footer>

    <script>
        // âš ï¸ ì—¬ê¸°ì— ìƒˆë¡œìš´ Supabase URLê³¼ KEYë¥¼ ì…ë ¥í•˜ì„¸ìš” âš ï¸
        const SUPABASE_URL = 'https://tnnmmdrzscylsqbmkbnq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRubm1tZHJ6c2N5bHNxYm1rYm5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNTU4ODMsImV4cCI6MjA2OTkzMTg4M30.AQbxl7n_b-yLbC46X9F9kQI_AHOO9cmXtYSu9eUifvI';
        
        // ì „ì—­ ë³€ìˆ˜
        let supabase;
        let buckets = [];
        let recurringRules = [];
        let userId;
        let currentUser = null;
        let currentView = 'buckets';
        let sortOrder = 'asc';
        let collapsedBuckets = {};
        let collapsedContracts = {};
        let editingBucket = null;
        let editingAction = null;
        let editingRule = null;
        let showCompletedTodos = true;
        let showCompletedInBuckets = true;

        // DOM ìš”ì†Œë“¤
        let bucketsViewBtn, stageViewBtn, todoViewBtn, recurringViewBtn, memoViewBtn, addBucketSection, addBucketBtn, addBucketForm;
        let bucketNameInput, unitPriceInput, quantityInput, productInput, contractTermsInput;
        let confirmAddBtn, cancelAddBtn, sortBtn, sortText, loadingIndicator;
        let todayDeadlines, todayDeadlinesList, todoView, memoView, bucketsView, stageView, recurringView;
        let todoList, todoEmpty, todoSortBtn, todoSortText;
        let toggleCompletedBtn, toggleCompletedText, bucketsContainer, emptyState;
        let exportExcelBtn, toggleBucketCompletedBtn, toggleBucketCompletedText;
        let addTodoBtn, addTodoForm, todoBucketSelect, todoDeadlineInput, todoTextInput;
        let confirmAddTodoBtn, cancelAddTodoBtn, memoTextarea, saveMemoBtn, clearMemoBtn, memoStatus;
        
        // ì¸ì¦ ê´€ë ¨ DOM ìš”ì†Œë“¤
        let loginModal, loginUserId, loginPassword, signupUserId, signupPassword, signupName;
        let loginForm, signupForm, authStatus, userInfo, userName;
        
        // ë‹¨ê³„ë³„ ë·° DOM ìš”ì†Œë“¤
        let waitingStage, creativeStage, operationStage, settlementStage;
        let waitingCount, creativeCount, operationCount, settlementCount;

        // ë°˜ë³µ ê·œì¹™ DOM ìš”ì†Œë“¤
        let addRecurringRuleBtn, addRecurringForm, ruleNameInput, ruleBucketSelect, ruleActionInput;
        let repeatTypeSelect, weeklyDayContainer, weeklyDaySelect, monthlyDateContainer, monthlyDateSelect;
        let createTimeInput, deadlineTypeSelect, deadlineDaysContainer, deadlineDaysInput;
        let startDateInput, endDateInput, ruleStatusSelect, confirmAddRuleBtn, cancelAddRuleBtn;
        let recurringRulesList, recurringEmpty;

        // ì•± ì´ˆê¸°í™”
        async function initApp() {
            try {
                console.log('ì•± ì´ˆê¸°í™” ì‹œì‘');
                
                // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // DOM ìš”ì†Œ ì´ˆê¸°í™”
                initializeElements();
                initializeAuthElements();
                initializeStageElements();
                initializeRecurringElements();
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                setupEventListeners();
                setupAuthEventListeners();
                setupRecurringEventListeners();
                
                // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
                await checkAuthStatus();
                
                console.log('ì•± ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('ì•± ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // DOM ìš”ì†Œ ì´ˆê¸°í™”
        function initializeElements() {
            bucketsViewBtn = document.getElementById('bucketsViewBtn');
            stageViewBtn = document.getElementById('stageViewBtn');
            todoViewBtn = document.getElementById('todoViewBtn');
            recurringViewBtn = document.getElementById('recurringViewBtn');
            memoViewBtn = document.getElementById('memoViewBtn');
            addBucketSection = document.getElementById('addBucketSection');
            addBucketBtn = document.getElementById('addBucketBtn');
            addBucketForm = document.getElementById('addBucketForm');
            bucketNameInput = document.getElementById('bucketNameInput');
            unitPriceInput = document.getElementById('unitPriceInput');
            quantityInput = document.getElementById('quantityInput');
            productInput = document.getElementById('productInput');
            contractTermsInput = document.getElementById('contractTermsInput');
            confirmAddBtn = document.getElementById('confirmAddBtn');
            cancelAddBtn = document.getElementById('cancelAddBtn');
            sortBtn = document.getElementById('sortBtn');
            sortText = document.getElementById('sortText');
            loadingIndicator = document.getElementById('loadingIndicator');
            todayDeadlines = document.getElementById('todayDeadlines');
            todayDeadlinesList = document.getElementById('todayDeadlinesList');
            todoView = document.getElementById('todoView');
            memoView = document.getElementById('memoView');
            bucketsView = document.getElementById('bucketsView');
            stageView = document.getElementById('stageView');
            recurringView = document.getElementById('recurringView');
            todoList = document.getElementById('todoList');
            todoEmpty = document.getElementById('todoEmpty');
            todoSortBtn = document.getElementById('todoSortBtn');
            todoSortText = document.getElementById('todoSortText');
            toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
            toggleCompletedText = document.getElementById('toggleCompletedText');
            bucketsContainer = document.getElementById('bucketsContainer');
            emptyState = document.getElementById('emptyState');
            exportExcelBtn = document.getElementById('exportExcelBtn');
            toggleBucketCompletedBtn = document.getElementById('toggleBucketCompletedBtn');
            toggleBucketCompletedText = document.getElementById('toggleBucketCompletedText');
            addTodoBtn = document.getElementById('addTodoBtn');
            addTodoForm = document.getElementById('addTodoForm');
            todoBucketSelect = document.getElementById('todoBucketSelect');
            todoDeadlineInput = document.getElementById('todoDeadlineInput');
            todoTextInput = document.getElementById('todoTextInput');
            confirmAddTodoBtn = document.getElementById('confirmAddTodoBtn');
            cancelAddTodoBtn = document.getElementById('cancelAddTodoBtn');
            memoTextarea = document.getElementById('memoTextarea');
            saveMemoBtn = document.getElementById('saveMemoBtn');
            clearMemoBtn = document.getElementById('clearMemoBtn');
            memoStatus = document.getElementById('memoStatus');
        }

        // ì¸ì¦ ê´€ë ¨ DOM ìš”ì†Œ ì´ˆê¸°í™”
        function initializeAuthElements() {
            loginModal = document.getElementById('loginModal');
            loginUserId = document.getElementById('loginUserId');
            loginPassword = document.getElementById('loginPassword');
            signupUserId = document.getElementById('signupUserId');
            signupPassword = document.getElementById('signupPassword');
            signupName = document.getElementById('signupName');
            loginForm = document.getElementById('loginForm');
            signupForm = document.getElementById('signupForm');
            authStatus = document.getElementById('authStatus');
            userInfo = document.getElementById('userInfo');
            userName = document.getElementById('userName');
        }

        // ë‹¨ê³„ë³„ ë·° DOM ìš”ì†Œ ì´ˆê¸°í™”
        function initializeStageElements() {
            waitingStage = document.getElementById('waitingStage');
            creativeStage = document.getElementById('creativeStage');
            operationStage = document.getElementById('operationStage');
            settlementStage = document.getElementById('settlementStage');
            waitingCount = document.getElementById('waitingCount');
            creativeCount = document.getElementById('creativeCount');
            operationCount = document.getElementById('operationCount');
            settlementCount = document.getElementById('settlementCount');
        }

        // ë°˜ë³µ ê·œì¹™ DOM ìš”ì†Œ ì´ˆê¸°í™”
        function initializeRecurringElements() {
            addRecurringRuleBtn = document.getElementById('addRecurringRuleBtn');
            addRecurringForm = document.getElementById('addRecurringForm');
            ruleNameInput = document.getElementById('ruleNameInput');
            ruleBucketSelect = document.getElementById('ruleBucketSelect');
            ruleActionInput = document.getElementById('ruleActionInput');
            repeatTypeSelect = document.getElementById('repeatTypeSelect');
            weeklyDayContainer = document.getElementById('weeklyDayContainer');
            weeklyDaySelect = document.getElementById('weeklyDaySelect');
            monthlyDateContainer = document.getElementById('monthlyDateContainer');
            monthlyDateSelect = document.getElementById('monthlyDateSelect');
            createTimeInput = document.getElementById('createTimeInput');
            deadlineTypeSelect = document.getElementById('deadlineTypeSelect');
            deadlineDaysContainer = document.getElementById('deadlineDaysContainer');
            deadlineDaysInput = document.getElementById('deadlineDaysInput');
            startDateInput = document.getElementById('startDateInput');
            endDateInput = document.getElementById('endDateInput');
            ruleStatusSelect = document.getElementById('ruleStatusSelect');
            confirmAddRuleBtn = document.getElementById('confirmAddRuleBtn');
            cancelAddRuleBtn = document.getElementById('cancelAddRuleBtn');
            recurringRulesList = document.getElementById('recurringRulesList');
            recurringEmpty = document.getElementById('recurringEmpty');

            // ì›”ë³„ ë‚ ì§œ ì˜µì…˜ ìƒì„±
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i}ì¼`;
                monthlyDateSelect.appendChild(option);
            }

            // ê¸°ë³¸ê°’ ì„¤ì •
            const today = new Date();
            startDateInput.value = today.toISOString().split('T')[0];
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        function setupEventListeners() {
            bucketsViewBtn.addEventListener('click', () => switchView('buckets'));
            stageViewBtn.addEventListener('click', () => switchView('stage'));
            todoViewBtn.addEventListener('click', () => switchView('todo'));
            recurringViewBtn.addEventListener('click', () => switchView('recurring'));
            memoViewBtn.addEventListener('click', () => switchView('memo'));
            addBucketBtn.addEventListener('click', showAddForm);
            confirmAddBtn.addEventListener('click', addBucket);
            cancelAddBtn.addEventListener('click', hideAddForm);
            sortBtn.addEventListener('click', toggleSort);
            todoSortBtn.addEventListener('click', toggleTodoSort);
            toggleCompletedBtn.addEventListener('click', toggleCompletedVisibility);
            toggleBucketCompletedBtn.addEventListener('click', toggleBucketCompletedVisibility);
            exportExcelBtn.addEventListener('click', exportToExcel);
            addTodoBtn.addEventListener('click', showAddTodoForm);
            confirmAddTodoBtn.addEventListener('click', addTodoItem);
            cancelAddTodoBtn.addEventListener('click', hideAddTodoForm);
            saveMemoBtn.addEventListener('click', saveMemo);
            clearMemoBtn.addEventListener('click', clearMemo);

            bucketNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addBucket();
                }
            });
            
            todoTextInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addTodoItem();
                }
            });

            // ë©”ëª¨ ìë™ì €ì¥
            memoTextarea.addEventListener('input', autoSaveMemo);
        }

        // ì¸ì¦ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        function setupAuthEventListeners() {
            loginUserId.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginPassword.focus();
            });
            
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            signupUserId.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signupPassword.focus();
            });
            
            signupPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signupName.focus();
            });
            
            signupName.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSignup();
            });
        }

        // ë°˜ë³µ ê·œì¹™ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        function setupRecurringEventListeners() {
            addRecurringRuleBtn.addEventListener('click', showAddRecurringForm);
            confirmAddRuleBtn.addEventListener('click', addRecurringRule);
            cancelAddRuleBtn.addEventListener('click', hideAddRecurringForm);

            repeatTypeSelect.addEventListener('change', function() {
                weeklyDayContainer.classList.add('hidden');
                monthlyDateContainer.classList.add('hidden');
                
                if (this.value === 'weekly') {
                    weeklyDayContainer.classList.remove('hidden');
                } else if (this.value === 'monthly') {
                    monthlyDateContainer.classList.remove('hidden');
                }
            });

            deadlineTypeSelect.addEventListener('change', function() {
                if (this.value === 'days_after') {
                    deadlineDaysContainer.classList.remove('hidden');
                } else {
                    deadlineDaysContainer.classList.add('hidden');
                }
            });

            ruleNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addRecurringRule();
                }
            });
        }

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        async function checkAuthStatus() {
            const savedAuth = localStorage.getItem('userAuth');
            if (savedAuth) {
                try {
                    const authData = JSON.parse(savedAuth);
                    
                    const { data: userData, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('user_id', authData.userId)
                        .eq('password_hash', authData.passwordHash)
                        .single();

                    if (!error && userData) {
                        currentUser = userData;
                        userId = userData.user_id;
                        userName.textContent = userData.name;
                        userInfo.classList.remove('hidden');
                        hideLoginModal();
                        await loadData();
                        updateTodayDeadlines();
                        startRecurringCheck();
                        return;
                    }
                } catch (error) {
                    console.log('ì €ì¥ëœ ì¸ì¦ ì •ë³´ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            }
            
            showLoginModal();
        }

        // ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
        function showLoginModal() {
            loginModal.classList.remove('hidden');
            loginUserId.focus();
        }

        function hideLoginModal() {
            loginModal.classList.add('hidden');
        }

        // í¼ ì „í™˜
        function showSignupForm() {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
            signupUserId.focus();
        }

        function showLoginForm() {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            loginUserId.focus();
        }

        // ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        async function handleLogin() {
            const userIdValue = loginUserId.value.trim();
            const passwordValue = loginPassword.value.trim();
            
            if (!userIdValue || !passwordValue) {
                authStatus.textContent = 'ì‚¬ìš©ì IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
                return;
            }
            
            try {
                authStatus.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
                authStatus.className = 'mt-4 text-sm text-center text-blue-600';
                
                const passwordHash = simpleHash(passwordValue);
                
                const { data: userData, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('user_id', userIdValue)
                    .eq('password_hash', passwordHash)
                    .single();

                if (error || !userData) {
                    authStatus.textContent = 'ì‚¬ìš©ì ID ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    authStatus.className = 'mt-4 text-sm text-center text-red-600';
                    return;
                }
                
                currentUser = userData;
                userId = userData.user_id;
                userName.textContent = userData.name;
                userInfo.classList.remove('hidden');
                
                localStorage.setItem('userAuth', JSON.stringify({
                    userId: userData.user_id,
                    passwordHash: passwordHash,
                    name: userData.name
                }));
                
                authStatus.textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${userData.name}ë‹˜!`;
                authStatus.className = 'mt-4 text-sm text-center text-green-600';
                
                setTimeout(async () => {
                    hideLoginModal();
                    await loadData();
                    updateTodayDeadlines();
                    startRecurringCheck();
                    showSuccess(`${userData.name}ë‹˜, ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                }, 1000);
                
            } catch (error) {
                console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                authStatus.textContent = 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
            }
        }

        // íšŒì›ê°€ì… ì²˜ë¦¬
        async function handleSignup() {
            const userIdValue = signupUserId.value.trim();
            const passwordValue = signupPassword.value.trim();
            const nameValue = signupName.value.trim();
            
            if (!userIdValue || !passwordValue || !nameValue) {
                authStatus.textContent = 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
                return;
            }
            
            if (userIdValue.length < 3) {
                authStatus.textContent = 'ì‚¬ìš©ì IDëŠ” 3ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
                return;
            }
            
            if (passwordValue.length < 4) {
                authStatus.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
                return;
            }
            
            try {
                authStatus.textContent = 'íšŒì›ê°€ì… ì¤‘...';
                authStatus.className = 'mt-4 text-sm text-center text-blue-600';
                
                const { data: existingUser } = await supabase
                    .from('users')
                    .select('user_id')
                    .eq('user_id', userIdValue)
                    .single();

                if (existingUser) {
                    authStatus.textContent = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì‚¬ìš©ì IDì…ë‹ˆë‹¤.';
                    authStatus.className = 'mt-4 text-sm text-center text-red-600';
                    return;
                }
                
                const passwordHash = simpleHash(passwordValue);
                
                const { data: newUser, error } = await supabase
                    .from('users')
                    .insert([{
                        user_id: userIdValue,
                        password_hash: passwordHash,
                        name: nameValue,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();

                if (error) {
                    throw error;
                }
                
                authStatus.textContent = 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.';
                authStatus.className = 'mt-4 text-sm text-center text-green-600';
                
                setTimeout(() => {
                    signupUserId.value = '';
                    signupPassword.value = '';
                    signupName.value = '';
                    loginUserId.value = userIdValue;
                    showLoginForm();
                    authStatus.textContent = '';
                }, 2000);
                
            } catch (error) {
                console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
                authStatus.textContent = 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                authStatus.className = 'mt-4 text-sm text-center text-red-600';
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if (confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('userAuth');
                currentUser = null;
                userId = null;
                buckets = [];
                recurringRules = [];
                userInfo.classList.add('hidden');
                showLoginModal();
                
                loginUserId.value = '';
                loginPassword.value = '';
                authStatus.textContent = '';
            }
        }

        // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
        function showLoading() {
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg';
            errorDiv.innerHTML = `
                <h3 class="font-semibold mb-2">âš ï¸ ì˜¤ë¥˜ ë°œìƒ</h3>
                <p class="text-sm">${message}</p>
                <button onclick="location.reload()" class="mt-2 px-3 py-1 bg-red-600 text-white rounded text-xs">ìƒˆë¡œê³ ì¹¨</button>
            `;
            document.getElementById('app').insertBefore(errorDiv, document.getElementById('app').firstChild);
        }

        // ì„±ê³µ ì•Œë¦¼
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                console.log('Supabaseì—ì„œ ë°ì´í„° ë¡œë“œ ì‹œì‘');
                showLoading();
                
                const { data: bucketsData, error: bucketsError } = await supabase
                    .from('buckets')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                if (bucketsError) {
                    throw new Error(`ë²„í‚· ë¡œë“œ ì˜¤ë¥˜: ${bucketsError.message}`);
                }

                let actionsData = [];
                if (bucketsData.length > 0) {
                    const { data: actions, error: actionsError } = await supabase
                        .from('actions')
                        .select('*')
                        .in('bucket_id', bucketsData.map(b => b.id))
                        .order('order_index', { ascending: true });

                    if (actionsError) {
                        throw new Error(`ì•¡ì…˜ ë¡œë“œ ì˜¤ë¥˜: ${actionsError.message}`);
                    }
                    actionsData = actions;
                }

                const { data: rulesData, error: rulesError } = await supabase
                    .from('recurring_rules')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                if (rulesError) {
                    console.error('ë°˜ë³µ ê·œì¹™ ë¡œë“œ ì˜¤ë¥˜:', rulesError);
                } else {
                    recurringRules = rulesData;
                }

                buckets = bucketsData.map(bucket => ({
                    ...bucket,
                    actions: actionsData.filter(action => action.bucket_id === bucket.id)
                }));

                console.log('ë¡œë“œëœ ë²„í‚· ìˆ˜:', buckets.length);
                console.log('ë¡œë“œëœ ë°˜ë³µ ê·œì¹™ ìˆ˜:', recurringRules.length);
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                } else if (currentView === 'todo') {
                    renderTodoView();
                } else if (currentView === 'recurring') {
                    renderRecurringView();
                }

                hideLoading();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                hideLoading();
                showError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                buckets = [];
                renderBuckets();
            }
        }

        // ë·° ì „í™˜
        function switchView(view) {
            currentView = view;
            
            bucketsViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            stageViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            todoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            recurringViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            memoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            
            addBucketSection.classList.add('hidden');
            todoView.classList.add('hidden');
            memoView.classList.add('hidden');
            bucketsView.classList.add('hidden');
            stageView.classList.add('hidden');
            recurringView.classList.add('hidden');
            
            if (view === 'buckets') {
                bucketsViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                addBucketSection.classList.remove('hidden');
                bucketsView.classList.remove('hidden');
                renderBuckets();
            } else if (view === 'stage') {
                stageViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                stageView.classList.remove('hidden');
                renderStageView();
            } else if (view === 'todo') {
                todoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                todoView.classList.remove('hidden');
                renderTodoView();
                updateTodoBucketSelect();
            } else if (view === 'recurring') {
                recurringViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-purple-500 text-purple-600';
                recurringView.classList.remove('hidden');
                renderRecurringView();
                updateRuleBucketSelect();
            } else if (view === 'memo') {
                memoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                memoView.classList.remove('hidden');
                loadMemo();
            }
        }

        // ë‹¨ê³„ë³„ ë·° ë Œë”ë§
        function renderStageView() {
            const stageMap = {
                'ëŒ€ê¸°': [],
                'ì§„í–‰_ê´‘ê³ ì œì‘': [],
                'ì§„í–‰_ê´‘ê³ ìš´ì˜': [],
                'ì§„í–‰_ë§¤ì¶œì •ì‚°': []
            };

            buckets.forEach(bucket => {
                const stage = bucket.stage || 'ëŒ€ê¸°';
                if (stageMap[stage]) {
                    stageMap[stage].push(bucket);
                }
            });

            renderStageColumn('ëŒ€ê¸°', stageMap['ëŒ€ê¸°'], waitingStage, waitingCount);
            renderStageColumn('ì§„í–‰_ê´‘ê³ ì œì‘', stageMap['ì§„í–‰_ê´‘ê³ ì œì‘'], creativeStage, creativeCount);
            renderStageColumn('ì§„í–‰_ê´‘ê³ ìš´ì˜', stageMap['ì§„í–‰_ê´‘ê³ ìš´ì˜'], operationStage, operationCount);
            renderStageColumn('ì§„í–‰_ë§¤ì¶œì •ì‚°', stageMap['ì§„í–‰_ë§¤ì¶œì •ì‚°'], settlementStage, settlementCount);
        }

        // ë‹¨ê³„ë³„ ì»¬ëŸ¼ ë Œë”ë§
        function renderStageColumn(stage, stageBuckets, container, countElement) {
            countElement.textContent = stageBuckets.length;
            
            container.className = 'p-4 space-y-3 min-h-[400px] drop-zone';
            container.setAttribute('data-stage', stage);
            
            if (stageBuckets.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-8 pointer-events-none">í•´ë‹¹ ë‹¨ê³„ì˜ ê´‘ê³ ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br><span class="text-xs">ë‹¤ë¥¸ ë‹¨ê³„ì—ì„œ ë“œë˜ê·¸í•´ì„œ ì´ë™í•˜ì„¸ìš”.</span></p>';
            } else {
                container.innerHTML = stageBuckets.map(bucket => {
                    const incompleteActions = (bucket.actions || []).filter(action => !action.completed).length;
                    const totalActions = (bucket.actions || []).length;
                    
                    return `
                        <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 hover:border-blue-300 transition-all cursor-move bucket-card"
                             draggable="true"
                             data-bucket-id="${bucket.id}"
                             data-current-stage="${stage}"
                             onclick="switchToBucketView(${bucket.id})">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-400 text-xs cursor-move">â‹®â‹®</span>
                                    <h4 class="font-medium text-gray-800 text-sm">${bucket.name}</h4>
                                </div>
                                <button onclick="event.stopPropagation(); changeStageInStageView(${bucket.id}, event)" 
                                        class="text-gray-400 hover:text-gray-600 text-xs">
                                    ğŸ“
                                </button>
                            </div>
                            
                            ${bucket.unit_price || bucket.quantity || bucket.product ? `
                                <div class="text-xs text-gray-500 mb-2">
                                    ${bucket.unit_price ? `${bucket.unit_price}ì›` : ''}
                                    ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                    ${bucket.quantity ? `${bucket.quantity}` : ''}
                                    ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                    ${bucket.product ? `${bucket.product}` : ''}
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-gray-600">
                                    ì•¡ì…˜: ${totalActions - incompleteActions}/${totalActions}
                                </span>
                                <div class="w-16 bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-500 h-2 rounded-full" 
                                         style="width: ${totalActions > 0 ? ((totalActions - incompleteActions) / totalActions * 100) : 0}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            setupDragAndDropEvents(container);
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì„¤ì •
        function setupDragAndDropEvents(container) {
            container.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('bucket-card')) {
                    e.target.style.opacity = '0.5';
                    e.dataTransfer.setData('text/plain', e.target.dataset.bucketId);
                    e.dataTransfer.setData('source-stage', e.target.dataset.currentStage);
                    
                    document.querySelectorAll('.drop-zone').forEach(zone => {
                        zone.classList.add('drag-active');
                    });
                }
            });

            container.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('bucket-card')) {
                    e.target.style.opacity = '1';
                    
                    document.querySelectorAll('.drop-zone').forEach(zone => {
                        zone.classList.remove('drag-active', 'drag-over');
                    });
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                container.classList.add('drag-over');
            });

            container.addEventListener('dragleave', (e) => {
                if (!container.contains(e.relatedTarget)) {
                    container.classList.remove('drag-over');
                }
            });

            container.addEventListener('drop', async (e) => {
                e.preventDefault();
                
                const bucketId = parseInt(e.dataTransfer.getData('text/plain'));
                const sourceStage = e.dataTransfer.getData('source-stage');
                const targetStage = container.dataset.stage;
                
                if (sourceStage === targetStage) {
                    container.classList.remove('drag-over');
                    return;
                }
                
                await moveToStage(bucketId, targetStage);
                
                container.classList.remove('drag-over');
            });
        }

        // ë‹¨ê³„ ì´ë™ (ì•¡ì…˜ì•„ì´í…œ ìë™ ìƒì„± ì œê±°)
        async function moveToStage(bucketId, newStage) {
            try {
                showLoading();
                
                const { error: bucketError } = await supabase
                    .from('buckets')
                    .update({ stage: newStage })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (bucketError) {
                    throw new Error(`ë‹¨ê³„ ë³€ê²½ ì˜¤ë¥˜: ${bucketError.message}`);
                }

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket.stage = newStage;
                }
                
                hideLoading();
                renderStageView();
                
                const stageNames = {
                    'ëŒ€ê¸°': 'ëŒ€ê¸°',
                    'ì§„í–‰_ê´‘ê³ ì œì‘': 'ê´‘ê³ ì œì‘',
                    'ì§„í–‰_ê´‘ê³ ìš´ì˜': 'ê´‘ê³ ìš´ì˜',
                    'ì§„í–‰_ë§¤ì¶œì •ì‚°': 'ë§¤ì¶œì •ì‚°'
                };
                
                showSuccess(`${bucket?.name || 'ê´‘ê³ ì£¼'}ê°€ ${stageNames[newStage]} ë‹¨ê³„ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } catch (error) {
                console.error('ë‹¨ê³„ ë³€ê²½ ì˜¤ë¥˜:', error);
                hideLoading();
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                renderStageView();
            }
        }

        async function updateStageFromSelect(bucketId, newStage) {
            await moveToStage(bucketId, newStage);
        }

        function switchToBucketView(bucketId) {
            switchView('buckets');
        }

        function changeStageInStageView(bucketId, event) {
            event.stopPropagation();
            
            const stages = [
                { value: 'ëŒ€ê¸°', text: 'â³ ëŒ€ê¸°' },
                { value: 'ì§„í–‰_ê´‘ê³ ì œì‘', text: 'ğŸ¨ ê´‘ê³ ì œì‘' },
                { value: 'ì§„í–‰_ê´‘ê³ ìš´ì˜', text: 'ğŸ“ˆ ê´‘ê³ ìš´ì˜' },
                { value: 'ì§„í–‰_ë§¤ì¶œì •ì‚°', text: 'ğŸ’° ë§¤ì¶œì •ì‚°' }
            ];
            
            const currentBucket = buckets.find(b => b.id === bucketId);
            const currentStage = currentBucket?.stage || 'ëŒ€ê¸°';
            
            const stageOptions = stages.map(stage => 
                `<option value="${stage.value}" ${stage.value === currentStage ? 'selected' : ''}>${stage.text}</option>`
            ).join('');
            
            const selectHtml = `
                <select onchange="updateStageFromSelect(${bucketId}, this.value)" 
                        class="text-xs border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    ${stageOptions}
                </select>
            `;
            
            event.target.closest('.bg-gray-50').innerHTML += selectHtml;
        }

        // ì •ë ¬ í† ê¸€
        function toggleSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            sortText.textContent = `ë§ˆê°ì¼ ${sortOrder === 'asc' ? 'ì˜¤ë¦„ì°¨ìˆœ' : 'ë‚´ë¦¼ì°¨ìˆœ'}`;
            if (currentView === 'buckets') {
                renderBuckets();
            }
        }

        function toggleTodoSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            todoSortText.textContent = `ë§ˆê°ì¼ ${sortOrder === 'asc' ? 'ì˜¤ë¦„ì°¨ìˆœ' : 'ë‚´ë¦¼ì°¨ìˆœ'}`;
            if (currentView === 'todo') {
                renderTodoView();
            }
        }

        // ì™„ë£Œëœ íˆ¬ë‘ ê°€ì‹œì„± í† ê¸€
        function toggleCompletedVisibility() {
            showCompletedTodos = !showCompletedTodos;
            
            if (showCompletedTodos) {
                toggleCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm';
                toggleCompletedText.textContent = 'ì™„ë£Œí•­ëª© ìˆ¨ê¸°ê¸°';
            } else {
                toggleCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm';
                toggleCompletedText.textContent = 'ì™„ë£Œí•­ëª© ë³´ê¸°';
            }
            
            if (currentView === 'todo') {
                renderTodoView();
            }
        }

        function toggleBucketCompletedVisibility() {
            showCompletedInBuckets = !showCompletedInBuckets;
            
            if (showCompletedInBuckets) {
                toggleBucketCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm';
                toggleBucketCompletedText.textContent = 'ì™„ë£Œí•­ëª© ìˆ¨ê¸°ê¸°';
            } else {
                toggleBucketCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm';
                toggleBucketCompletedText.textContent = 'ì™„ë£Œí•­ëª© ë³´ê¸°';
            }
            
            if (currentView === 'buckets') {
                renderBuckets();
            }
        }

        // ì˜¤ëŠ˜ ë§ˆê° ì—…ë°ì´íŠ¸
        function updateTodayDeadlines() {
            const today = new Date().toISOString().split('T')[0];
            const todayItems = [];
            
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    if (action.deadline === today && !action.completed) {
                        todayItems.push({
                            bucketName: bucket.name,
                            actionText: action.text
                        });
                    }
                });
            });

            if (todayItems.length > 0) {
                todayDeadlinesList.innerHTML = todayItems.map(item => 
                    `<p class="text-red-600 text-sm">â€¢ [${item.bucketName}] ${item.actionText}</p>`
                ).join('');
                todayDeadlines.classList.remove('hidden');
            } else {
                todayDeadlines.classList.add('hidden');
            }
        }

        // ì¶”ê°€ í¼ ê´€ë ¨
        function showAddForm() {
            addBucketForm.classList.remove('hidden');
            bucketNameInput.focus();
        }

        function hideAddForm() {
            addBucketForm.classList.add('hidden');
            bucketNameInput.value = '';
            unitPriceInput.value = '';
            quantityInput.value = '';
            productInput.value = '';
            contractTermsInput.value = '';
        }

        // ìƒˆ ë²„í‚· ì¶”ê°€ (ì•¡ì…˜ì•„ì´í…œ ìë™ ìƒì„± ì œê±°)
        async function addBucket() {
            const name = bucketNameInput.value.trim();
            if (!name) {
                alert('ê´‘ê³ ì£¼ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            try {
                showLoading();

                const bucketData = {
                    user_id: userId,
                    name: name,
                    stage: 'ëŒ€ê¸°',
                    unit_price: unitPriceInput.value.trim(),
                    quantity: quantityInput.value.trim(),
                    product: productInput.value.trim(),
                    contract_terms: contractTermsInput.value.trim()
                };

                const { data: newBucket, error: bucketError } = await supabase
                    .from('buckets')
                    .insert([bucketData])
                    .select()
                    .single();

                if (bucketError) {
                    throw new Error(`ë²„í‚· ìƒì„± ì˜¤ë¥˜: ${bucketError.message}`);
                }

                newBucket.actions = [];
                buckets.unshift(newBucket);
                
                hideLoading();
                hideAddForm();
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                }
                
                updateTodayDeadlines();
                showSuccess('ìƒˆ ê´‘ê³ ì£¼ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
            } catch (error) {
                console.error('ë²„í‚· ì¶”ê°€ ì˜¤ë¥˜:', error);
                hideLoading();
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì•¡ì…˜ ì•„ì´í…œ ì •ë ¬
        function getSortedActions(actions) {
            const incompleteActions = actions.filter(action => !action.completed);
            const completedActions = actions.filter(action => action.completed);
            
            const sortedIncomplete = incompleteActions.sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return sortOrder === 'asc' ? 1 : -1;
                if (!b.deadline) return sortOrder === 'asc' ? -1 : 1;
                
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            const sortedCompleted = completedActions.sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return sortOrder === 'asc' ? 1 : -1;
                if (!b.deadline) return sortOrder === 'asc' ? -1 : 1;
                
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            return [...sortedIncomplete, ...sortedCompleted];
        }

        // íˆ¬ë‘ë·° ë Œë”ë§
        function renderTodoView() {
            const allItems = [];
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    allItems.push({
                        ...action,
                        bucketName: bucket.name,
                        bucketId: bucket.id,
                        bucketStage: bucket.stage
                    });
                });
            });

            let filteredItems = allItems;
            if (!showCompletedTodos) {
                filteredItems = allItems.filter(item => !item.completed);
            }

            const sortedItems = getSortedActions(filteredItems);

            if (sortedItems.length === 0) {
                todoList.classList.add('hidden');
                todoEmpty.classList.remove('hidden');
                return;
            }

            todoList.classList.remove('hidden');
            todoEmpty.classList.add('hidden');

            todoList.innerHTML = sortedItems.map(action => {
                const today = new Date().toISOString().split('T')[0];
                const isToday = action.deadline === today && !action.completed;
                const isRecurring = action.recurring_rule_id ? 'ğŸ”„ ' : '';
                
                return `
                    <div class="flex items-center justify-between p-3 rounded-lg border ${action.completed ? 'bg-gray-50 border-gray-200' : 'bg-white border-gray-200'}">
                        <div class="flex items-center gap-3 flex-1">
                            <button onclick="toggleActionItem(${action.bucketId}, ${action.id})" class="flex-shrink-0 text-lg">
                                ${action.completed ? 'âœ…' : 'â­•'}
                            </button>
                            <div class="flex-1">
                                <p class="text-sm font-medium ${action.completed ? 'line-through text-gray-500' : 'text-gray-800'}">
                                    ${isRecurring}${action.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                                </p>
                                <p class="text-xs ${action.completed ? 'text-gray-400' : 'text-gray-500'}">
                                    [${action.bucketName}] - ${action.bucketStage}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="date" value="${action.deadline || ''}" onchange="setDeadline(${action.bucketId}, ${action.id}, this.value)" class="px-2 py-1 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${isToday ? 'border-red-500 bg-red-50' : 'border-gray-200'} ${action.completed ? 'text-gray-400' : ''}"/>
                            <button onclick="deleteActionItem(${action.bucketId}, ${action.id})" class="text-red-500 hover:text-red-700">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ë²„í‚· ëª©ë¡ ë Œë”ë§
        function renderBuckets() {
            if (buckets.length === 0) {
                emptyState.classList.remove('hidden');
                bucketsContainer.innerHTML = '';
                return;
            }

            emptyState.classList.add('hidden');
            bucketsContainer.innerHTML = '';

            buckets.forEach(bucket => {
                const bucketElement = createBucketElement(bucket);
                bucketsContainer.appendChild(bucketElement);
            });
        }

        // ë²„í‚· ìš”ì†Œ ìƒì„±
        function createBucketElement(bucket) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-md p-4';

            const actions = bucket.actions || [];
            const sortedActions = getSortedActions(actions);
            const isCollapsed = collapsedBuckets[bucket.id] === true;
            const isContractCollapsed = collapsedContracts[bucket.id] === true;

            div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <button onclick="toggleBucketCollapse(${bucket.id})" class="text-gray-600 hover:text-gray-800">
                                ${isCollapsed ? 'â–¶' : 'â–¼'}
                            </button>
                            ${editingBucket === bucket.id ? `
                                <input type="text" value="${bucket.name.replace(/"/g, '&quot;')}" 
                                       onkeypress="if(event.key==='Enter') saveEditBucket(${bucket.id}, this.value); if(event.key==='Escape') cancelEditBucket();"
                                       onblur="saveEditBucket(${bucket.id}, this.value)"
                                       class="flex-1 px-2 py-1 text-sm font-semibold border border-blue-500 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                       autofocus />
                                <button onclick="cancelEditBucket()" class="text-red-500 hover:text-red-700 text-sm">âœ•</button>
                            ` : `
                                <h3 class="text-sm font-semibold text-gray-800 flex-1">${bucket.name}</h3>
                                <button onclick="startEditBucket(${bucket.id})" class="text-gray-400 hover:text-gray-600 text-sm">âœï¸</button>
                            `}
                        </div>
                    </div>
                    <button onclick="deleteBucket(${bucket.id})" class="text-red-500 hover:text-red-700 text-sm">
                        ğŸ—‘ï¸
                    </button>
                </div>

                ${!isCollapsed ? `
                    <!-- ë‹¨ê³„ ì„ íƒ -->
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-700 mb-1">ë‹¨ê³„</label>
                        <select onchange="changeStage(${bucket.id}, this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="ëŒ€ê¸°" ${bucket.stage === 'ëŒ€ê¸°' ? 'selected' : ''}>ëŒ€ê¸°</option>
                            <option value="ì§„í–‰_ê´‘ê³ ì œì‘" ${bucket.stage === 'ì§„í–‰_ê´‘ê³ ì œì‘' ? 'selected' : ''}>ì§„í–‰_ê´‘ê³ ì œì‘</option>
                            <option value="ì§„í–‰_ê´‘ê³ ìš´ì˜" ${bucket.stage === 'ì§„í–‰_ê´‘ê³ ìš´ì˜' ? 'selected' : ''}>ì§„í–‰_ê´‘ê³ ìš´ì˜</option>
                            <option value="ì§„í–‰_ë§¤ì¶œì •ì‚°" ${bucket.stage === 'ì§„í–‰_ë§¤ì¶œì •ì‚°' ? 'selected' : ''}>ì§„í–‰_ë§¤ì¶œì •ì‚°</option>
                        </select>
                    </div>

                    <!-- ê³„ì•½ ì •ë³´ -->
                    <div class="mb-3 p-3 bg-gray-50 rounded">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs font-medium text-gray-700">ê³„ì•½ ì •ë³´</h4>
                            <button onclick="toggleContractCollapse(${bucket.id})" class="text-gray-600 hover:text-gray-800">
                                ${isContractCollapsed ? 'â–¶' : 'â–¼'}
                            </button>
                        </div>
                        
                        ${!isContractCollapsed ? `
                            <div class="grid grid-cols-1 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ë‹¨ê°€ (ì›)</label>
                                    <input type="text" value="${bucket.unit_price || ''}" onchange="updateBucketInfo(${bucket.id}, 'unit_price', this.value)" placeholder="ì˜ˆ: 1,000,000" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"/>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ìˆ˜ëŸ‰</label>
                                    <input type="text" value="${bucket.quantity || ''}" onchange="updateBucketInfo(${bucket.id}, 'quantity', this.value)" placeholder="ì˜ˆ: 100íšŒ ë…¸ì¶œ" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"/>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ìƒí’ˆ</label>
                                    <select onchange="updateBucketInfo(${bucket.id}, 'product', this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">ì„ íƒ</option>
                                        <option value="CPM" ${bucket.product === 'CPM' ? 'selected' : ''}>CPM</option>
                                        <option value="CPA" ${bucket.product === 'CPA' ? 'selected' : ''}>CPA</option>
                                        <option value="CPA+" ${bucket.product === 'CPA+' ? 'selected' : ''}>CPA+</option>
                                        <option value="CPR" ${bucket.product === 'CPR' ? 'selected' : ''}>CPR</option>
                                        <option value="CPR+" ${bucket.product === 'CPR+' ? 'selected' : ''}>CPR+</option>
                                        <option value="CPS" ${bucket.product === 'CPS' ? 'selected' : ''}>CPS</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ê³„ì•½ì¡°ê±´</label>
                                    <textarea onchange="updateBucketInfo(${bucket.id}, 'contract_terms', this.value)" placeholder="ê³„ì•½ ì¡°ê±´..." rows="2" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none">${bucket.contract_terms || ''}</textarea>
                                </div>
                            </div>
                        ` : `
                            ${(bucket.unit_price || bucket.quantity || bucket.product) ? `
                                <div class="text-xs text-gray-500">
                                    ${bucket.unit_price ? `${bucket.unit_price}ì›` : ''}
                                    ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                    ${bucket.quantity ? `${bucket.quantity}` : ''}
                                    ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                    ${bucket.product ? `${bucket.product}` : ''}
                                </div>
                            ` : ''}
                        `}
                    </div>

                    <!-- ì•¡ì…˜ ì•„ì´í…œ -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xs font-medium text-gray-700">ì•¡ì…˜ ì•„ì´í…œ</h4>
                            <button onclick="addCustomAction(${bucket.id})" class="text-blue-600 hover:text-blue-800 text-xs">
                                â•
                            </button>
                        </div>
                        
                        ${sortedActions.length === 0 ? `
                            <p class="text-gray-400 text-xs text-center py-4">ì•¡ì…˜ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.<br>â• ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>
                        ` : sortedActions.map(action => {
                            if (!showCompletedInBuckets && action.completed) {
                                return '';
                            }
                            
                            const today = new Date().toISOString().split('T')[0];
                            const isToday = action.deadline === today && !action.completed;
                            const isRecurring = action.recurring_rule_id ? 'ğŸ”„ ' : '';
                            
                            return `
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleActionItem(${bucket.id}, ${action.id})" class="flex-shrink-0 ${action.completed ? 'text-green-600' : 'text-gray-400'}">
                                            ${action.completed ? 'âœ…' : 'â­•'}
                                        </button>
                                        ${editingAction === action.id ? `
                                            <input type="text" value="${action.text.replace(/"/g, '&quot;')}" 
                                                   onkeypress="if(event.key==='Enter') saveEditAction(${action.id}, this.value); if(event.key==='Escape') cancelEditAction();"
                                                   onblur="saveEditAction(${action.id}, this.value)"
                                                   class="flex-1 px-1 py-0.5 text-xs border border-blue-500 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                   autofocus />
                                            <button onclick="cancelEditAction()" class="text-red-500 hover:text-red-700 text-xs">âœ•</button>
                                        ` : `
                                            <span class="flex-1 text-xs ${action.completed ? 'line-through text-gray-500' : 'text-gray-700'} cursor-pointer" 
                                                  onclick="startEditAction(${action.id})">
                                                ${isRecurring}${action.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                                            </span>
                                            <button onclick="deleteActionItem(${bucket.id}, ${action.id})" class="text-red-500 hover:text-red-700 text-xs">
                                                âŒ
                                            </button>
                                        `}
                                    </div>
                                    ${editingAction !== action.id ? `
                                        <input type="date" value="${action.deadline || ''}" onchange="setDeadline(${bucket.id}, ${action.id}, this.value)" class="ml-5 px-1 py-0.5 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${isToday ? 'border-red-500 bg-red-50' : 'border-gray-200'}" />
                                    ` : ''}
                                </div>
                            `;
                        }).filter(html => html !== '').join('')}
                    </div>
                ` : `
                    <!-- ì ‘í˜€ìˆì„ ë•Œ ìš”ì•½ ì •ë³´ -->
                    <div class="mt-1">
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>${bucket.stage}</span>
                        </div>
                        ${(bucket.unit_price || bucket.quantity || bucket.product) ? `
                            <div class="text-xs text-gray-500 mt-1">
                                ${bucket.unit_price ? `${bucket.unit_price}ì›` : ''}
                                ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                ${bucket.quantity ? `${bucket.quantity}` : ''}
                                ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                ${bucket.product ? `${bucket.product}` : ''}
                            </div>
                        ` : ''}
                    </div>
                `}
            `;

            return div;
        }

        // ë²„í‚· ê´€ë ¨ í•¨ìˆ˜ë“¤
        function toggleBucketCollapse(bucketId) {
            collapsedBuckets[bucketId] = !collapsedBuckets[bucketId];
            renderBuckets();
        }

        function toggleContractCollapse(bucketId) {
            collapsedContracts[bucketId] = !collapsedContracts[bucketId];
            renderBuckets();
        }

        function startEditBucket(bucketId) {
            editingBucket = bucketId;
            renderBuckets();
        }

        async function saveEditBucket(bucketId, newName) {
            if (!newName.trim()) return;
            
            try {
                const { error } = await supabase
                    .from('buckets')
                    .update({ name: newName.trim() })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`ë²„í‚· ì´ë¦„ ìˆ˜ì • ì˜¤ë¥˜: ${error.message}`);
                }

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket.name = newName.trim();
                }
                
                editingBucket = null;
                renderBuckets();
                showSuccess('ê´‘ê³ ì£¼ëª…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ë²„í‚· ì´ë¦„ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function cancelEditBucket() {
            editingBucket = null;
            renderBuckets();
        }

        function startEditAction(actionId) {
            editingAction = actionId;
            renderBuckets();
        }

        async function saveEditAction(actionId, newText) {
            if (!newText.trim()) return;
            
            try {
                const { error } = await supabase
                    .from('actions')
                    .update({ text: newText.trim() })
                    .eq('id', actionId);

                if (error) {
                    throw new Error(`ì•¡ì…˜ ì•„ì´í…œ ìˆ˜ì • ì˜¤ë¥˜: ${error.message}`);
                }

                buckets.forEach(bucket => {
                    const action = bucket.actions?.find(a => a.id === actionId);
                    if (action) {
                        action.text = newText.trim();
                    }
                });
                
                editingAction = null;
                renderBuckets();
                showSuccess('ì•¡ì…˜ì•„ì´í…œì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ì•¡ì…˜ ì•„ì´í…œ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function cancelEditAction() {
            editingAction = null;
            renderBuckets();
        }

        async function updateBucketInfo(bucketId, field, value) {
            try {
                const { error } = await supabase
                    .from('buckets')
                    .update({ [field]: value })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`ë²„í‚· ì •ë³´ ìˆ˜ì • ì˜¤ë¥˜: ${error.message}`);
                }

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket[field] = value;
                }
            } catch (error) {
                console.error('ë²„í‚· ì •ë³´ ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function changeStage(bucketId, newStage) {
            await moveToStage(bucketId, newStage);
            renderBuckets();
        }

        async function addCustomAction(bucketId) {
            const text = prompt('ìƒˆ ì•¡ì…˜ì•„ì´í…œì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!text || !text.trim()) return;

            try {
                const bucket = buckets.find(b => b.id === bucketId);
                if (!bucket) return;

                // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„¤ì •
                const today = new Date().toISOString().split('T')[0];

                const { data: newAction, error } = await supabase
                    .from('actions')
                    .insert([{
                        bucket_id: bucketId,
                        text: text.trim(),
                        completed: false,
                        deadline: today,  // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„¤ì •
                        order_index: bucket.actions.length
                    }])
                    .select()
                    .single();

                if (error) {
                    throw new Error(`ì•¡ì…˜ ì•„ì´í…œ ì¶”ê°€ ì˜¤ë¥˜: ${error.message}`);
                }

                bucket.actions.push(newAction);
                
                renderBuckets();
                updateTodayDeadlines();
                showSuccess('ì•¡ì…˜ì•„ì´í…œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ì•¡ì…˜ ì•„ì´í…œ ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function toggleActionItem(bucketId, actionId) {
            try {
                const bucket = buckets.find(b => b.id === bucketId);
                const action = bucket?.actions?.find(a => a.id === actionId);
                
                if (!action) return;

                const newCompleted = !action.completed;

                const { error } = await supabase
                    .from('actions')
                    .update({ completed: newCompleted })
                    .eq('id', actionId);

                if (error) {
                    throw new Error(`ì•¡ì…˜ ì•„ì´í…œ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜: ${error.message}`);
                }

                action.completed = newCompleted;
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                } else {
                    renderTodoView();
                }
                updateTodayDeadlines();
            } catch (error) {
                console.error('ì•¡ì…˜ ì•„ì´í…œ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function setDeadline(bucketId, actionId, deadline) {
            try {
                const bucket = buckets.find(b => b.id === bucketId);
                const action = bucket?.actions?.find(a => a.id === actionId);
                
                if (!action) return;

                const { error } = await supabase
                    .from('actions')
                    .update({ deadline: deadline || null })
                    .eq('id', actionId);

                if (error) {
                    throw new Error(`ë§ˆê°ì¼ ì„¤ì • ì˜¤ë¥˜: ${error.message}`);
                }

                action.deadline = deadline || null;
                
                updateTodayDeadlines();
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                } else {
                    renderTodoView();
                }
            } catch (error) {
                console.error('ë§ˆê°ì¼ ì„¤ì • ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function deleteActionItem(bucketId, actionId) {
            if (!confirm('ì´ ì•¡ì…˜ì•„ì´í…œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const { error } = await supabase
                    .from('actions')
                    .delete()
                    .eq('id', actionId);

                if (error) {
                    throw new Error(`ì•¡ì…˜ ì•„ì´í…œ ì‚­ì œ ì˜¤ë¥˜: ${error.message}`);
                }

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket && bucket.actions) {
                    bucket.actions = bucket.actions.filter(a => a.id !== actionId);
                }
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                } else {
                    renderTodoView();
                }
                updateTodayDeadlines();
                showSuccess('ì•¡ì…˜ì•„ì´í…œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ì•¡ì…˜ ì•„ì´í…œ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function deleteBucket(bucketId) {
            if (!confirm('ì •ë§ë¡œ ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì•¡ì…˜ì•„ì´í…œë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;

            try {
                const { error } = await supabase
                    .from('buckets')
                    .delete()
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`ë²„í‚· ì‚­ì œ ì˜¤ë¥˜: ${error.message}`);
                }

                buckets = buckets.filter(b => b.id !== bucketId);
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                }
                updateTodayDeadlines();
                showSuccess('ê´‘ê³ ì£¼ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ë²„í‚· ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function showAddTodoForm() {
            addTodoForm.classList.remove('hidden');
            updateTodoBucketSelect();
            // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            todoDeadlineInput.value = today;
            todoTextInput.focus();
        }

        function hideAddTodoForm() {
            addTodoForm.classList.add('hidden');
            todoBucketSelect.value = '';
            todoDeadlineInput.value = '';
            todoTextInput.value = '';
        }

        function updateTodoBucketSelect() {
            todoBucketSelect.innerHTML = '<option value="">ê´‘ê³ ì£¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            buckets.forEach(bucket => {
                const option = document.createElement('option');
                option.value = bucket.id;
                option.textContent = bucket.name;
                todoBucketSelect.appendChild(option);
            });
        }

        async function addTodoItem() {
            const bucketId = parseInt(todoBucketSelect.value);
            const text = todoTextInput.value.trim();
            const deadline = todoDeadlineInput.value || null;

            if (!bucketId) {
                alert('ê´‘ê³ ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!text) {
                alert('ì•¡ì…˜ì•„ì´í…œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const bucket = buckets.find(b => b.id === bucketId);
                if (!bucket) return;

                const { data: newAction, error } = await supabase
                    .from('actions')
                    .insert([{
                        bucket_id: bucketId,
                        text: text,
                        completed: false,
                        deadline: deadline,
                        order_index: bucket.actions.length
                    }])
                    .select()
                    .single();

                if (error) {
                    throw new Error(`ì•¡ì…˜ ì•„ì´í…œ ì¶”ê°€ ì˜¤ë¥˜: ${error.message}`);
                }

                bucket.actions.push(newAction);
                
                hideAddTodoForm();
                renderTodoView();
                updateTodayDeadlines();
                showSuccess('ì•¡ì…˜ì•„ì´í…œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ì•¡ì…˜ ì•„ì´í…œ ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë°˜ë³µ ê·œì¹™ ê´€ë ¨ í•¨ìˆ˜ë“¤ (ì´ì–´ì„œ...)
        function showAddRecurringForm() {
            addRecurringForm.classList.remove('hidden');
            updateRuleBucketSelect();
            ruleNameInput.focus();
            editingRule = null;
        }

        function hideAddRecurringForm() {
            addRecurringForm.classList.add('hidden');
            editingRule = null;
            ruleNameInput.value = '';
            ruleBucketSelect.value = '';
            ruleActionInput.value = '';
            repeatTypeSelect.value = 'daily';
            weeklyDaySelect.value = '1';
            monthlyDateSelect.value = '1';
            createTimeInput.value = '09:00';
            deadlineTypeSelect.value = 'none';
            deadlineDaysInput.value = '1';
            startDateInput.value = new Date().toISOString().split('T')[0];
            endDateInput.value = '';
            ruleStatusSelect.value = 'active';
            weeklyDayContainer.classList.add('hidden');
            monthlyDateContainer.classList.add('hidden');
            deadlineDaysContainer.classList.add('hidden');
        }

        function updateRuleBucketSelect() {
            ruleBucketSelect.innerHTML = '<option value="">ê´‘ê³ ì£¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            buckets.forEach(bucket => {
                const option = document.createElement('option');
                option.value = bucket.id;
                option.textContent = bucket.name;
                ruleBucketSelect.appendChild(option);
            });
        }

        async function addRecurringRule() {
            const ruleName = ruleNameInput.value.trim();
            const bucketId = parseInt(ruleBucketSelect.value);
            const actionText = ruleActionInput.value.trim();
            const repeatType = repeatTypeSelect.value;
            const createTime = createTimeInput.value;
            const deadlineType = deadlineTypeSelect.value;
            const deadlineDays = parseInt(deadlineDaysInput.value) || 1;
            const startDate = startDateInput.value;
            const endDate = endDateInput.value || null;
            const status = ruleStatusSelect.value;

            if (!ruleName || !bucketId || !actionText || !startDate) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                showLoading();

                let repeatConfig = { hour: parseInt(createTime.split(':')[0]), minute: parseInt(createTime.split(':')[1]) };
                
                if (repeatType === 'weekly') {
                    repeatConfig.day_of_week = parseInt(weeklyDaySelect.value);
                } else if (repeatType === 'monthly') {
                    repeatConfig.date = parseInt(monthlyDateSelect.value);
                }

                const ruleData = {
                    user_id: userId,
                    rule_name: ruleName,
                    bucket_id: bucketId,
                    action_template: actionText,
                    repeat_type: repeatType,
                    repeat_config: repeatConfig,
                    deadline_type: deadlineType,
                    deadline_days: deadlineDays,
                    start_date: startDate,
                    end_date: endDate,
                    is_active: status === 'active',
                    last_generated: null
                };

                if (editingRule) {
                    const { error } = await supabase
                        .from('recurring_rules')
                        .update(ruleData)
                        .eq('id', editingRule)
                        .eq('user_id', userId);

                    if (error) {
                        throw new Error(`ë°˜ë³µ ê·œì¹™ ìˆ˜ì • ì˜¤ë¥˜: ${error.message}`);
                    }

                    const ruleIndex = recurringRules.findIndex(r => r.id === editingRule);
                    if (ruleIndex !== -1) {
                        recurringRules[ruleIndex] = { ...recurringRules[ruleIndex], ...ruleData };
                    }

                    showSuccess('ë°˜ë³µ ê·œì¹™ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    const { data: newRule, error } = await supabase
                        .from('recurring_rules')
                        .insert([ruleData])
                        .select()
                        .single();

                    if (error) {
                        throw new Error(`ë°˜ë³µ ê·œì¹™ ìƒì„± ì˜¤ë¥˜: ${error.message}`);
                    }

                    recurringRules.unshift(newRule);
                    showSuccess('ë°˜ë³µ ê·œì¹™ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }

                hideLoading();
                hideAddRecurringForm();
                renderRecurringView();

            } catch (error) {
                console.error('ë°˜ë³µ ê·œì¹™ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                hideLoading();
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        function renderRecurringView() {
            if (recurringRules.length === 0) {
                recurringRulesList.innerHTML = '';
                recurringEmpty.classList.remove('hidden');
                return;
            }

            recurringEmpty.classList.add('hidden');
            
            recurringRulesList.innerHTML = recurringRules.map(rule => {
                const bucket = buckets.find(b => b.id === rule.bucket_id);
                const bucketName = bucket ? bucket.name : 'ì‚­ì œëœ ê´‘ê³ ì£¼';
                
                const getRepeatText = () => {
                    const config = rule.repeat_config || {};
                    const time = `${config.hour || 9}:${String(config.minute || 0).padStart(2, '0')}`;
                    
                    if (rule.repeat_type === 'daily') {
                        return `ë§¤ì¼ ${time}`;
                    } else if (rule.repeat_type === 'weekly') {
                        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                        const dayName = days[config.day_of_week || 1];
                        return `ë§¤ì£¼ ${dayName}ìš”ì¼ ${time}`;
                    } else if (rule.repeat_type === 'monthly') {
                        return `ë§¤ì›” ${config.date || 1}ì¼ ${time}`;
                    }
                    return 'ì„¤ì • ì˜¤ë¥˜';
                };

                const getDeadlineText = () => {
                    switch(rule.deadline_type) {
                        case 'same_day': return 'ë‹¹ì¼ ë§ˆê°';
                        case 'next_day': return 'ë‹¤ìŒë‚  ë§ˆê°';
                        case 'days_after': return `${rule.deadline_days}ì¼ í›„ ë§ˆê°`;
                        default: return 'ë§ˆê°ì¼ ì—†ìŒ';
                    }
                };

                return `
                    <div class="p-4 border border-gray-200 rounded-lg ${rule.is_active ? 'bg-white' : 'bg-gray-50'}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800 flex items-center gap-2">
                                    ğŸ”„ ${rule.rule_name}
                                    <span class="px-2 py-1 text-xs rounded ${rule.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                                        ${rule.is_active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                                    </span>
                                </h4>
                                <p class="text-sm text-gray-600 mt-1">[${bucketName}] ${rule.action_template}</p>
                                <div class="text-xs text-blue-600 mt-1">
                                    <span>${getRepeatText()}</span> Â· <span>${getDeadlineText()}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editRecurringRule(${rule.id})" class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                    ìˆ˜ì •
                                </button>
                                <button onclick="toggleRecurringRule(${rule.id})" class="px-2 py-1 text-xs rounded ${rule.is_active ? 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200' : 'bg-green-100 text-green-700 hover:bg-green-200'}">
                                    ${rule.is_active ? 'ì¼ì‹œì •ì§€' : 'í™œì„±í™”'}
                                </button>
                                <button onclick="deleteRecurringRule(${rule.id})" class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">
                                    ì‚­ì œ
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            <p>ê¸°ê°„: ${rule.start_date} ${rule.end_date ? `~ ${rule.end_date}` : '~ ë¬´ì œí•œ'}</p>
                            <p>ë§ˆì§€ë§‰ ìƒì„±: ${rule.last_generated || 'ì•„ì§ ìƒì„±ëœ í•­ëª© ì—†ìŒ'}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function editRecurringRule(ruleId) {
            const rule = recurringRules.find(r => r.id === ruleId);
            if (!rule) return;

            editingRule = ruleId;
            
            addRecurringForm.classList.remove('hidden');
            updateRuleBucketSelect();
            
            ruleNameInput.value = rule.rule_name;
            ruleBucketSelect.value = rule.bucket_id;
            ruleActionInput.value = rule.action_template;
            repeatTypeSelect.value = rule.repeat_type;
            
            const config = rule.repeat_config || {};
            const time = `${String(config.hour || 9).padStart(2, '0')}:${String(config.minute || 0).padStart(2, '0')}`;
            createTimeInput.value = time;
            
            deadlineTypeSelect.value = rule.deadline_type || 'none';
            deadlineDaysInput.value = rule.deadline_days || 1;
            startDateInput.value = rule.start_date;
            endDateInput.value = rule.end_date || '';
            ruleStatusSelect.value = rule.is_active ? 'active' : 'inactive';
            
            weeklyDayContainer.classList.add('hidden');
            monthlyDateContainer.classList.add('hidden');
            
            if (rule.repeat_type === 'weekly') {
                weeklyDayContainer.classList.remove('hidden');
                weeklyDaySelect.value = config.day_of_week || 1;
            } else if (rule.repeat_type === 'monthly') {
                monthlyDateContainer.classList.remove('hidden');
                monthlyDateSelect.value = config.date || 1;
            }
            
            if (rule.deadline_type === 'days_after') {
                deadlineDaysContainer.classList.remove('hidden');
            }
            
            ruleNameInput.focus();
        }

        async function toggleRecurringRule(ruleId) {
            try {
                const rule = recurringRules.find(r => r.id === ruleId);
                if (!rule) return;

                const newStatus = !rule.is_active;

                const { error } = await supabase
                    .from('recurring_rules')
                    .update({ is_active: newStatus })
                    .eq('id', ruleId)
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`ë°˜ë³µ ê·œì¹™ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜: ${error.message}`);
                }

                rule.is_active = newStatus;
                renderRecurringView();
                
                showSuccess(`ë°˜ë³µ ê·œì¹™ì´ ${newStatus ? 'í™œì„±í™”' : 'ì¼ì‹œì •ì§€'}ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } catch (error) {
                console.error('ë°˜ë³µ ê·œì¹™ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function deleteRecurringRule(ruleId) {
            if (!confirm('ì´ ë°˜ë³µ ê·œì¹™ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const { error } = await supabase
                    .from('recurring_rules')
                    .delete()
                    .eq('id', ruleId)
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`ë°˜ë³µ ê·œì¹™ ì‚­ì œ ì˜¤ë¥˜: ${error.message}`);
                }

                recurringRules = recurringRules.filter(r => r.id !== ruleId);
                renderRecurringView();
                
                showSuccess('ë°˜ë³µ ê·œì¹™ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ë°˜ë³µ ê·œì¹™ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë°˜ë³µ ê·œì¹™ ì²´í¬ ë° ì‹¤í–‰
        function startRecurringCheck() {
            setInterval(checkRecurringRules, 60000);
            checkRecurringRules();
        }

        async function checkRecurringRules() {
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentTime = now.getHours() * 60 + now.getMinutes();

            for (const rule of recurringRules) {
                if (!rule.is_active) continue;
                
                if (rule.end_date && currentDate > rule.end_date) continue;
                
                if (currentDate < rule.start_date) continue;
                
                if (rule.last_generated === currentDate) continue;
                
                const config = rule.repeat_config || {};
                const ruleTime = (config.hour || 9) * 60 + (config.minute || 0);
                const timeDiff = Math.abs(currentTime - ruleTime);
                
                if (timeDiff > 1) continue;
                
                let shouldGenerate = false;
                
                if (rule.repeat_type === 'daily') {
                    shouldGenerate = true;
                } else if (rule.repeat_type === 'weekly') {
                    const targetDay = config.day_of_week || 1;
                    const currentDay = now.getDay();
                    shouldGenerate = targetDay === currentDay;
                } else if (rule.repeat_type === 'monthly') {
                    const targetDate = config.date || 1;
                    const currentDateNum = now.getDate();
                    shouldGenerate = targetDate === currentDateNum;
                }
                
                if (shouldGenerate) {
                    await generateRecurringAction(rule, currentDate);
                }
            }
        }

        async function generateRecurringAction(rule, currentDate) {
            try {
                const bucket = buckets.find(b => b.id === rule.bucket_id);
                if (!bucket) return;

                let deadline = null;
                const currentDateObj = new Date(currentDate);
                
                switch(rule.deadline_type) {
                    case 'same_day':
                        deadline = currentDate;
                        break;
                    case 'next_day':
                        currentDateObj.setDate(currentDateObj.getDate() + 1);
                        deadline = currentDateObj.toISOString().split('T')[0];
                        break;
                    case 'days_after':
                        currentDateObj.setDate(currentDateObj.getDate() + (rule.deadline_days || 1));
                        deadline = currentDateObj.toISOString().split('T')[0];
                        break;
                    default:
                        deadline = null;
                }

                const newAction = {
                    bucket_id: rule.bucket_id,
                    text: `${rule.action_template} (${currentDate})`,
                    completed: false,
                    deadline: deadline,
                    recurring_rule_id: rule.id,
                    order_index: bucket.actions.length
                };

                const { data: createdAction, error: actionError } = await supabase
                    .from('actions')
                    .insert([newAction])
                    .select()
                    .single();

                if (actionError) {
                    throw new Error(`ë°˜ë³µ ì•¡ì…˜ ìƒì„± ì˜¤ë¥˜: ${actionError.message}`);
                }

                const { error: ruleError } = await supabase
                    .from('recurring_rules')
                    .update({ last_generated: currentDate })
                    .eq('id', rule.id);

                if (ruleError) {
                    console.error('ë°˜ë³µ ê·œì¹™ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', ruleError);
                }

                bucket.actions.push(createdAction);
                rule.last_generated = currentDate;

                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'stage') {
                    renderStageView();
                } else if (currentView === 'todo') {
                    renderTodoView();
                }

                updateTodayDeadlines();
                
                console.log(`ë°˜ë³µ ì•¡ì…˜ ìƒì„±ë¨: ${rule.rule_name} -> [${bucket.name}]`);
                showSuccess(`ë°˜ë³µ ì‘ì—…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${rule.rule_name}`);

            } catch (error) {
                console.error('ë°˜ë³µ ì•¡ì…˜ ìƒì„± ì˜¤ë¥˜:', error);
            }
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
        function exportToExcel() {
            try {
                const allItems = [];
                buckets.forEach(bucket => {
                    (bucket.actions || []).forEach(action => {
                        allItems.push({
                            'ê´‘ê³ ì£¼ID': bucket.id,
                            'ê´‘ê³ ì£¼ëª…': bucket.name,
                            'ì•¡ì…˜ì•„ì´í…œ': action.text,
                            'ë§ˆê°ì¼ì': action.deadline || '',
                            'ì™„ë£Œì—¬ë¶€': action.completed ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ',
                            'ë°˜ë³µì‘ì—…': action.recurring_rule_id ? 'ë°˜ë³µ' : 'ì¼ë°˜'
                        });
                    });
                });

                if (allItems.length === 0) {
                    alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                let filteredItems = allItems;
                if (currentView === 'todo' && !showCompletedTodos) {
                    filteredItems = allItems.filter(item => item.ì™„ë£Œì—¬ë¶€ === 'ë¯¸ì™„ë£Œ');
                } else if (currentView === 'buckets' && !showCompletedInBuckets) {
                    filteredItems = allItems.filter(item => item.ì™„ë£Œì—¬ë¶€ === 'ë¯¸ì™„ë£Œ');
                }

                const ws = XLSX.utils.json_to_sheet(filteredItems);

                const colWidths = [
                    { wch: 10 },
                    { wch: 20 },
                    { wch: 30 },
                    { wch: 12 },
                    { wch: 10 },
                    { wch: 10 }
                ];
                ws['!cols'] = colWidths;

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ì•¡ì…˜ì•„ì´í…œ ëª©ë¡');

                const today = new Date();
                const dateString = today.getFullYear() + '-' + 
                    String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(today.getDate()).padStart(2, '0');
                const filename = `ê´‘ê³ í”„ë¡œì íŠ¸_ì•¡ì…˜ì•„ì´í…œ_${dateString}.xlsx`;

                XLSX.writeFile(wb, filename);

                showSuccess('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');

            } catch (error) {
                console.error('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                alert('ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë©”ëª¨ì¥ ê¸°ëŠ¥
        async function loadMemo() {
            try {
                const { data: memoData, error } = await supabase
                    .from('memos')
                    .select('content')
                    .eq('user_id', userId)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw new Error(`ë©”ëª¨ ë¡œë“œ ì˜¤ë¥˜: ${error.message}`);
                }

                if (memoData) {
                    memoTextarea.value = memoData.content || '';
                    memoStatus.textContent = 'ì €ì¥ëœ ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.';
                } else {
                    memoTextarea.value = '';
                    memoStatus.textContent = 'ìƒˆë¡œìš´ ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”.';
                }
            } catch (error) {
                console.error('ë©”ëª¨ ë¡œë“œ ì˜¤ë¥˜:', error);
                memoTextarea.value = '';
                memoStatus.textContent = 'ë©”ëª¨ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        }

        async function saveMemo() {
            try {
                const memoContent = memoTextarea.value;
                
                const { error } = await supabase
                    .from('memos')
                    .upsert([{
                        user_id: userId,
                        content: memoContent,
                        updated_at: new Date().toISOString()
                    }], {
                        onConflict: 'user_id'
                    });

                if (error) {
                    throw new Error(`ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜: ${error.message}`);
                }

                memoStatus.textContent = 'ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                showSuccess('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜:', error);
                memoStatus.textContent = 'ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        async function clearMemo() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const { error } = await supabase
                    .from('memos')
                    .delete()
                    .eq('user_id', userId);

                if (error) {
                    throw new Error(`ë©”ëª¨ ì‚­ì œ ì˜¤ë¥˜: ${error.message}`);
                }

                memoTextarea.value = '';
                memoStatus.textContent = 'ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
                showSuccess('ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ë©”ëª¨ ì‚­ì œ ì˜¤ë¥˜:', error);
                memoStatus.textContent = 'ë©”ëª¨ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        let autoSaveTimeout;
        function autoSaveMemo() {
            clearTimeout(autoSaveTimeout);
            memoStatus.textContent = 'ì…ë ¥ ì¤‘...';
            
            autoSaveTimeout = setTimeout(async () => {
                try {
                    const memoContent = memoTextarea.value;
                    
                    const { error } = await supabase
                        .from('memos')
                        .upsert([{
                            user_id: userId,
                            content: memoContent,
                            updated_at: new Date().toISOString()
                        }], {
                            onConflict: 'user_id'
                        });

                    if (error) {
                        throw new Error(`ìë™ ì €ì¥ ì˜¤ë¥˜: ${error.message}`);
                    }

                    memoStatus.textContent = 'ìë™ ì €ì¥ë¨';
                } catch (error) {
                    console.error('ìë™ ì €ì¥ ì˜¤ë¥˜:', error);
                    memoStatus.textContent = 'ìë™ ì €ì¥ ì‹¤íŒ¨';
                }
            }, 2000);
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì•± ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
