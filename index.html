<select onchange="updateBucketInfo(${bucket.id}, 'product', this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">선택</option>
                                        <option value="CPM" ${bucket.product === 'CPM' ? 'selected' : ''}>CPM</option>
                                        <option value="CPA" ${bucket.product === 'CPA' ? 'selected' : ''}>CPA</option>
                                        <option value="CPA+" ${bucket.product === 'CPA+' ? 'selected' : ''}>CPA+</option>
                                        <option value="CPR" ${bucket.product === 'CPR' ? 'selected' : ''}>CPR</option>
                                        <option value="CPR+" ${bucket.product === 'CPR+' ? 'selected' : ''}>CPR+</option>
                                        <option value="CPS" ${bucket.product === 'CPS' ? 'selected' : ''}>CPS</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">계약조건</label>
                                    <textarea onchange="updateBucketInfo(${bucket.id}, 'contract_terms', this.value)" placeholder="계약 조건..." rows="2" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none">${bucket.contract_terms || ''}</textarea>
                                </div>
                            </div>
                        ` : `
                            ${(bucket.unit_price || bucket.quantity || bucket.product) ? `
                                <div class="text-xs text-gray-500">
                                    ${bucket.unit_price ? `${bucket.unit_price}원` : ''}
                                    ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                    ${bucket.quantity ? `${bucket.quantity}` : ''}
                                    ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                    ${bucket.product ? `${bucket.product}` : ''}
                                </div>
                            ` : ''}
                        `}
                    </div>

                    <!-- 액션 아이템 -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xs font-medium text-gray-700">액션 아이템</h4>
                            <button onclick="addCustomAction(${bucket.id})" class="text-blue-600 hover:text-blue-800 text-xs">
                                ➕
                            </button>
                        </div>
                        
                        ${sortedActions.map(action => {
                            // 완료된 액션아이템이 숨김 설정되어 있으면 건너뛰기
                            if (!showCompletedInBuckets && action.completed) {
                                return '';
                            }
                            
                            const today = new Date().toISOString().split('T')[0];
                            const isToday = action.deadline === today && !action.completed;
                            
                            return `
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleActionItem(${bucket.id}, ${action.id})" class="flex-shrink-0 ${action.completed ? 'text-green-600' : 'text-gray-400'}">
                                            ${action.completed ? '✅' : '⭕'}
                                        </button>
                                        ${editingAction === action.id ? `
                                            <input type="text" value="${action.text.replace(/"/g, '&quot;')}" 
                                                   onkeypress="if(event.key==='Enter') saveEditAction(${action.id}, this.value); if(event.key==='Escape') cancelEditAction();"
                                                   onblur="saveEditAction(${action.id}, this.value)"
                                                   class="flex-1 px-1 py-0.5 text-xs border border-blue-500 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                   autofocus />
                                            <button onclick="cancelEditAction()" class="text-red-500 hover:text-red-700 text-xs">✕</button>
                                        ` : `
                                            <span class="flex-1 text-xs ${action.completed ? 'line-through text-gray-500' : 'text-gray-700'} cursor-pointer" 
                                                  onclick="startEditAction(${action.id})">
                                                ${action.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                                            </span>
                                            <button onclick="deleteActionItem(${bucket.id}, ${action.id})" class="text-red-500 hover:text-red-700 text-xs">
                                                ❌
                                            </button>
                                        `}
                                    </div>
                                    ${editingAction !== action.id ? `
                                        <input type="date" value="${action.deadline || ''}" onchange="setDeadline(${bucket.id}, ${action.id}, this.value)" class="ml-5 px-1 py-0.5 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${isToday ? 'border-red-500 bg-red-50' : 'border-gray-200'}" />
                                    ` : ''}
                                </div>
                            `;
                        }).filter(html => html !== '').join('')}
                    </div>
                ` : `
                    <!-- 접혀있을 때 요약 정보 -->
                    <div class="mt-1">
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>${bucket.stage}</span>
                        </div>
                        ${(bucket.unit_price || bucket.quantity || bucket.product) ? `
                            <div class="text-xs text-gray-500 mt-1">
                                ${bucket.unit_price ? `${bucket.unit_price}원` : ''}
                                ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                ${bucket.quantity ? `${bucket.quantity}` : ''}
                                ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                ${bucket.product ? `${bucket.product}` : ''}
                            </div>
                        ` : ''}
                    </div>
                `}
            `;

            return div;
        }

        // 버킷 접기/펼치기
        function toggleBucketCollapse(bucketId) {
            collapsedBuckets[bucketId] = !collapsedBuckets[bucketId];
            renderBuckets();
        }

        function toggleContractCollapse(bucketId) {
            collapsedContracts[bucketId] = !collapsedContracts[bucketId];
            renderBuckets();
        }

        // 편집 기능들
        function startEditBucket(bucketId) {
            editingBucket = bucketId;
            renderBuckets();
        }

        async function saveEditBucket(bucketId, newName) {
            if (!newName.trim()) return;
            
            try {
                const { error } = await supabase
                    .from('buckets')
                    .update({ name: newName.trim() })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) throw error;

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket.name = newName.trim();
                }
                
                editingBucket = null;
                renderBuckets();
            } catch (error) {
                alert('버킷명 수정 중 오류가 발생했습니다: ' + error.message);
            }
        }

        function cancelEditBucket() {
            editingBucket = null;
            renderBuckets();
        }

        function startEditAction(actionId) {
            editingAction = actionId;
            renderBuckets();
        }

        async function saveEditAction(actionId, newText) {
            if (!newText.trim()) return;
            
            try {
                const { error } = await supabase
                    .from('actions')
                    .update({ text: newText.trim() })
                    .eq('id', actionId);

                if (error) throw error;

                buckets.forEach(bucket => {
                    const action = bucket.actions?.find(a => a.id === actionId);
                    if (action) {
                        action.text = newText.trim();
                    }
                });
                
                editingAction = null;
                renderBuckets();
            } catch (error) {
                alert('액션아이템 수정 중 오류가 발생했습니다: ' + error.message);
            }
        }

        function cancelEditAction() {
            editingAction = null;
            renderBuckets();
        }

        // 버킷 정보 업데이트
        async function updateBucketInfo(bucketId, field, value) {
            try {
                const { error } = await supabase
                    .from('buckets')
                    .update({ [field]: value })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) throw error;

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket[field] = value;
                }
            } catch (error) {
                console.error('버킷 정보 업데이트 오류:', error);
            }
        }

        // 단계 변경
        async function changeStage(bucketId, newStage) {
            try {
                const { error } = await supabase
                    .from('buckets')
                    .update({ stage: newStage })
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) throw error;

                const bucket = buckets.find(b => b.id === bucketId);
                if (bucket) {
                    bucket.stage = newStage;
                    renderBuckets();
                }
                
            } catch (error) {
                alert('단계 변경 중 오류가 발생했습니다: ' + error.message);
                await loadData();
            }
        }

        // 새 액션 아이템 추가
        async function addCustomAction(bucketId) {
            const text = prompt('새 액션아이템을 입력하세요:');
            if (!text || !text.trim()) return;

            try {
                const { error } = await supabase
                    .from('actions')
                    .insert([{
                        bucket_id: bucketId,
                        text: text.trim(),
                        completed: false,
                        deadline: null
                    }]);

                if (error) throw error;
                await loadData();
                updateTodayDeadlines();
            } catch (error) {
                alert('액션아이템 추가 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 액션 아이템 토글
        async function toggleActionItem(bucketId, actionId) {
            try {
                const bucket = buckets.find(b => b.id === bucketId);
                const action = bucket?.actions?.find(a => a.id === actionId);
                
                if (!action) return;

                const newCompleted = !action.completed;

                const { error } = await supabase
                    .from('actions')
                    .update({ completed: newCompleted })
                    .eq('id', actionId);

                if (error) throw error;

                action.completed = newCompleted;
                if (currentView === 'buckets') {
                    renderBuckets();
                } else {
                    renderTodoView();
                }
                updateTodayDeadlines();
                
            } catch (error) {
                console.error('액션아이템 업데이트 오류:', error);
                alert('액션아이템 업데이트 중 오류가 발생했습니다: ' + error.message);
                await loadData();
            }
        }

        // 마감일 설정
        async function setDeadline(bucketId, actionId, deadline) {
            try {
                const { error } = await supabase
                    .from('actions')
                    .update({ deadline: deadline || null })
                    .eq('id', actionId);

                if (error) throw error;

                const bucket = buckets.find(b => b.id === bucketId);
                const action = bucket?.actions?.find(a => a.id === actionId);
                if (action) {
                    action.deadline = deadline;
                }

                updateTodayDeadlines();
                
                // 현재 뷰에 따라 렌더링
                if (currentView === 'buckets') {
                    renderBuckets();
                } else {
                    renderTodoView();
                }
            } catch (error) {
                console.error('마감일 설정 오류:', error);
            }
        }

        // 액션 아이템 삭제
        async function deleteActionItem(bucketId, actionId) {
            if (!confirm('이 액션아이템을 삭제하시겠습니까?')) return;

            try {
                const { error } = await supabase
                    .from('actions')
                    .delete()
                    .eq('id', actionId);

                if (error) throw error;
                await loadData();
                updateTodayDeadlines();
            } catch (error) {
                console.error('액션아이템 삭제 오류:', error);
                alert('액션아이템 삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 버킷 삭제
        async function deleteBucket(bucketId) {
            if (!confirm('정말로 이 프로젝트를 삭제하시겠습니까?\n모든 액션아이템도 함께 삭제됩니다.')) return;

            try {
                const { error } = await supabase
                    .from('buckets')
                    .delete()
                    .eq('id', bucketId)
                    .eq('user_id', userId);

                if (error) throw error;

                await loadData();
                updateTodayDeadlines();
                
            } catch (error) {
                console.error('프로젝트 삭제 오류:', error);
                alert('프로젝트 삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 투두리스트에서 액션아이템 추가 기능
        function showAddTodoForm() {
            addTodoForm.classList.remove('hidden');
            updateTodoBucketSelect();
            todoTextInput.focus();
        }

        function hideAddTodoForm() {
            addTodoForm.classList.add('hidden');
            todoBucketSelect.value = '';
            todoDeadlineInput.value = '';
            todoTextInput.value = '';
        }

        function updateTodoBucketSelect() {
            todoBucketSelect.innerHTML = '<option value="">광고주를 선택하세요</option>';
            buckets.forEach(bucket => {
                const option = document.createElement('option');
                option.value = bucket.id;
                option.textContent = bucket.name;
                todoBucketSelect.appendChild(option);
            });
        }

        async function addTodoItem() {
            const bucketId = todoBucketSelect.value;
            const text = todoTextInput.value.trim();
            const deadline = todoDeadlineInput.value || null;

            if (!bucketId) {
                alert('광고주를 선택해주세요.');
                return;
            }

            if (!text) {
                alert('액션아이템 내용을 입력해주세요.');
                return;
            }

            try {
                confirmAddTodoBtn.disabled = true;
                confirmAddTodoBtn.textContent = '추가 중...';

                const { error } = await supabase
                    .from('actions')
                    .insert([{
                        bucket_id: parseInt(bucketId),
                        text: text,
                        completed: false,
                        deadline: deadline
                    }]);

                if (error) throw error;

                hideAddTodoForm();
                await loadData();
                updateTodayDeadlines();
                
            } catch (error) {
                console.error('액션아이템 추가 오류:', error);
                alert('액션아이템 추가 중 오류가 발생했습니다: ' + error.message);
            } finally {
                confirmAddTodoBtn.disabled = false;
                confirmAddTodoBtn.textContent = '추가';
            }
        }

        // 선택 모드 기능
        function toggleSelectMode() {
            selectMode = !selectMode;
            selectedItems.clear();
            
            if (selectMode) {
                toggleSelectModeBtn.textContent = '선택 모드 종료';
                toggleSelectModeBtn.className = 'px-3 py-1 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm';
                deleteSelectedBtn.classList.remove('hidden');
            } else {
                toggleSelectModeBtn.textContent = '선택 모드 시작';
                toggleSelectModeBtn.className = 'px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm';
                deleteSelectedBtn.classList.add('hidden');
                selectAllCheckbox.checked = false;
            }
            
            updateSelectedCount();
            renderTodoView();
        }

        function toggleSelectAll() {
            const allItems = [];
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    if (!showCompletedTodos && action.completed) return;
                    allItems.push(action.id);
                });
            });

            if (selectAllCheckbox.checked) {
                allItems.forEach(id => selectedItems.add(id));
            } else {
                selectedItems.clear();
            }
            
            updateSelectedCount();
            renderTodoView();
        }

        function toggleItemSelection(actionId) {
            if (selectedItems.has(actionId)) {
                selectedItems.delete(actionId);
            } else {
                selectedItems.add(actionId);
            }
            
            updateSelectedCount();
            
            // 전체 선택 체크박스 상태 업데이트
            const allVisibleItems = [];
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    if (!showCompletedTodos && action.completed) return;
                    allVisibleItems.push(action.id);
                });
            });
            
            selectAllCheckbox.checked = allVisibleItems.length > 0 && allVisibleItems.every(id => selectedItems.has(id));
        }

        function updateSelectedCount() {
            selectedCount.textContent = `선택된 항목: ${selectedItems.size}개`;
        }

        async function deleteSelectedItems() {
            if (selectedItems.size === 0) {
                alert('삭제할 항목을 선택해주세요.');
                return;
            }

            if (!confirm(`선택된 ${selectedItems.size}개의 액션아이템을 삭제하시겠습니까?`)) return;

            try {
                const { error } = await supabase
                    .from('actions')
                    .delete()
                    .in('id', Array.from(selectedItems));

                if (error) throw error;

                selectedItems.clear();
                updateSelectedCount();
                await loadData();
                updateTodayDeadlines();
                
                alert('선택된 항목이 삭제되었습니다.');
                
            } catch (error) {
                console.error('일괄 삭제 오류:', error);
                alert('삭제 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 반복 작업 관리 기능
        function showAddRecurringForm() {
            addRecurringForm.classList.remove('hidden');
            updateRecurringBucketSelect();
            
            // 기본값 설정
            const today = new Date();
            recurringStartDate.value = today.toISOString().split('T')[0];
            recurringTaskName.focus();
        }

        function hideAddRecurringForm() {
            addRecurringForm.classList.add('hidden');
            recurringBucketSelect.value = '';
            recurringTaskName.value = '';
            recurringTypeSelect.value = 'daily';
            recurringTimeSelect.value = '09:00';
            recurringStartDate.value = '';
            recurringEndDate.value = '';
            recurringStatus.value = 'active';
        }

        function updateRecurringBucketSelect() {
            recurringBucketSelect.innerHTML = '<option value="">광고주를 선택하세요</option>';
            buckets.forEach(bucket => {
                const option = document.createElement('option');
                option.value = bucket.id;
                option.textContent = bucket.name;
                recurringBucketSelect.appendChild(option);
            });
        }

        async function addRecurringTask() {
            const bucketId = recurringBucketSelect.value;
            const taskName = recurringTaskName.value.trim();
            const type = recurringTypeSelect.value;
            const time = recurringTimeSelect.value;
            const startDate = recurringStartDate.value;
            const endDate = recurringEndDate.value || null;
            const status = recurringStatus.value;

            if (!bucketId || !taskName || !startDate) {
                alert('필수 항목을 모두 입력해주세요.');
                return;
            }

            try {
                confirmAddRecurringBtn.disabled = true;
                confirmAddRecurringBtn.textContent = '등록 중...';

                const recurringTaskData = {
                    user_id: userId,
                    bucket_id: parseInt(bucketId),
                    task_name: taskName,
                    recurring_type: type,
                    recurring_time: time,
                    start_date: startDate,
                    end_date: endDate,
                    status: status,
                    last_generated: null
                };

                // 로컬 저장소에 저장 (실제로는 DB에 저장해야 함)
                const existingTasks = JSON.parse(localStorage.getItem(`recurring_tasks_${userId}`) || '[]');
                recurringTaskData.id = Date.now(); // 임시 ID
                existingTasks.push(recurringTaskData);
                localStorage.setItem(`recurring_tasks_${userId}`, JSON.stringify(existingTasks));

                hideAddRecurringForm();
                loadRecurringTasks();
                renderRecurringView();
                
                alert('반복 작업이 등록되었습니다.');
                
            } catch (error) {
                console.error('반복 작업 등록 오류:', error);
                alert('반복 작업 등록 중 오류가 발생했습니다: ' + error.message);
            } finally {
                confirmAddRecurringBtn.disabled = false;
                confirmAddRecurringBtn.textContent = '등록';
            }
        }

        function loadRecurringTasks() {
            recurringTasks = JSON.parse(localStorage.getItem(`recurring_tasks_${userId}`) || '[]');
        }

        function renderRecurringView() {
            if (recurringTasks.length === 0) {
                recurringList.innerHTML = '';
                recurringEmpty.classList.remove('hidden');
                return;
            }

            recurringEmpty.classList.add('hidden');
            
            recurringList.innerHTML = recurringTasks.map(task => {
                const bucket = buckets.find(b => b.id === task.bucket_id);
                const bucketName = bucket ? bucket.name : '삭제된 광고주';
                
                return `
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">${task.task_name.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h4>
                                <p class="text-sm text-gray-600">[${bucketName}] - ${task.recurring_type === 'daily' ? '매일' : '매주'} ${task.recurring_time}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="toggleRecurringStatus(${task.id})" class="px-2 py-1 text-xs rounded ${task.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                                    ${task.status === 'active' ? '활성' : '일시정지'}
                                </button>
                                <button onclick="deleteRecurringTask(${task.id})" class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">
                                    삭제
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            <p>시작일: ${task.start_date} ${task.end_date ? `| 종료일: ${task.end_date}` : ''}</p>
                            <p>마지막 생성: ${task.last_generated || '아직 생성된 작업 없음'}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function toggleRecurringStatus(taskId) {
            const task = recurringTasks.find(t => t.id === taskId);
            if (!task) return;

            task.status = task.status === 'active' ? 'paused' : 'active';
            localStorage.setItem(`recurring_tasks_${userId}`, JSON.stringify(recurringTasks));
            renderRecurringView();
        }

        async function deleteRecurringTask(taskId) {
            if (!confirm('이 반복 작업을 삭제하시겠습니까?')) return;

            recurringTasks = recurringTasks.filter(task => task.id !== taskId);
            localStorage.setItem(`recurring_tasks_${userId}`, JSON.stringify(recurringTasks));
            renderRecurringView();
        }

        // 반복 작업 스케줄링 (실제로는 서버에서 cron job으로 처리해야 함)
        function checkAndCreateRecurringActions() {
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5); // HH:MM 형식
            const currentDate = now.toISOString().split('T')[0];

            recurringTasks.forEach(async (task) => {
                if (task.status !== 'active') return;
                
                // 종료일 체크
                if (task.end_date && currentDate > task.end_date) return;
                
                // 시간 체크 (±5분 오차 허용)
                const taskTime = new Date(`1970-01-01T${task.recurring_time}:00`);
                const currentTimeObj = new Date(`1970-01-01T${currentTime}:00`);
                const timeDiff = Math.abs(currentTimeObj - taskTime) / (1000 * 60); // 분 단위
                
                if (timeDiff > 5) return; // 5분 이상 차이나면 패스
                
                // 마지막 생성일 체크
                if (task.last_generated === currentDate) return; // 오늘 이미 생성됨
                
                // 주간 반복의 경우 요일 체크
                if (task.recurring_type === 'weekly') {
                    const startDay = new Date(task.start_date).getDay();
                    const currentDay = now.getDay();
                    if (startDay !== currentDay) return;
                }
                
                // 액션아이템 생성
                try {
                    const { error } = await supabase
                        .from('actions')
                        .insert([{
                            bucket_id: task.bucket_id,
                            text: `${task.task_name} (${currentDate})`,
                            completed: false,
                            deadline: null,
                            recurring_task_id: task.id
                        }]);

                    if (error) throw error;

                    // 마지막 생성일 업데이트
                    task.last_generated = currentDate;
                    localStorage.setItem(`recurring_tasks_${userId}`, JSON.stringify(recurringTasks));
                    
                    console.log(`반복 작업 생성됨: ${task.task_name}`);
                    
                } catch (error) {
                    console.error('반복 작업 생성 오류:', error);
                }
            });
        }

        // 메모장 기능
        function loadMemo() {
            const savedMemo = localStorage.getItem(`memo_${userId}`);
            if (savedMemo) {
                memoTextarea.value = savedMemo;
                memoStatus.textContent = '저장된 메모를 불러왔습니다.';
            } else {
                memoTextarea.value = '';
                memoStatus.textContent = '새로운 메모를 작성하세요.';
            }
        }

        function saveMemo() {
            const memoContent = memoTextarea.value;
            localStorage.setItem(`memo_${userId}`, memoContent);
            memoStatus.textContent = '메모가 저장되었습니다.';
            
            // 저장 완료 알림
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.textContent = '메모가 저장되었습니다!';
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function clearMemo() {
            if (confirm('정말로 모든 메모를 삭제하시겠습니까?')) {
                memoTextarea.value = '';
                localStorage.removeItem(`memo_${userId}`);
                memoStatus.textContent = '메모가 삭제되었습니다.';
            }
        }

        let autoSaveTimeout;
        function autoSaveMemo() {
            clearTimeout(autoSaveTimeout);
            memoStatus.textContent = '입력 중...';
            
            autoSaveTimeout = setTimeout(() => {
                const memoContent = memoTextarea.value;
                localStorage.setItem(`memo_${userId}`, memoContent);
                memoStatus.textContent = '자동 저장됨';
            }, 1000);
        }

        // 1분마다 반복 작업 체크
        setInterval(checkAndCreateRecurringActions, 60000);

        // 페이지 로드시 앱 초기화
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>광고 프로젝트 관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="app" class="max-w-7xl mx-auto p-6 bg-gray-50 min-h-screen">
        <!-- 헤더 -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-3">📊 광고 프로젝트 관리</h1>
            <p class="text-gray-600 text-lg">광고주별 버킷으로 업무를 체계적으로 관리하세요</p>
        </div>

        <!-- 오늘 마감 알림 -->
        <div id="todayDeadlines" class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg hidden">
            <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-red-700 font-semibold">오늘 마감인 업무</h3>
            </div>
            <div id="todayDeadlinesList"></div>
        </div>

        <!-- 뷰 전환 탭 -->
        <div class="mb-6">
            <div class="flex border-b border-gray-200">
                <button id="bucketsViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600">
                    버킷 뷰
                </button>
                <button id="todoViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    투두리스트
                </button>
                <button id="memoViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    메모장
                </button>
            </div>
        </div>

        <!-- 새 버킷 추가 버튼 -->
        <div id="addBucketSection" class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <button id="addBucketBtn" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    ➕ 새 광고주 추가
                </button>
                <div class="flex gap-2">
                    <button id="toggleBucketCompletedBtn" class="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
                        <span>👁️</span>
                        <span id="toggleBucketCompletedText">완료항목 숨기기</span>
                    </button>
                    <button id="sortBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <span>📅</span>
                        <span id="sortText">마감일 오름차순</span>
                    </button>
                </div>
            </div>
            
            <!-- 추가 폼 (숨김) -->
            <div id="addBucketForm" class="bg-white p-6 rounded-lg shadow hidden">
                <h3 class="text-lg font-semibold mb-4">새 광고주 정보</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">광고주명 *</label>
                        <input type="text" id="bucketNameInput" placeholder="광고주명을 입력하세요" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">단가 (원)</label>
                        <input type="text" id="unitPriceInput" placeholder="예: 1,000,000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">수량</label>
                        <input type="text" id="quantityInput" placeholder="예: 100회 노출" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">상품</label>
                        <select id="productInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">상품 선택</option>
                            <option value="CPM">CPM</option>
                            <option value="CPA">CPA</option>
                            <option value="CPA+">CPA+</option>
                            <option value="CPR">CPR</option>
                            <option value="CPR+">CPR+</option>
                            <option value="CPS">CPS</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">계약조건 및 기타사항</label>
                    <textarea id="contractTermsInput" placeholder="계약 조건 및 기타사항을 입력하세요..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                </div>
                <div class="flex gap-3">
                    <button id="confirmAddBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">추가</button>
                    <button id="cancelAddBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">취소</button>
                </div>
            </div>
        </div>

        <!-- 투두리스트 뷰 -->
        <div id="todoView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">전체 액션아이템</h2>
                <div class="flex gap-2">
                    <button id="addTodoBtn" class="flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <span>➕</span>
                        <span>새 액션아이템</span>
                    </button>
                    <button id="manageRecurringBtn" class="flex items-center gap-2 px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        <span>🔄</span>
                        <span>반복 관리</span>
                    </button>
                    <button id="exportExcelBtn" class="flex items-center gap-2 px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        <span>📊</span>
                        <span>엑셀 다운로드</span>
                    </button>
                    <button id="deleteSelectedBtn" class="flex items-center gap-2 px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors hidden">
                        <span>🗑️</span>
                        <span>선택 삭제</span>
                    </button>
                    <button id="toggleCompletedBtn" class="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
                        <span>👁️</span>
                        <span id="toggleCompletedText">완료항목 숨기기</span>
                    </button>
                    <button id="todoSortBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <span>📅</span>
                        <span id="todoSortText">마감일 오름차순</span>
                    </button>
                </div>
            </div>
            
            <!-- 일괄 선택 영역 -->
            <div class="flex justify-between items-center mb-4 p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="selectAllCheckbox" class="w-4 h-4">
                    <label for="selectAllCheckbox" class="text-sm font-medium text-gray-700">전체 선택</label>
                    <span id="selectedCount" class="text-sm text-gray-500">선택된 항목: 0개</span>
                </div>
                <button id="toggleSelectModeBtn" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm">
                    선택 모드 시작
                </button>
            </div>
            
            <!-- 새 액션아이템 추가 폼 -->
            <div id="addTodoForm" class="bg-gray-50 p-4 rounded-lg mb-4 hidden">
                <h3 class="text-lg font-semibold mb-3">새 액션아이템 추가</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">광고주 선택 *</label>
                        <select id="todoBucketSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">광고주를 선택하세요</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">마감일</label>
                        <input type="date" id="todoDeadlineInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">액션아이템 내용 *</label>
                    <input type="text" id="todoTextInput" placeholder="액션아이템 내용을 입력하세요" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-3">
                    <button id="confirmAddTodoBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">추가</button>
                    <button id="cancelAddTodoBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">취소</button>
                </div>
            </div>
            
            <div id="todoList" class="space-y-3"></div>
            <div id="todoEmpty" class="text-gray-500 text-center py-8 hidden">등록된 액션아이템이 없습니다.</div>
        </div>

        <!-- 반복 관리 뷰 -->
        <div id="recurringView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">반복 작업 관리</h2>
                <div class="flex gap-2">
                    <button id="addRecurringBtn" class="flex items-center gap-2 px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        <span>➕</span>
                        <span>새 반복 작업</span>
                    </button>
                    <button id="backToTodoBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        <span>←</span>
                        <span>돌아가기</span>
                    </button>
                </div>
            </div>
            
            <!-- 반복 작업 추가 폼 -->
            <div id="addRecurringForm" class="bg-gray-50 p-4 rounded-lg mb-4 hidden">
                <h3 class="text-lg font-semibold mb-3">새 반복 작업 등록</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">광고주 선택 *</label>
                        <select id="recurringBucketSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">광고주를 선택하세요</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">작업명 *</label>
                        <input type="text" id="recurringTaskName" placeholder="반복 작업명을 입력하세요" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">반복 주기 *</label>
                        <select id="recurringTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="daily">매일</option>
                            <option value="weekly">매주</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">생성 시간 *</label>
                        <input type="time" id="recurringTimeSelect" value="09:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">시작일 *</label>
                        <input type="date" id="recurringStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">종료일</label>
                        <input type="date" id="recurringEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">상태</label>
                        <select id="recurringStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="active">활성</option>
                            <option value="paused">일시정지</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="confirmAddRecurringBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">등록</button>
                    <button id="cancelAddRecurringBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">취소</button>
                </div>
            </div>
            
            <div id="recurringList" class="space-y-3"></div>
            <div id="recurringEmpty" class="text-gray-500 text-center py-8">등록된 반복 작업이 없습니다.</div>
        </div>

        <!-- 메모장 뷰 -->
        <div id="memoView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">메모장</h2>
                <div class="flex gap-2">
                    <button id="saveMemoBtn" class="flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <span>💾</span>
                        <span>저장</span>
                    </button>
                    <button id="clearMemoBtn" class="flex items-center gap-2 px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        <span>🗑️</span>
                        <span>전체 삭제</span>
                    </button>
                </div>
            </div>
            <textarea id="memoTextarea" placeholder="자유롭게 메모를 작성하세요..." class="w-full h-[600px] px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
            <div id="memoStatus" class="mt-2 text-sm text-gray-500"></div>
        </div>

        <!-- 버킷 뷰 -->
        <div id="bucketsView">
            <div id="bucketsContainer" class="grid gap-4 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5"></div>
            <div id="emptyState" class="text-center py-16">
                <div class="text-6xl mb-4">📋</div>
                <p class="text-gray-500 text-xl mb-2">아직 등록된 광고주가 없습니다.</p>
                <p class="text-gray-400">새 광고주를 추가해서 업무 관리를 시작하세요.</p>
            </div>
        </div>
    </div>

    <!-- 푸터 -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-sm">© 2025 광고 프로젝트 관리 시스템 | 제작자: 이재광</p>
        </div>
    </footer>

    <script>
        // Supabase 설정
        const SUPABASE_URL = 'https://spuiuwgiioxohrjnywnn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWl1d2dpaW94b2hyam55d25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNTU2ODQsImV4cCI6MjA2ODgzMTY4NH0.MMJ9y_KzmluQ5AhcU58vkWD_LdwhEalKQ1fbFnZm0LI';
        
        // 전역 변수
        let supabase;
        let buckets = [];
        let recurringTasks = [];
        let userId;
        let currentView = 'buckets';
        let sortOrder = 'asc';
        let collapsedBuckets = {};
        let collapsedContracts = {};
        let editingBucket = null;
        let editingAction = null;
        let showCompletedTodos = true;
        let showCompletedInBuckets = true;
        let selectMode = false;
        let selectedItems = new Set();

        // 기본 액션 아이템
        const defaultActionItems = {
            '대기': ['광고주 요구사항 수집', '예산 및 일정 확정', '계약서 검토'],
            '진행_광고제작': ['크리에이티브 컨셉 기획', '디자인 시안 제작', '광고주 피드백 반영', '최종 소재 승인'],
            '진행_광고운영': ['광고 계정 세팅', '캠페인 런칭', '일일 성과 모니터링', '최적화 작업'],
            '진행_매출정산': ['최종 성과 리포트 작성', '매출 정산', '광고주 결과 보고']
        };

        // DOM 요소들
        let bucketsViewBtn, todoViewBtn, memoViewBtn, addBucketSection, addBucketBtn, addBucketForm;
        let bucketNameInput, unitPriceInput, quantityInput, productInput, contractTermsInput;
        let confirmAddBtn, cancelAddBtn, sortBtn, sortText;
        let todayDeadlines, todayDeadlinesList, todoView, memoView, bucketsView, recurringView;
        let todoList, todoEmpty, todoSortBtn, todoSortText;
        let toggleCompletedBtn, toggleCompletedText, bucketsContainer, emptyState;
        let exportExcelBtn, toggleBucketCompletedBtn, toggleBucketCompletedText;
        let addTodoBtn, addTodoForm, todoBucketSelect, todoDeadlineInput, todoTextInput;
        let confirmAddTodoBtn, cancelAddTodoBtn, memoTextarea, saveMemoBtn, clearMemoBtn, memoStatus;
        let selectAllCheckbox, selectedCount, toggleSelectModeBtn, deleteSelectedBtn;
        let manageRecurringBtn, backToTodoBtn, addRecurringBtn, addRecurringForm;
        let recurringBucketSelect, recurringTaskName, recurringTypeSelect, recurringTimeSelect;
        let recurringStartDate, recurringEndDate, recurringStatus, confirmAddRecurringBtn, cancelAddRecurringBtn;
        let recurringList, recurringEmpty;

        // DOM 요소 초기화
        function initializeElements() {
            bucketsViewBtn = document.getElementById('bucketsViewBtn');
            todoViewBtn = document.getElementById('todoViewBtn');
            memoViewBtn = document.getElementById('memoViewBtn');
            addBucketSection = document.getElementById('addBucketSection');
            addBucketBtn = document.getElementById('addBucketBtn');
            addBucketForm = document.getElementById('addBucketForm');
            bucketNameInput = document.getElementById('bucketNameInput');
            unitPriceInput = document.getElementById('unitPriceInput');
            quantityInput = document.getElementById('quantityInput');
            productInput = document.getElementById('productInput');
            contractTermsInput = document.getElementById('contractTermsInput');
            confirmAddBtn = document.getElementById('confirmAddBtn');
            cancelAddBtn = document.getElementById('cancelAddBtn');
            sortBtn = document.getElementById('sortBtn');
            sortText = document.getElementById('sortText');
            todayDeadlines = document.getElementById('todayDeadlines');
            todayDeadlinesList = document.getElementById('todayDeadlinesList');
            todoView = document.getElementById('todoView');
            memoView = document.getElementById('memoView');
            bucketsView = document.getElementById('bucketsView');
            todoList = document.getElementById('todoList');
            todoEmpty = document.getElementById('todoEmpty');
            todoSortBtn = document.getElementById('todoSortBtn');
            todoSortText = document.getElementById('todoSortText');
            toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
            toggleCompletedText = document.getElementById('toggleCompletedText');
            bucketsContainer = document.getElementById('bucketsContainer');
            emptyState = document.getElementById('emptyState');
            exportExcelBtn = document.getElementById('exportExcelBtn');
            toggleBucketCompletedBtn = document.getElementById('toggleBucketCompletedBtn');
            toggleBucketCompletedText = document.getElementById('toggleBucketCompletedText');
            addTodoBtn = document.getElementById('addTodoBtn');
            addTodoForm = document.getElementById('addTodoForm');
            todoBucketSelect = document.getElementById('todoBucketSelect');
            todoDeadlineInput = document.getElementById('todoDeadlineInput');
            todoTextInput = document.getElementById('todoTextInput');
            confirmAddTodoBtn = document.getElementById('confirmAddTodoBtn');
            cancelAddTodoBtn = document.getElementById('cancelAddTodoBtn');
            memoTextarea = document.getElementById('memoTextarea');
            saveMemoBtn = document.getElementById('saveMemoBtn');
            clearMemoBtn = document.getElementById('clearMemoBtn');
            memoStatus = document.getElementById('memoStatus');
            selectAllCheckbox = document.getElementById('selectAllCheckbox');
            selectedCount = document.getElementById('selectedCount');
            toggleSelectModeBtn = document.getElementById('toggleSelectModeBtn');
            deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            manageRecurringBtn = document.getElementById('manageRecurringBtn');
            backToTodoBtn = document.getElementById('backToTodoBtn');
            addRecurringBtn = document.getElementById('addRecurringBtn');
            addRecurringForm = document.getElementById('addRecurringForm');
            recurringBucketSelect = document.getElementById('recurringBucketSelect');
            recurringTaskName = document.getElementById('recurringTaskName');
            recurringTypeSelect = document.getElementById('recurringTypeSelect');
            recurringTimeSelect = document.getElementById('recurringTimeSelect');
            recurringStartDate = document.getElementById('recurringStartDate');
            recurringEndDate = document.getElementById('recurringEndDate');
            recurringStatus = document.getElementById('recurringStatus');
            confirmAddRecurringBtn = document.getElementById('confirmAddRecurringBtn');
            cancelAddRecurringBtn = document.getElementById('cancelAddRecurringBtn');
            recurringList = document.getElementById('recurringList');
            recurringEmpty = document.getElementById('recurringEmpty');
            recurringView = document.getElementById('recurringView');
        }

        // 이벤트 리스너 등록
        function setupEventListeners() {
            bucketsViewBtn.addEventListener('click', () => switchView('buckets'));
            todoViewBtn.addEventListener('click', () => switchView('todo'));
            memoViewBtn.addEventListener('click', () => switchView('memo'));
            addBucketBtn.addEventListener('click', showAddForm);
            confirmAddBtn.addEventListener('click', addBucket);
            cancelAddBtn.addEventListener('click', hideAddForm);
            sortBtn.addEventListener('click', toggleSort);
            todoSortBtn.addEventListener('click', toggleTodoSort);
            toggleCompletedBtn.addEventListener('click', toggleCompletedVisibility);
            toggleBucketCompletedBtn.addEventListener('click', toggleBucketCompletedVisibility);
            exportExcelBtn.addEventListener('click', exportToExcel);
            addTodoBtn.addEventListener('click', showAddTodoForm);
            confirmAddTodoBtn.addEventListener('click', addTodoItem);
            cancelAddTodoBtn.addEventListener('click', hideAddTodoForm);
            saveMemoBtn.addEventListener('click', saveMemo);
            clearMemoBtn.addEventListener('click', clearMemo);

            bucketNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addBucket();
                }
            });
            
            todoTextInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addTodoItem();
                }
            });

            // 메모 자동저장
            memoTextarea.addEventListener('input', autoSaveMemo);
            
            // 선택 모드 관련
            toggleSelectModeBtn.addEventListener('click', toggleSelectMode);
            selectAllCheckbox.addEventListener('change', toggleSelectAll);
            deleteSelectedBtn.addEventListener('click', deleteSelectedItems);
            
            // 반복 관리 관련
            manageRecurringBtn.addEventListener('click', () => switchView('recurring'));
            backToTodoBtn.addEventListener('click', () => switchView('todo'));
            addRecurringBtn.addEventListener('click', showAddRecurringForm);
            confirmAddRecurringBtn.addEventListener('click', addRecurringTask);
            cancelAddRecurringBtn.addEventListener('click', hideAddRecurringForm);
        }

        // 엑셀 다운로드 기능
        function exportToExcel() {
            try {
                // 모든 액션 아이템 수집
                const allItems = [];
                buckets.forEach(bucket => {
                    (bucket.actions || []).forEach(action => {
                        allItems.push({
                            '광고주ID': bucket.id,
                            '광고주명': bucket.name,
                            '액션아이템': action.text,
                            '마감일자': action.deadline || '',
                            '완료여부': action.completed ? '완료' : '미완료'
                        });
                    });
                });

                if (allItems.length === 0) {
                    alert('다운로드할 데이터가 없습니다.');
                    return;
                }

                // 현재 표시 중인 필터링된 항목만 내보내기 (선택사항)
                let filteredItems = allItems;
                if (currentView === 'todo' && !showCompletedTodos) {
                    filteredItems = allItems.filter(item => item.완료여부 === '미완료');
                } else if (currentView === 'buckets' && !showCompletedInBuckets) {
                    filteredItems = allItems.filter(item => item.완료여부 === '미완료');
                }

                // 워크시트 생성
                const ws = XLSX.utils.json_to_sheet(filteredItems);

                // 열 너비 설정
                const colWidths = [
                    { wch: 10 }, // 광고주ID
                    { wch: 20 }, // 광고주명
                    { wch: 30 }, // 액션아이템
                    { wch: 12 }, // 마감일자
                    { wch: 10 }  // 완료여부
                ];
                ws['!cols'] = colWidths;

                // 워크북 생성
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '액션아이템 목록');

                // 파일명 생성 (현재 날짜 포함)
                const today = new Date();
                const dateString = today.getFullYear() + '-' + 
                    String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(today.getDate()).padStart(2, '0');
                const filename = `광고프로젝트_액션아이템_${dateString}.xlsx`;

                // 파일 다운로드
                XLSX.writeFile(wb, filename);

                // 다운로드 완료 알림
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                notification.textContent = '엑셀 파일이 다운로드되었습니다!';
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);

            } catch (error) {
                console.error('엑셀 내보내기 오류:', error);
                alert('엑셀 파일 생성 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 앱 초기화
        async function initApp() {
            try {
                console.log('앱 초기화 시작');
                
                // Supabase 클라이언트 초기화
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // 사용자 ID 설정
                userId = localStorage.getItem('userId') || 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
                
                // DOM 요소 초기화
                initializeElements();
                
                // 이벤트 리스너 설정
                setupEventListeners();
                
                // 데이터 로드
                await loadData();
                
                // 반복 작업 로드
                loadRecurringTasks();
                
                // 반복 작업 체크 시작
                checkAndCreateRecurringActions();
                
                // 오늘 마감 업데이트
                updateTodayDeadlines();
                
                console.log('앱 초기화 완료');
            } catch (error) {
                console.error('앱 초기화 오류:', error);
                showError('앱 초기화 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 에러 표시
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg';
            errorDiv.innerHTML = `
                <h3 class="font-semibold mb-2">⚠️ 오류 발생</h3>
                <p class="text-sm">${message}</p>
                <button onclick="location.reload()" class="mt-2 px-3 py-1 bg-red-600 text-white rounded text-xs">새로고침</button>
            `;
            document.getElementById('app').insertBefore(errorDiv, document.getElementById('app').firstChild);
        }

        // 데이터 로드
        async function loadData() {
            try {
                console.log('데이터 로드 시작, 현재 뷰:', currentView);
                
                const { data, error } = await supabase
                    .from('buckets')
                    .select('*, actions(*)')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                buckets = data || [];
                console.log('로드된 버킷 수:', buckets.length);
                
                // 현재 뷰에 따라 렌더링
                if (currentView === 'buckets') {
                    console.log('버킷 뷰 렌더링');
                    renderBuckets();
                } else if (currentView === 'todo') {
                    console.log('투두 뷰 렌더링');
                    renderTodoView();
                }
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                buckets = [];
                renderBuckets();
            }
        }

        // 뷰 전환
        function switchView(view) {
            console.log('뷰 전환:', currentView, '->', view);
            currentView = view;
            
            // 모든 탭 버튼 초기화
            bucketsViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            todoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            memoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            
            // 모든 뷰 숨기기
            addBucketSection.classList.add('hidden');
            todoView.classList.add('hidden');
            memoView.classList.add('hidden');
            bucketsView.classList.add('hidden');
            recurringView.classList.add('hidden');
            
            if (view === 'buckets') {
                bucketsViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                addBucketSection.classList.remove('hidden');
                bucketsView.classList.remove('hidden');
                console.log('버킷 뷰로 전환 완료');
            } else if (view === 'todo') {
                todoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                todoView.classList.remove('hidden');
                renderTodoView();
                updateTodoBucketSelect();
                console.log('투두 뷰로 전환 완료');
            } else if (view === 'memo') {
                memoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                memoView.classList.remove('hidden');
                loadMemo();
                console.log('메모 뷰로 전환 완료');
            } else if (view === 'recurring') {
                recurringView.classList.remove('hidden');
                renderRecurringView();
                updateRecurringBucketSelect();
                console.log('반복 관리 뷰로 전환 완료');
            }
        }

        // 정렬 토글
        function toggleSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            sortText.textContent = `마감일 ${sortOrder === 'asc' ? '오름차순' : '내림차순'}`;
            if (currentView === 'buckets') {
                renderBuckets();
            }
        }

        function toggleTodoSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            todoSortText.textContent = `마감일 ${sortOrder === 'asc' ? '오름차순' : '내림차순'}`;
            if (currentView === 'todo') {
                renderTodoView();
            }
        }

        // 완료된 투두 가시성 토글
        function toggleCompletedVisibility() {
            showCompletedTodos = !showCompletedTodos;
            
            if (showCompletedTodos) {
                toggleCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors';
                toggleCompletedText.textContent = '완료항목 숨기기';
            } else {
                toggleCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors';
                toggleCompletedText.textContent = '완료항목 보기';
            }
            
            if (currentView === 'todo') {
                renderTodoView();
            }
        }

        // 버킷 뷰에서 완료된 액션아이템 가시성 토글
        function toggleBucketCompletedVisibility() {
            showCompletedInBuckets = !showCompletedInBuckets;
            
            if (showCompletedInBuckets) {
                toggleBucketCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors';
                toggleBucketCompletedText.textContent = '완료항목 숨기기';
            } else {
                toggleBucketCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors';
                toggleBucketCompletedText.textContent = '완료항목 보기';
            }
            
            if (currentView === 'buckets') {
                renderBuckets();
            }
        }

        // 오늘 마감 업데이트
        function updateTodayDeadlines() {
            const today = new Date().toISOString().split('T')[0];
            const todayItems = [];
            
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    if (action.deadline === today && !action.completed) {
                        todayItems.push({
                            bucketName: bucket.name,
                            actionText: action.text
                        });
                    }
                });
            });

            if (todayItems.length > 0) {
                todayDeadlinesList.innerHTML = todayItems.map(item => 
                    `<p class="text-red-600 text-sm">• [${item.bucketName}] ${item.actionText}</p>`
                ).join('');
                todayDeadlines.classList.remove('hidden');
            } else {
                todayDeadlines.classList.add('hidden');
            }
        }

        // 추가 폼 관련
        function showAddForm() {
            addBucketForm.classList.remove('hidden');
            bucketNameInput.focus();
        }

        function hideAddForm() {
            addBucketForm.classList.add('hidden');
            bucketNameInput.value = '';
            unitPriceInput.value = '';
            quantityInput.value = '';
            productInput.value = '';
            contractTermsInput.value = '';
        }

        // 새 버킷 추가
        async function addBucket() {
            const name = bucketNameInput.value.trim();
            if (!name) {
                alert('광고주명은 필수입니다.');
                return;
            }

            try {
                confirmAddBtn.disabled = true;
                confirmAddBtn.textContent = '추가 중...';

                const bucketData = {
                    name: name,
                    stage: '대기',
                    user_id: userId,
                    unit_price: unitPriceInput.value.trim(),
                    quantity: quantityInput.value.trim(),
                    product: productInput.value.trim(),
                    contract_terms: contractTermsInput.value.trim()
                };

                const { data: newBucket, error: bucketError } = await supabase
                    .from('buckets')
                    .insert([bucketData])
                    .select()
                    .single();

                if (bucketError) throw bucketError;

                const actionsToInsert = defaultActionItems['대기'].map((action, index) => ({
                    bucket_id: newBucket.id,
                    text: action,
                    completed: false,
                    deadline: null,
                    order_index: index
                }));

                const { error: actionsError } = await supabase
                    .from('actions')
                    .insert(actionsToInsert);

                if (actionsError) throw actionsError;

                hideAddForm();
                
                // 데이터 다시 로드하고 버킷뷰 렌더링
                await loadData();
                updateTodayDeadlines();
                
            } catch (error) {
                console.error('버킷 추가 오류:', error);
                alert('오류가 발생했습니다: ' + error.message);
            } finally {
                confirmAddBtn.disabled = false;
                confirmAddBtn.textContent = '추가';
            }
        }

        // 액션 아이템 정렬 (버킷 뷰용 - 완료된 항목을 하단으로)
        function getSortedActions(actions) {
            // 완료 여부로 먼저 분리
            const incompleteActions = actions.filter(action => !action.completed);
            const completedActions = actions.filter(action => action.completed);
            
            // 각각을 마감일로 정렬
            const sortedIncomplete = incompleteActions.sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return sortOrder === 'asc' ? 1 : -1;
                if (!b.deadline) return sortOrder === 'asc' ? -1 : 1;
                
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            const sortedCompleted = completedActions.sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return sortOrder === 'asc' ? 1 : -1;
                if (!b.deadline) return sortOrder === 'asc' ? -1 : 1;
                
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            // 미완료를 위에, 완료를 아래에 배치
            return [...sortedIncomplete, ...sortedCompleted];
        }

        // 투두뷰용 액션 아이템 정렬 (완료된 항목을 하단으로)
        function getSortedActionsForTodo(actions) {
            // 완료 여부로 먼저 분리
            const incompleteActions = actions.filter(action => !action.completed);
            const completedActions = actions.filter(action => action.completed);
            
            // 각각을 마감일로 정렬
            const sortedIncomplete = incompleteActions.sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return sortOrder === 'asc' ? 1 : -1;
                if (!b.deadline) return sortOrder === 'asc' ? -1 : 1;
                
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            const sortedCompleted = completedActions.sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return sortOrder === 'asc' ? 1 : -1;
                if (!b.deadline) return sortOrder === 'asc' ? -1 : 1;
                
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            // 미완료를 위에, 완료를 아래에 배치
            return [...sortedIncomplete, ...sortedCompleted];
        }

        // 투두뷰 렌더링
        function renderTodoView() {
            const allItems = [];
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    allItems.push({
                        ...action,
                        bucketName: bucket.name,
                        bucketId: bucket.id,
                        bucketStage: bucket.stage
                    });
                });
            });

            let filteredItems = allItems;
            if (!showCompletedTodos) {
                filteredItems = allItems.filter(item => !item.completed);
            }

            const incompleteItems = filteredItems.filter(item => !item.completed);
            const completedItems = filteredItems.filter(item => item.completed);
            
            const sortedIncompleteItems = getSortedActionsForTodo(incompleteItems);
            const sortedCompletedItems = getSortedActionsForTodo(completedItems);
            
            const sortedItems = [...sortedIncompleteItems, ...sortedCompletedItems];

            if (sortedItems.length === 0) {
                todoList.classList.add('hidden');
                todoEmpty.classList.remove('hidden');
                return;
            }

            todoList.classList.remove('hidden');
            todoEmpty.classList.add('hidden');

            todoList.innerHTML = sortedItems.map(action => {
                const today = new Date().toISOString().split('T')[0];
                const isToday = action.deadline === today && !action.completed;
                const isSelected = selectedItems.has(action.id);
                
                return `
                    <div class="flex items-center justify-between p-3 rounded-lg border ${action.completed ? 'bg-gray-50 border-gray-200' : 'bg-white border-gray-200'} ${isSelected ? 'ring-2 ring-blue-500' : ''}">
                        <div class="flex items-center gap-3 flex-1">
                            ${selectMode ? `
                                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleItemSelection(${action.id})" class="w-4 h-4 flex-shrink-0">
                            ` : ''}
                            <button onclick="toggleActionItem(${action.bucketId}, ${action.id})" class="flex-shrink-0 text-lg">
                                ${action.completed ? '✅' : '⭕'}
                            </button>
                            <div class="flex-1">
                                <p class="text-sm font-medium ${action.completed ? 'line-through text-gray-500' : 'text-gray-800'}">
                                    ${action.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                                </p>
                                <p class="text-xs ${action.completed ? 'text-gray-400' : 'text-gray-500'}">
                                    [${action.bucketName}] - ${action.bucketStage}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="date" value="${action.deadline || ''}" onchange="setDeadline(${action.bucketId}, ${action.id}, this.value)" class="px-2 py-1 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${isToday ? 'border-red-500 bg-red-50' : 'border-gray-200'} ${action.completed ? 'text-gray-400' : ''}"/>
                            ${!selectMode ? `
                                <button onclick="deleteActionItem(${action.bucketId}, ${action.id})" class="text-red-500 hover:text-red-700">
                                    🗑️
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 버킷 목록 렌더링
        function renderBuckets() {
            console.log('renderBuckets 호출됨, 버킷 수:', buckets.length);
            
            if (buckets.length === 0) {
                console.log('버킷이 없어서 empty state 표시');
                emptyState.classList.remove('hidden');
                bucketsContainer.innerHTML = '';
                return;
            }

            console.log('버킷들을 렌더링 중...');
            emptyState.classList.add('hidden');
            bucketsContainer.innerHTML = '';

            buckets.forEach((bucket, index) => {
                console.log(`버킷 ${index} 렌더링:`, bucket.name);
                const bucketElement = createBucketElement(bucket);
                bucketsContainer.appendChild(bucketElement);
            });
            
            console.log('버킷 렌더링 완료');
        }

        // 버킷 요소 생성
        function createBucketElement(bucket) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-md p-4';

            const actions = bucket.actions || [];
            const sortedActions = getSortedActions(actions);
            const isCollapsed = collapsedBuckets[bucket.id] === true;
            const isContractCollapsed = collapsedContracts[bucket.id] === true;

            div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <button onclick="toggleBucketCollapse(${bucket.id})" class="text-gray-600 hover:text-gray-800">
                                ${isCollapsed ? '▶' : '▼'}
                            </button>
                            ${editingBucket === bucket.id ? `
                                <input type="text" value="${bucket.name.replace(/"/g, '&quot;')}" 
                                       onkeypress="if(event.key==='Enter') saveEditBucket(${bucket.id}, this.value); if(event.key==='Escape') cancelEditBucket();"
                                       onblur="saveEditBucket(${bucket.id}, this.value)"
                                       class="flex-1 px-2 py-1 text-sm font-semibold border border-blue-500 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                       autofocus />
                                <button onclick="cancelEditBucket()" class="text-red-500 hover:text-red-700 text-sm">✕</button>
                            ` : `
                                <h3 class="text-sm font-semibold text-gray-800 flex-1">${bucket.name}</h3>
                                <button onclick="startEditBucket(${bucket.id})" class="text-gray-400 hover:text-gray-600 text-sm">✏️</button>
                            `}
                        </div>
                    </div>
                    <button onclick="deleteBucket(${bucket.id})" class="text-red-500 hover:text-red-700 text-sm">
                        🗑️
                    </button>
                </div>

                ${!isCollapsed ? `
                    <!-- 단계 선택 -->
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-700 mb-1">단계</label>
                        <select onchange="changeStage(${bucket.id}, this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="대기" ${bucket.stage === '대기' ? 'selected' : ''}>대기</option>
                            <option value="진행_광고제작" ${bucket.stage === '진행_광고제작' ? 'selected' : ''}>진행_광고제작</option>
                            <option value="진행_광고운영" ${bucket.stage === '진행_광고운영' ? 'selected' : ''}>진행_광고운영</option>
                            <option value="진행_매출정산" ${bucket.stage === '진행_매출정산' ? 'selected' : ''}>진행_매출정산</option>
                        </select>
                    </div>

                    <!-- 계약 정보 -->
                    <div class="mb-3 p-3 bg-gray-50 rounded">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs font-medium text-gray-700">계약 정보</h4>
                            <button onclick="toggleContractCollapse(${bucket.id})" class="text-gray-600 hover:text-gray-800">
                                ${isContractCollapsed ? '▶' : '▼'}
                            </button>
                        </div>
                        
                        ${!isContractCollapsed ? `
                            <div class="grid grid-cols-1 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">단가 (원)</label>
                                    <input type="text" value="${bucket.unit_price || ''}" onchange="updateBucketInfo(${bucket.id}, 'unit_price', this.value)" placeholder="예: 1,000,000" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"/>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">수량</label>
                                    <input type="text" value="${bucket.quantity || ''}" onchange="updateBucketInfo(${bucket.id}, 'quantity', this.value)" placeholder="예: 100회 노출" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"/>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">상품</label>
                                    <select onchange="updateBucketInfo(${bucket.id}, 'product', this.value)" class="w-full px-2 py-
