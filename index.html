<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´‘ê³  í”„ë¡œì íŠ¸ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-6">
        <!-- í—¤ë” -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-3">ğŸ“Š ê´‘ê³  í”„ë¡œì íŠ¸ ê´€ë¦¬</h1>
            <p class="text-gray-600 text-lg">ê´‘ê³ ì£¼ë³„ ë²„í‚·ìœ¼ë¡œ ì—…ë¬´ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>

        <!-- ì˜¤ëŠ˜ ë§ˆê° ì•Œë¦¼ -->
        <div id="todayDeadlines" class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg hidden">
            <div class="flex items-center mb-2">
                <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                <h3 class="text-red-700 font-semibold">ì˜¤ëŠ˜ ë§ˆê°ì¸ ì—…ë¬´</h3>
            </div>
            <div id="todayDeadlinesList"></div>
        </div>

        <!-- ë·° ì „í™˜ íƒ­ -->
        <div class="mb-6">
            <div class="flex border-b border-gray-200">
                <button id="bucketsViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600">
                    ë²„í‚· ë·°
                </button>
                <button id="todoViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    íˆ¬ë‘ë¦¬ìŠ¤íŠ¸
                </button>
                <button id="memoViewBtn" class="px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    ë©”ëª¨ì¥
                </button>
            </div>
        </div>

        <!-- ìƒˆ ë²„í‚· ì¶”ê°€ ì„¹ì…˜ -->
        <div id="addBucketSection" class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <button id="addBucketBtn" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    â• ìƒˆ ê´‘ê³ ì£¼ ì¶”ê°€
                </button>
                <div class="flex gap-2">
                    <button id="toggleBucketCompletedBtn" class="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm">
                        <span>ğŸ‘ï¸</span>
                        <span id="toggleBucketCompletedText">ì™„ë£Œí•­ëª© ìˆ¨ê¸°ê¸°</span>
                    </button>
                    <button id="sortBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        <span>ğŸ“…</span>
                        <span id="sortText">ë§ˆê°ì¼ ì˜¤ë¦„ì°¨ìˆœ</span>
                    </button>
                </div>
            </div>
            
            <!-- ì¶”ê°€ í¼ -->
            <div id="addBucketForm" class="bg-white p-6 rounded-lg shadow hidden">
                <h3 class="text-lg font-semibold mb-4">ìƒˆ ê´‘ê³ ì£¼ ì •ë³´</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê´‘ê³ ì£¼ëª… *</label>
                        <input type="text" id="bucketNameInput" placeholder="ê´‘ê³ ì£¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë‹¨ê°€ (ì›)</label>
                        <input type="text" id="unitPriceInput" placeholder="ì˜ˆ: 1,000,000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ˜ëŸ‰</label>
                        <input type="text" id="quantityInput" placeholder="ì˜ˆ: 100íšŒ ë…¸ì¶œ" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìƒí’ˆ</label>
                        <select id="productInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">ìƒí’ˆ ì„ íƒ</option>
                            <option value="CPM">CPM</option>
                            <option value="CPA">CPA</option>
                            <option value="CPA+">CPA+</option>
                            <option value="CPR">CPR</option>
                            <option value="CPR+">CPR+</option>
                            <option value="CPS">CPS</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê³„ì•½ì¡°ê±´ ë° ê¸°íƒ€ì‚¬í•­</label>
                    <textarea id="contractTermsInput" placeholder="ê³„ì•½ ì¡°ê±´ ë° ê¸°íƒ€ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                </div>
                <div class="flex gap-3">
                    <button id="confirmAddBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ì¶”ê°€</button>
                    <button id="cancelAddBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>

        <!-- ë²„í‚· ë·° -->
        <div id="bucketsView">
            <div id="bucketsContainer" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div>
            <div id="emptyState" class="text-center py-16">
                <div class="text-6xl mb-4">ğŸ“‹</div>
                <p class="text-gray-500 text-xl mb-2">ì•„ì§ ë“±ë¡ëœ ê´‘ê³ ì£¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                <p class="text-gray-400">ìƒˆ ê´‘ê³ ì£¼ë¥¼ ì¶”ê°€í•´ì„œ ì—…ë¬´ ê´€ë¦¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
            </div>
        </div>

        <!-- íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ë·° -->
        <div id="todoView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">ì „ì²´ ì•¡ì…˜ì•„ì´í…œ</h2>
                <div class="flex gap-2">
                    <button id="addTodoBtn" class="flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        <span>â•</span>
                        <span>ìƒˆ ì•¡ì…˜ì•„ì´í…œ</span>
                    </button>
                    <button id="manageRecurringBtn" class="flex items-center gap-2 px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                        <span>ğŸ”„</span>
                        <span>ë°˜ë³µ ê´€ë¦¬</span>
                    </button>
                    <button id="exportExcelBtn" class="flex items-center gap-2 px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                        <span>ğŸ“Š</span>
                        <span>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</span>
                    </button>
                    <button id="toggleCompletedBtn" class="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm">
                        <span>ğŸ‘ï¸</span>
                        <span id="toggleCompletedText">ì™„ë£Œí•­ëª© ìˆ¨ê¸°ê¸°</span>
                    </button>
                    <button id="todoSortBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                        <span>ğŸ“…</span>
                        <span id="todoSortText">ë§ˆê°ì¼ ì˜¤ë¦„ì°¨ìˆœ</span>
                    </button>
                </div>
            </div>
            
            <!-- ìƒˆ ì•¡ì…˜ì•„ì´í…œ ì¶”ê°€ í¼ -->
            <div id="addTodoForm" class="bg-gray-50 p-4 rounded-lg mb-4 hidden">
                <h3 class="text-lg font-semibold mb-3">ìƒˆ ì•¡ì…˜ì•„ì´í…œ ì¶”ê°€</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê´‘ê³ ì£¼ ì„ íƒ *</label>
                        <select id="todoBucketSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">ê´‘ê³ ì£¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë§ˆê°ì¼</label>
                        <input type="date" id="todoDeadlineInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì•¡ì…˜ì•„ì´í…œ ë‚´ìš© *</label>
                    <input type="text" id="todoTextInput" placeholder="ì•¡ì…˜ì•„ì´í…œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex gap-3">
                    <button id="confirmAddTodoBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ì¶”ê°€</button>
                    <button id="cancelAddTodoBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
                </div>
            </div>
            
            <div id="todoList" class="space-y-3"></div>
            <div id="todoEmpty" class="text-gray-500 text-center py-8 hidden">ë“±ë¡ëœ ì•¡ì…˜ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <!-- ë°˜ë³µ ê´€ë¦¬ ë·° -->
        <div id="recurringView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">ë°˜ë³µ ì‘ì—… ê´€ë¦¬</h2>
                <div class="flex gap-2">
                    <button id="addRecurringBtn" class="flex items-center gap-2 px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm">
                        <span>â•</span>
                        <span>ìƒˆ ë°˜ë³µ ì‘ì—…</span>
                    </button>
                    <button id="backToTodoBtn" class="flex items-center gap-2 px-3 py-1 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm">
                        <span>â†</span>
                        <span>ëŒì•„ê°€ê¸°</span>
                    </button>
                </div>
            </div>
            
            <!-- ë°˜ë³µ ì‘ì—… ì¶”ê°€ í¼ -->
            <div id="addRecurringForm" class="bg-gray-50 p-4 rounded-lg mb-4 hidden">
                <h3 class="text-lg font-semibold mb-3">ìƒˆ ë°˜ë³µ ì‘ì—… ë“±ë¡</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê´‘ê³ ì£¼ ì„ íƒ *</label>
                        <select id="recurringBucketSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">ê´‘ê³ ì£¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì‘ì—…ëª… *</label>
                        <input type="text" id="recurringTaskName" placeholder="ë°˜ë³µ ì‘ì—…ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë°˜ë³µ ì£¼ê¸° *</label>
                        <select id="recurringTypeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="daily">ë§¤ì¼</option>
                            <option value="weekly">ë§¤ì£¼</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìƒì„± ì‹œê°„ *</label>
                        <input type="time" id="recurringTimeSelect" value="09:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì‹œì‘ì¼ *</label>
                        <input type="date" id="recurringStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì¢…ë£Œì¼</label>
                        <input type="date" id="recurringEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìƒíƒœ</label>
                        <select id="recurringStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="active">í™œì„±</option>
                            <option value="paused">ì¼ì‹œì •ì§€</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="confirmAddRecurringBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">ë“±ë¡</button>
                    <button id="cancelAddRecurringBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">ì·¨ì†Œ</button>
                </div>
            </div>
            
            <div id="recurringList" class="space-y-3"></div>
            <div id="recurringEmpty" class="text-gray-500 text-center py-8">ë“±ë¡ëœ ë°˜ë³µ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <!-- ë©”ëª¨ì¥ ë·° -->
        <div id="memoView" class="bg-white rounded-lg shadow-md p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">ë©”ëª¨ì¥</h2>
                <div class="flex gap-2">
                    <button id="saveMemoBtn" class="flex items-center gap-2 px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        <span>ğŸ’¾</span>
                        <span>ì €ì¥</span>
                    </button>
                    <button id="clearMemoBtn" class="flex items-center gap-2 px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">
                        <span>ğŸ—‘ï¸</span>
                        <span>ì „ì²´ ì‚­ì œ</span>
                    </button>
                </div>
            </div>
            <textarea id="memoTextarea" placeholder="ììœ ë¡­ê²Œ ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”..." class="w-full h-[600px] px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
            <div id="memoStatus" class="mt-2 text-sm text-gray-500"></div>
        </div>
    </div>

    <!-- í‘¸í„° -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="max-w-7xl mx-auto px-6 text-center">
            <p class="text-sm">Â© 2025 ê´‘ê³  í”„ë¡œì íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ | ì œì‘ì: ì´ì¬ê´‘</p>
        </div>
    </footer>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://spuiuwgiioxohrjnywnn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdWl1d2dpaW94b2hyam55d25uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNTU2ODQsImV4cCI6MjA2ODgzMTY4NH0.MMJ9y_KzmluQ5AhcU58vkWD_LdwhEalKQ1fbFnZm0LI';
        
        // ì „ì—­ ë³€ìˆ˜
        let supabase;
        let buckets = [];
        let recurringTasks = [];
        let userId;
        let currentView = 'buckets';
        let sortOrder = 'asc';
        let collapsedBuckets = {};
        let collapsedContracts = {};
        let editingBucket = null;
        let editingAction = null;
        let showCompletedTodos = true;
        let showCompletedInBuckets = true;

        // ê¸°ë³¸ ì•¡ì…˜ ì•„ì´í…œ
        const defaultActionItems = {
            'ëŒ€ê¸°': ['ê´‘ê³ ì£¼ ìš”êµ¬ì‚¬í•­ ìˆ˜ì§‘', 'ì˜ˆì‚° ë° ì¼ì • í™•ì •', 'ê³„ì•½ì„œ ê²€í† '],
            'ì§„í–‰_ê´‘ê³ ì œì‘': ['í¬ë¦¬ì—ì´í‹°ë¸Œ ì»¨ì…‰ ê¸°íš', 'ë””ìì¸ ì‹œì•ˆ ì œì‘', 'ê´‘ê³ ì£¼ í”¼ë“œë°± ë°˜ì˜', 'ìµœì¢… ì†Œì¬ ìŠ¹ì¸'],
            'ì§„í–‰_ê´‘ê³ ìš´ì˜': ['ê´‘ê³  ê³„ì • ì„¸íŒ…', 'ìº í˜ì¸ ëŸ°ì¹­', 'ì¼ì¼ ì„±ê³¼ ëª¨ë‹ˆí„°ë§', 'ìµœì í™” ì‘ì—…'],
            'ì§„í–‰_ë§¤ì¶œì •ì‚°': ['ìµœì¢… ì„±ê³¼ ë¦¬í¬íŠ¸ ì‘ì„±', 'ë§¤ì¶œ ì •ì‚°', 'ê´‘ê³ ì£¼ ê²°ê³¼ ë³´ê³ ']
        };

        // DOM ìš”ì†Œë“¤
        let bucketsViewBtn, todoViewBtn, memoViewBtn, addBucketSection, addBucketBtn, addBucketForm;
        let bucketNameInput, unitPriceInput, quantityInput, productInput, contractTermsInput;
        let confirmAddBtn, cancelAddBtn, sortBtn, sortText;
        let todayDeadlines, todayDeadlinesList, todoView, memoView, bucketsView, recurringView;
        let todoList, todoEmpty, todoSortBtn, todoSortText;
        let toggleCompletedBtn, toggleCompletedText, bucketsContainer, emptyState;
        let exportExcelBtn, toggleBucketCompletedBtn, toggleBucketCompletedText;
        let addTodoBtn, addTodoForm, todoBucketSelect, todoDeadlineInput, todoTextInput;
        let confirmAddTodoBtn, cancelAddTodoBtn, memoTextarea, saveMemoBtn, clearMemoBtn, memoStatus;
        let manageRecurringBtn, backToTodoBtn, addRecurringBtn, addRecurringForm;
        let recurringBucketSelect, recurringTaskName, recurringTypeSelect, recurringTimeSelect;
        let recurringStartDate, recurringEndDate, recurringStatus, confirmAddRecurringBtn, cancelAddRecurringBtn;
        let recurringList, recurringEmpty;

        // ì•± ì´ˆê¸°í™”
        async function initApp() {
            try {
                console.log('ì•± ì´ˆê¸°í™” ì‹œì‘');
                
                // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                // ì‚¬ìš©ì ID ì„¤ì •
                userId = localStorage.getItem('userId') || 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
                
                // DOM ìš”ì†Œ ì´ˆê¸°í™”
                initializeElements();
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                setupEventListeners();
                
                // ë°ì´í„° ë¡œë“œ
                await loadData();
                
                // ë°˜ë³µ ì‘ì—… ë¡œë“œ
                loadRecurringTasks();
                
                // ë°˜ë³µ ì‘ì—… ì²´í¬ ì‹œì‘
                checkAndCreateRecurringActions();
                setInterval(checkAndCreateRecurringActions, 60000); // 1ë¶„ë§ˆë‹¤ ì²´í¬
                
                // ì˜¤ëŠ˜ ë§ˆê° ì—…ë°ì´íŠ¸
                updateTodayDeadlines();
                
                console.log('ì•± ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('ì•± ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                showError('ì•± ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // DOM ìš”ì†Œ ì´ˆê¸°í™”
        function initializeElements() {
            bucketsViewBtn = document.getElementById('bucketsViewBtn');
            todoViewBtn = document.getElementById('todoViewBtn');
            memoViewBtn = document.getElementById('memoViewBtn');
            addBucketSection = document.getElementById('addBucketSection');
            addBucketBtn = document.getElementById('addBucketBtn');
            addBucketForm = document.getElementById('addBucketForm');
            bucketNameInput = document.getElementById('bucketNameInput');
            unitPriceInput = document.getElementById('unitPriceInput');
            quantityInput = document.getElementById('quantityInput');
            productInput = document.getElementById('productInput');
            contractTermsInput = document.getElementById('contractTermsInput');
            confirmAddBtn = document.getElementById('confirmAddBtn');
            cancelAddBtn = document.getElementById('cancelAddBtn');
            sortBtn = document.getElementById('sortBtn');
            sortText = document.getElementById('sortText');
            todayDeadlines = document.getElementById('todayDeadlines');
            todayDeadlinesList = document.getElementById('todayDeadlinesList');
            todoView = document.getElementById('todoView');
            memoView = document.getElementById('memoView');
            bucketsView = document.getElementById('bucketsView');
            recurringView = document.getElementById('recurringView');
            todoList = document.getElementById('todoList');
            todoEmpty = document.getElementById('todoEmpty');
            todoSortBtn = document.getElementById('todoSortBtn');
            todoSortText = document.getElementById('todoSortText');
            toggleCompletedBtn = document.getElementById('toggleCompletedBtn');
            toggleCompletedText = document.getElementById('toggleCompletedText');
            bucketsContainer = document.getElementById('bucketsContainer');
            emptyState = document.getElementById('emptyState');
            exportExcelBtn = document.getElementById('exportExcelBtn');
            toggleBucketCompletedBtn = document.getElementById('toggleBucketCompletedBtn');
            toggleBucketCompletedText = document.getElementById('toggleBucketCompletedText');
            addTodoBtn = document.getElementById('addTodoBtn');
            addTodoForm = document.getElementById('addTodoForm');
            todoBucketSelect = document.getElementById('todoBucketSelect');
            todoDeadlineInput = document.getElementById('todoDeadlineInput');
            todoTextInput = document.getElementById('todoTextInput');
            confirmAddTodoBtn = document.getElementById('confirmAddTodoBtn');
            cancelAddTodoBtn = document.getElementById('cancelAddTodoBtn');
            memoTextarea = document.getElementById('memoTextarea');
            saveMemoBtn = document.getElementById('saveMemoBtn');
            clearMemoBtn = document.getElementById('clearMemoBtn');
            memoStatus = document.getElementById('memoStatus');
            
            // ë°˜ë³µ ê´€ë¦¬ ê´€ë ¨ DOM ìš”ì†Œë“¤
            manageRecurringBtn = document.getElementById('manageRecurringBtn');
            backToTodoBtn = document.getElementById('backToTodoBtn');
            addRecurringBtn = document.getElementById('addRecurringBtn');
            addRecurringForm = document.getElementById('addRecurringForm');
            recurringBucketSelect = document.getElementById('recurringBucketSelect');
            recurringTaskName = document.getElementById('recurringTaskName');
            recurringTypeSelect = document.getElementById('recurringTypeSelect');
            recurringTimeSelect = document.getElementById('recurringTimeSelect');
            recurringStartDate = document.getElementById('recurringStartDate');
            recurringEndDate = document.getElementById('recurringEndDate');
            recurringStatus = document.getElementById('recurringStatus');
            confirmAddRecurringBtn = document.getElementById('confirmAddRecurringBtn');
            cancelAddRecurringBtn = document.getElementById('cancelAddRecurringBtn');
            recurringList = document.getElementById('recurringList');
            recurringEmpty = document.getElementById('recurringEmpty');
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        function setupEventListeners() {
            bucketsViewBtn.addEventListener('click', () => switchView('buckets'));
            todoViewBtn.addEventListener('click', () => switchView('todo'));
            memoViewBtn.addEventListener('click', () => switchView('memo'));
            addBucketBtn.addEventListener('click', showAddForm);
            confirmAddBtn.addEventListener('click', addBucket);
            cancelAddBtn.addEventListener('click', hideAddForm);
            sortBtn.addEventListener('click', toggleSort);
            todoSortBtn.addEventListener('click', toggleTodoSort);
            toggleCompletedBtn.addEventListener('click', toggleCompletedVisibility);
            toggleBucketCompletedBtn.addEventListener('click', toggleBucketCompletedVisibility);
            exportExcelBtn.addEventListener('click', exportToExcel);
            addTodoBtn.addEventListener('click', showAddTodoForm);
            confirmAddTodoBtn.addEventListener('click', addTodoItem);
            cancelAddTodoBtn.addEventListener('click', hideAddTodoForm);
            saveMemoBtn.addEventListener('click', saveMemo);
            clearMemoBtn.addEventListener('click', clearMemo);

            bucketNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addBucket();
                }
            });
            
            todoTextInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addTodoItem();
                }
            });

            // ë©”ëª¨ ìë™ì €ì¥
            memoTextarea.addEventListener('input', autoSaveMemo);
            
            // ë°˜ë³µ ê´€ë¦¬ ê´€ë ¨
            manageRecurringBtn.addEventListener('click', () => switchView('recurring'));
            backToTodoBtn.addEventListener('click', () => switchView('todo'));
            addRecurringBtn.addEventListener('click', showAddRecurringForm);
            confirmAddRecurringBtn.addEventListener('click', addRecurringTask);
            cancelAddRecurringBtn.addEventListener('click', hideAddRecurringForm);
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg';
            errorDiv.innerHTML = `
                <h3 class="font-semibold mb-2">âš ï¸ ì˜¤ë¥˜ ë°œìƒ</h3>
                <p class="text-sm">${message}</p>
                <button onclick="location.reload()" class="mt-2 px-3 py-1 bg-red-600 text-white rounded text-xs">ìƒˆë¡œê³ ì¹¨</button>
            `;
            document.getElementById('app').insertBefore(errorDiv, document.getElementById('app').firstChild);
        }

        // ë°ì´í„° ë¡œë“œ (Supabase ì‚¬ìš©í•˜ì§€ ì•Šê³  ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©)
        async function loadData() {
            try {
                console.log('ë°ì´í„° ë¡œë“œ ì‹œì‘');
                
                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¡œë“œ
                const savedData = localStorage.getItem(`buckets_${userId}`);
                buckets = savedData ? JSON.parse(savedData) : [];
                
                console.log('ë¡œë“œëœ ë²„í‚· ìˆ˜:', buckets.length);
                
                // í˜„ì¬ ë·°ì— ë”°ë¼ ë Œë”ë§
                if (currentView === 'buckets') {
                    renderBuckets();
                } else if (currentView === 'todo') {
                    renderTodoView();
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                buckets = [];
                renderBuckets();
            }
        }

        // ë°ì´í„° ì €ì¥
        function saveData() {
            localStorage.setItem(`buckets_${userId}`, JSON.stringify(buckets));
        }

        // ë·° ì „í™˜
        function switchView(view) {
            currentView = view;
            
            // ëª¨ë“  íƒ­ ë²„íŠ¼ ì´ˆê¸°í™”
            bucketsViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            todoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            memoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-transparent text-gray-500 hover:text-gray-700';
            
            // ëª¨ë“  ë·° ìˆ¨ê¸°ê¸°
            addBucketSection.classList.add('hidden');
            todoView.classList.add('hidden');
            memoView.classList.add('hidden');
            bucketsView.classList.add('hidden');
            recurringView.classList.add('hidden');
            
            if (view === 'buckets') {
                bucketsViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                addBucketSection.classList.remove('hidden');
                bucketsView.classList.remove('hidden');
                renderBuckets();
            } else if (view === 'todo') {
                todoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                todoView.classList.remove('hidden');
                renderTodoView();
                updateTodoBucketSelect();
            } else if (view === 'memo') {
                memoViewBtn.className = 'px-4 py-2 font-medium text-sm border-b-2 border-blue-500 text-blue-600';
                memoView.classList.remove('hidden');
                loadMemo();
            } else if (view === 'recurring') {
                recurringView.classList.remove('hidden');
                renderRecurringView();
                updateRecurringBucketSelect();
            }
        }

        // ì •ë ¬ í† ê¸€
        function toggleSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            sortText.textContent = `ë§ˆê°ì¼ ${sortOrder === 'asc' ? 'ì˜¤ë¦„ì°¨ìˆœ' : 'ë‚´ë¦¼ì°¨ìˆœ'}`;
            if (currentView === 'buckets') {
                renderBuckets();
            }
        }

        function toggleTodoSort() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            todoSortText.textContent = `ë§ˆê°ì¼ ${sortOrder === 'asc' ? 'ì˜¤ë¦„ì°¨ìˆœ' : 'ë‚´ë¦¼ì°¨ìˆœ'}`;
            if (currentView === 'todo') {
                renderTodoView();
            }
        }

        // ì™„ë£Œëœ íˆ¬ë‘ ê°€ì‹œì„± í† ê¸€
        function toggleCompletedVisibility() {
            showCompletedTodos = !showCompletedTodos;
            
            if (showCompletedTodos) {
                toggleCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm';
                toggleCompletedText.textContent = 'ì™„ë£Œí•­ëª© ìˆ¨ê¸°ê¸°';
            } else {
                toggleCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm';
                toggleCompletedText.textContent = 'ì™„ë£Œí•­ëª© ë³´ê¸°';
            }
            
            if (currentView === 'todo') {
                renderTodoView();
            }
        }

        // ë²„í‚· ë·°ì—ì„œ ì™„ë£Œëœ ì•¡ì…˜ì•„ì´í…œ ê°€ì‹œì„± í† ê¸€
        function toggleBucketCompletedVisibility() {
            showCompletedInBuckets = !showCompletedInBuckets;
            
            if (showCompletedInBuckets) {
                toggleBucketCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors text-sm';
                toggleBucketCompletedText.textContent = 'ì™„ë£Œí•­ëª© ìˆ¨ê¸°ê¸°';
            } else {
                toggleBucketCompletedBtn.className = 'flex items-center gap-2 px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm';
                toggleBucketCompletedText.textContent = 'ì™„ë£Œí•­ëª© ë³´ê¸°';
            }
            
            if (currentView === 'buckets') {
                renderBuckets();
            }
        }

        // ì˜¤ëŠ˜ ë§ˆê° ì—…ë°ì´íŠ¸
        function updateTodayDeadlines() {
            const today = new Date().toISOString().split('T')[0];
            const todayItems = [];
            
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    if (action.deadline === today && !action.completed) {
                        todayItems.push({
                            bucketName: bucket.name,
                            actionText: action.text
                        });
                    }
                });
            });

            if (todayItems.length > 0) {
                todayDeadlinesList.innerHTML = todayItems.map(item => 
                    `<p class="text-red-600 text-sm">â€¢ [${item.bucketName}] ${item.actionText}</p>`
                ).join('');
                todayDeadlines.classList.remove('hidden');
            } else {
                todayDeadlines.classList.add('hidden');
            }
        }

        // ì¶”ê°€ í¼ ê´€ë ¨
        function showAddForm() {
            addBucketForm.classList.remove('hidden');
            bucketNameInput.focus();
        }

        function hideAddForm() {
            addBucketForm.classList.add('hidden');
            bucketNameInput.value = '';
            unitPriceInput.value = '';
            quantityInput.value = '';
            productInput.value = '';
            contractTermsInput.value = '';
        }

        // ìƒˆ ë²„í‚· ì¶”ê°€
        function addBucket() {
            const name = bucketNameInput.value.trim();
            if (!name) {
                alert('ê´‘ê³ ì£¼ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
                return;
            }

            try {
                const bucketData = {
                    id: Date.now(),
                    name: name,
                    stage: 'ëŒ€ê¸°',
                    unit_price: unitPriceInput.value.trim(),
                    quantity: quantityInput.value.trim(),
                    product: productInput.value.trim(),
                    contract_terms: contractTermsInput.value.trim(),
                    created_at: new Date().toISOString(),
                    actions: defaultActionItems['ëŒ€ê¸°'].map((action, index) => ({
                        id: Date.now() + index,
                        text: action,
                        completed: false,
                        deadline: null,
                        order_index: index
                    }))
                };

                buckets.unshift(bucketData);
                saveData();
                hideAddForm();
                renderBuckets();
                updateTodayDeadlines();
                
            } catch (error) {
                console.error('ë²„í‚· ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì•¡ì…˜ ì•„ì´í…œ ì •ë ¬
        function getSortedActions(actions) {
            const incompleteActions = actions.filter(action => !action.completed);
            const completedActions = actions.filter(action => action.completed);
            
            const sortedIncomplete = incompleteActions.sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return sortOrder === 'asc' ? 1 : -1;
                if (!b.deadline) return sortOrder === 'asc' ? -1 : 1;
                
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            const sortedCompleted = completedActions.sort((a, b) => {
                if (!a.deadline && !b.deadline) return 0;
                if (!a.deadline) return sortOrder === 'asc' ? 1 : -1;
                if (!b.deadline) return sortOrder === 'asc' ? -1 : 1;
                
                const dateA = new Date(a.deadline);
                const dateB = new Date(b.deadline);
                return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
            });
            
            return [...sortedIncomplete, ...sortedCompleted];
        }

        // íˆ¬ë‘ë·° ë Œë”ë§
        function renderTodoView() {
            const allItems = [];
            buckets.forEach(bucket => {
                (bucket.actions || []).forEach(action => {
                    allItems.push({
                        ...action,
                        bucketName: bucket.name,
                        bucketId: bucket.id,
                        bucketStage: bucket.stage
                    });
                });
            });

            let filteredItems = allItems;
            if (!showCompletedTodos) {
                filteredItems = allItems.filter(item => !item.completed);
            }

            const sortedItems = getSortedActions(filteredItems);

            if (sortedItems.length === 0) {
                todoList.classList.add('hidden');
                todoEmpty.classList.remove('hidden');
                return;
            }

            todoList.classList.remove('hidden');
            todoEmpty.classList.add('hidden');

            todoList.innerHTML = sortedItems.map(action => {
                const today = new Date().toISOString().split('T')[0];
                const isToday = action.deadline === today && !action.completed;
                
                return `
                    <div class="flex items-center justify-between p-3 rounded-lg border ${action.completed ? 'bg-gray-50 border-gray-200' : 'bg-white border-gray-200'}">
                        <div class="flex items-center gap-3 flex-1">
                            <button onclick="toggleActionItem(${action.bucketId}, ${action.id})" class="flex-shrink-0 text-lg">
                                ${action.completed ? 'âœ…' : 'â­•'}
                            </button>
                            <div class="flex-1">
                                <p class="text-sm font-medium ${action.completed ? 'line-through text-gray-500' : 'text-gray-800'}">
                                    ${action.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                                </p>
                                <p class="text-xs ${action.completed ? 'text-gray-400' : 'text-gray-500'}">
                                    [${action.bucketName}] - ${action.bucketStage}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="date" value="${action.deadline || ''}" onchange="setDeadline(${action.bucketId}, ${action.id}, this.value)" class="px-2 py-1 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${isToday ? 'border-red-500 bg-red-50' : 'border-gray-200'} ${action.completed ? 'text-gray-400' : ''}"/>
                            <button onclick="deleteActionItem(${action.bucketId}, ${action.id})" class="text-red-500 hover:text-red-700">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ë²„í‚· ëª©ë¡ ë Œë”ë§
        function renderBuckets() {
            if (buckets.length === 0) {
                emptyState.classList.remove('hidden');
                bucketsContainer.innerHTML = '';
                return;
            }

            emptyState.classList.add('hidden');
            bucketsContainer.innerHTML = '';

            buckets.forEach(bucket => {
                const bucketElement = createBucketElement(bucket);
                bucketsContainer.appendChild(bucketElement);
            });
        }

        // ë²„í‚· ìš”ì†Œ ìƒì„±
        function createBucketElement(bucket) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow-md p-4';

            const actions = bucket.actions || [];
            const sortedActions = getSortedActions(actions);
            const isCollapsed = collapsedBuckets[bucket.id] === true;
            const isContractCollapsed = collapsedContracts[bucket.id] === true;

            div.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <button onclick="toggleBucketCollapse(${bucket.id})" class="text-gray-600 hover:text-gray-800">
                                ${isCollapsed ? 'â–¶' : 'â–¼'}
                            </button>
                            ${editingBucket === bucket.id ? `
                                <input type="text" value="${bucket.name.replace(/"/g, '&quot;')}" 
                                       onkeypress="if(event.key==='Enter') saveEditBucket(${bucket.id}, this.value); if(event.key==='Escape') cancelEditBucket();"
                                       onblur="saveEditBucket(${bucket.id}, this.value)"
                                       class="flex-1 px-2 py-1 text-sm font-semibold border border-blue-500 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                       autofocus />
                                <button onclick="cancelEditBucket()" class="text-red-500 hover:text-red-700 text-sm">âœ•</button>
                            ` : `
                                <h3 class="text-sm font-semibold text-gray-800 flex-1">${bucket.name}</h3>
                                <button onclick="startEditBucket(${bucket.id})" class="text-gray-400 hover:text-gray-600 text-sm">âœï¸</button>
                            `}
                        </div>
                    </div>
                    <button onclick="deleteBucket(${bucket.id})" class="text-red-500 hover:text-red-700 text-sm">
                        ğŸ—‘ï¸
                    </button>
                </div>

                ${!isCollapsed ? `
                    <!-- ë‹¨ê³„ ì„ íƒ -->
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-700 mb-1">ë‹¨ê³„</label>
                        <select onchange="changeStage(${bucket.id}, this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                            <option value="ëŒ€ê¸°" ${bucket.stage === 'ëŒ€ê¸°' ? 'selected' : ''}>ëŒ€ê¸°</option>
                            <option value="ì§„í–‰_ê´‘ê³ ì œì‘" ${bucket.stage === 'ì§„í–‰_ê´‘ê³ ì œì‘' ? 'selected' : ''}>ì§„í–‰_ê´‘ê³ ì œì‘</option>
                            <option value="ì§„í–‰_ê´‘ê³ ìš´ì˜" ${bucket.stage === 'ì§„í–‰_ê´‘ê³ ìš´ì˜' ? 'selected' : ''}>ì§„í–‰_ê´‘ê³ ìš´ì˜</option>
                            <option value="ì§„í–‰_ë§¤ì¶œì •ì‚°" ${bucket.stage === 'ì§„í–‰_ë§¤ì¶œì •ì‚°' ? 'selected' : ''}>ì§„í–‰_ë§¤ì¶œì •ì‚°</option>
                        </select>
                    </div>

                    <!-- ê³„ì•½ ì •ë³´ -->
                    <div class="mb-3 p-3 bg-gray-50 rounded">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xs font-medium text-gray-700">ê³„ì•½ ì •ë³´</h4>
                            <button onclick="toggleContractCollapse(${bucket.id})" class="text-gray-600 hover:text-gray-800">
                                ${isContractCollapsed ? 'â–¶' : 'â–¼'}
                            </button>
                        </div>
                        
                        ${!isContractCollapsed ? `
                            <div class="grid grid-cols-1 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ë‹¨ê°€ (ì›)</label>
                                    <input type="text" value="${bucket.unit_price || ''}" onchange="updateBucketInfo(${bucket.id}, 'unit_price', this.value)" placeholder="ì˜ˆ: 1,000,000" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"/>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ìˆ˜ëŸ‰</label>
                                    <input type="text" value="${bucket.quantity || ''}" onchange="updateBucketInfo(${bucket.id}, 'quantity', this.value)" placeholder="ì˜ˆ: 100íšŒ ë…¸ì¶œ" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"/>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ìƒí’ˆ</label>
                                    <select onchange="updateBucketInfo(${bucket.id}, 'product', this.value)" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">ì„ íƒ</option>
                                        <option value="CPM" ${bucket.product === 'CPM' ? 'selected' : ''}>CPM</option>
                                        <option value="CPA" ${bucket.product === 'CPA' ? 'selected' : ''}>CPA</option>
                                        <option value="CPA+" ${bucket.product === 'CPA+' ? 'selected' : ''}>CPA+</option>
                                        <option value="CPR" ${bucket.product === 'CPR' ? 'selected' : ''}>CPR</option>
                                        <option value="CPR+" ${bucket.product === 'CPR+' ? 'selected' : ''}>CPR+</option>
                                        <option value="CPS" ${bucket.product === 'CPS' ? 'selected' : ''}>CPS</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ê³„ì•½ì¡°ê±´</label>
                                    <textarea onchange="updateBucketInfo(${bucket.id}, 'contract_terms', this.value)" placeholder="ê³„ì•½ ì¡°ê±´..." rows="2" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none">${bucket.contract_terms || ''}</textarea>
                                </div>
                            </div>
                        ` : `
                            ${(bucket.unit_price || bucket.quantity || bucket.product) ? `
                                <div class="text-xs text-gray-500">
                                    ${bucket.unit_price ? `${bucket.unit_price}ì›` : ''}
                                    ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                    ${bucket.quantity ? `${bucket.quantity}` : ''}
                                    ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                    ${bucket.product ? `${bucket.product}` : ''}
                                </div>
                            ` : ''}
                        `}
                    </div>

                    <!-- ì•¡ì…˜ ì•„ì´í…œ -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xs font-medium text-gray-700">ì•¡ì…˜ ì•„ì´í…œ</h4>
                            <button onclick="addCustomAction(${bucket.id})" class="text-blue-600 hover:text-blue-800 text-xs">
                                â•
                            </button>
                        </div>
                        
                        ${sortedActions.map(action => {
                            if (!showCompletedInBuckets && action.completed) {
                                return '';
                            }
                            
                            const today = new Date().toISOString().split('T')[0];
                            const isToday = action.deadline === today && !action.completed;
                            
                            return `
                                <div class="flex flex-col gap-1">
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleActionItem(${bucket.id}, ${action.id})" class="flex-shrink-0 ${action.completed ? 'text-green-600' : 'text-gray-400'}">
                                            ${action.completed ? 'âœ…' : 'â­•'}
                                        </button>
                                        ${editingAction === action.id ? `
                                            <input type="text" value="${action.text.replace(/"/g, '&quot;')}" 
                                                   onkeypress="if(event.key==='Enter') saveEditAction(${action.id}, this.value); if(event.key==='Escape') cancelEditAction();"
                                                   onblur="saveEditAction(${action.id}, this.value)"
                                                   class="flex-1 px-1 py-0.5 text-xs border border-blue-500 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                                   autofocus />
                                            <button onclick="cancelEditAction()" class="text-red-500 hover:text-red-700 text-xs">âœ•</button>
                                        ` : `
                                            <span class="flex-1 text-xs ${action.completed ? 'line-through text-gray-500' : 'text-gray-700'} cursor-pointer" 
                                                  onclick="startEditAction(${action.id})">
                                                ${action.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                                            </span>
                                            <button onclick="deleteActionItem(${bucket.id}, ${action.id})" class="text-red-500 hover:text-red-700 text-xs">
                                                âŒ
                                            </button>
                                        `}
                                    </div>
                                    ${editingAction !== action.id ? `
                                        <input type="date" value="${action.deadline || ''}" onchange="setDeadline(${bucket.id}, ${action.id}, this.value)" class="ml-5 px-1 py-0.5 text-xs border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 ${isToday ? 'border-red-500 bg-red-50' : 'border-gray-200'}" />
                                    ` : ''}
                                </div>
                            `;
                        }).filter(html => html !== '').join('')}
                    </div>
                ` : `
                    <!-- ì ‘í˜€ìˆì„ ë•Œ ìš”ì•½ ì •ë³´ -->
                    <div class="mt-1">
                        <div class="flex justify-between text-xs text-gray-600">
                            <span>${bucket.stage}</span>
                        </div>
                        ${(bucket.unit_price || bucket.quantity || bucket.product) ? `
                            <div class="text-xs text-gray-500 mt-1">
                                ${bucket.unit_price ? `${bucket.unit_price}ì›` : ''}
                                ${(bucket.unit_price && bucket.quantity) ? ' | ' : ''}
                                ${bucket.quantity ? `${bucket.quantity}` : ''}
                                ${((bucket.unit_price || bucket.quantity) && bucket.product) ? ' | ' : ''}
                                ${bucket.product ? `${bucket.product}` : ''}
                            </div>
                        ` : ''}
                    </div>
                `}
            `;

            return div;
        }

        // ë²„í‚· ê´€ë ¨ í•¨ìˆ˜ë“¤
        function toggleBucketCollapse(bucketId) {
            collapsedBuckets[bucketId] = !collapsedBuckets[bucketId];
            renderBuckets();
        }

        function toggleContractCollapse(bucketId) {
            collapsedContracts[bucketId] = !collapsedContracts[bucketId];
            renderBuckets();
        }

        function startEditBucket(bucketId) {
            editingBucket = bucketId;
            renderBuckets();
        }

        function saveEditBucket(bucketId, newName) {
            if (!newName.trim()) return;
            
            const bucket = buckets.find(b => b.id === bucketId);
            if (bucket) {
                bucket.name = newName.trim();
                saveData();
            }
            
            editingBucket = null;
            renderBuckets();
        }

        function cancelEditBucket() {
            editingBucket = null;
            renderBuckets();
        }

        function startEditAction(actionId) {
            editingAction = actionId;
            renderBuckets();
        }

        function saveEditAction(actionId, newText) {
            if (!newText.trim()) return;
            
            buckets.forEach(bucket => {
                const action = bucket.actions?.find(a => a.id === actionId);
                if (action) {
                    action.text = newText.trim();
                    saveData();
                }
            });
            
            editingAction = null;
            renderBuckets();
        }

        function cancelEditAction() {
            editingAction = null;
            renderBuckets();
        }

        function updateBucketInfo(bucketId, field, value) {
            const bucket = buckets.find(b => b.id === bucketId);
            if (bucket) {
                bucket[field] = value;
                saveData();
            }
        }

        function changeStage(bucketId, newStage) {
            const bucket = buckets.find(b => b.id === bucketId);
            if (bucket) {
                bucket.stage = newStage;
                
                // ê¸°ì¡´ ì•¡ì…˜ ì•„ì´í…œ ìœ ì§€í•˜ê³  ìƒˆ ë‹¨ê³„ì˜ ê¸°ë³¸ ì•¡ì…˜ ì•„ì´í…œ ì¶”ê°€
                const existingActions = bucket.actions || [];
                const newDefaultActions = defaultActionItems[newStage] || [];
                
                newDefaultActions.forEach(actionText => {
                    const exists = existingActions.some(action => action.text === actionText);
                    if (!exists) {
                        existingActions.push({
                            id: Date.now() + Math.random(),
                            text: actionText,
                            completed: false,
                            deadline: null
                        });
                    }
                });
                
                bucket.actions = existingActions;
                saveData();
                renderBuckets();
            }
        }

        function addCustomAction(bucketId) {
            const text = prompt('ìƒˆ ì•¡ì…˜ì•„ì´í…œì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (!text || !text.trim()) return;

            const bucket = buckets.find(b => b.id === bucketId);
            if (bucket) {
                if (!bucket.actions) bucket.actions = [];
                bucket.actions.push({
                    id: Date.now(),
                    text: text.trim(),
                    completed: false,
                    deadline: null
                });
                saveData();
                renderBuckets();
                updateTodayDeadlines();
            }
        }

        function toggleActionItem(bucketId, actionId) {
            const bucket = buckets.find(b => b.id === bucketId);
            const action = bucket?.actions?.find(a => a.id === actionId);
            
            if (action) {
                action.completed = !action.completed;
                saveData();
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else {
                    renderTodoView();
                }
                updateTodayDeadlines();
            }
        }

        function setDeadline(bucketId, actionId, deadline) {
            const bucket = buckets.find(b => b.id === bucketId);
            const action = bucket?.actions?.find(a => a.id === actionId);
            
            if (action) {
                action.deadline = deadline || null;
                saveData();
                updateTodayDeadlines();
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else {
                    renderTodoView();
                }
            }
        }

        function deleteActionItem(bucketId, actionId) {
            if (!confirm('ì´ ì•¡ì…˜ì•„ì´í…œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const bucket = buckets.find(b => b.id === bucketId);
            if (bucket && bucket.actions) {
                bucket.actions = bucket.actions.filter(a => a.id !== actionId);
                saveData();
                
                if (currentView === 'buckets') {
                    renderBuckets();
                } else {
                    renderTodoView();
                }
                updateTodayDeadlines();
            }
        }

        function deleteBucket(bucketId) {
            if (!confirm('ì •ë§ë¡œ ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ì•¡ì…˜ì•„ì´í…œë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;

            buckets = buckets.filter(b => b.id !== bucketId);
            saveData();
            renderBuckets();
            updateTodayDeadlines();
        }

        // íˆ¬ë‘ë¦¬ìŠ¤íŠ¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function showAddTodoForm() {
            addTodoForm.classList.remove('hidden');
            updateTodoBucketSelect();
            todoTextInput.focus();
        }

        function hideAddTodoForm() {
            addTodoForm.classList.add('hidden');
            todoBucketSelect.value = '';
            todoDeadlineInput.value = '';
            todoTextInput.value = '';
        }

        function updateTodoBucketSelect() {
            todoBucketSelect.innerHTML = '<option value="">ê´‘ê³ ì£¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            buckets.forEach(bucket => {
                const option = document.createElement('option');
                option.value = bucket.id;
                option.textContent = bucket.name;
                todoBucketSelect.appendChild(option);
            });
        }

        function addTodoItem() {
            const bucketId = parseInt(todoBucketSelect.value);
            const text = todoTextInput.value.trim();
            const deadline = todoDeadlineInput.value || null;

            if (!bucketId) {
                alert('ê´‘ê³ ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!text) {
                alert('ì•¡ì…˜ì•„ì´í…œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const bucket = buckets.find(b => b.id === bucketId);
            if (bucket) {
                if (!bucket.actions) bucket.actions = [];
                bucket.actions.push({
                    id: Date.now(),
                    text: text,
                    completed: false,
                    deadline: deadline
                });
                
                saveData();
                hideAddTodoForm();
                renderTodoView();
                updateTodayDeadlines();
            }
        }

        // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥
        function exportToExcel() {
            try {
                const allItems = [];
                buckets.forEach(bucket => {
                    (bucket.actions || []).forEach(action => {
                        allItems.push({
                            'ê´‘ê³ ì£¼ID': bucket.id,
                            'ê´‘ê³ ì£¼ëª…': bucket.name,
                            'ì•¡ì…˜ì•„ì´í…œ': action.text,
                            'ë§ˆê°ì¼ì': action.deadline || '',
                            'ì™„ë£Œì—¬ë¶€': action.completed ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ'
                        });
                    });
                });

                if (allItems.length === 0) {
                    alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                let filteredItems = allItems;
                if (currentView === 'todo' && !showCompletedTodos) {
                    filteredItems = allItems.filter(item => item.ì™„ë£Œì—¬ë¶€ === 'ë¯¸ì™„ë£Œ');
                } else if (currentView === 'buckets' && !showCompletedInBuckets) {
                    filteredItems = allItems.filter(item => item.ì™„ë£Œì—¬ë¶€ === 'ë¯¸ì™„ë£Œ');
                }

                // ì›Œí¬ì‹œíŠ¸ ìƒì„±
                const ws = XLSX.utils.json_to_sheet(filteredItems);

                // ì—´ ë„ˆë¹„ ì„¤ì •
                const colWidths = [
                    { wch: 10 }, // ê´‘ê³ ì£¼ID
                    { wch: 20 }, // ê´‘ê³ ì£¼ëª…
                    { wch: 30 }, // ì•¡ì…˜ì•„ì´í…œ
                    { wch: 12 }, // ë§ˆê°ì¼ì
                    { wch: 10 }  // ì™„ë£Œì—¬ë¶€
                ];
                ws['!cols'] = colWidths;

                // ì›Œí¬ë¶ ìƒì„±
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ì•¡ì…˜ì•„ì´í…œ ëª©ë¡');

                // íŒŒì¼ëª… ìƒì„± (í˜„ì¬ ë‚ ì§œ í¬í•¨)
                const today = new Date();
                const dateString = today.getFullYear() + '-' + 
                    String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(today.getDate()).padStart(2, '0');
                const filename = `ê´‘ê³ í”„ë¡œì íŠ¸_ì•¡ì…˜ì•„ì´í…œ_${dateString}.xlsx`;

                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                XLSX.writeFile(wb, filename);

                // ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ì•Œë¦¼
                showNotification('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

            } catch (error) {
                console.error('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                alert('ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë©”ëª¨ì¥ ê¸°ëŠ¥
        function loadMemo() {
            const savedMemo = localStorage.getItem(`memo_${userId}`);
            if (savedMemo) {
                memoTextarea.value = savedMemo;
                memoStatus.textContent = 'ì €ì¥ëœ ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.';
            } else {
                memoTextarea.value = '';
                memoStatus.textContent = 'ìƒˆë¡œìš´ ë©”ëª¨ë¥¼ ì‘ì„±í•˜ì„¸ìš”.';
            }
        }

        function saveMemo() {
            const memoContent = memoTextarea.value;
            localStorage.setItem(`memo_${userId}`, memoContent);
            memoStatus.textContent = 'ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
            showNotification('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }

        function clearMemo() {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                memoTextarea.value = '';
                localStorage.removeItem(`memo_${userId}`);
                memoStatus.textContent = 'ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
        }

        let autoSaveTimeout;
        function autoSaveMemo() {
            clearTimeout(autoSaveTimeout);
            memoStatus.textContent = 'ì…ë ¥ ì¤‘...';
            
            autoSaveTimeout = setTimeout(() => {
                const memoContent = memoTextarea.value;
                localStorage.setItem(`memo_${userId}`, memoContent);
                memoStatus.textContent = 'ìë™ ì €ì¥ë¨';
            }, 1000);
        }

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ë°˜ë³µ ì‘ì—… ê´€ë¦¬ ê¸°ëŠ¥
        function loadRecurringTasks() {
            const savedTasks = localStorage.getItem(`recurring_tasks_${userId}`);
            recurringTasks = savedTasks ? JSON.parse(savedTasks) : [];
        }

        function saveRecurringTasks() {
            localStorage.setItem(`recurring_tasks_${userId}`, JSON.stringify(recurringTasks));
        }

        function showAddRecurringForm() {
            addRecurringForm.classList.remove('hidden');
            updateRecurringBucketSelect();
            
            // ê¸°ë³¸ê°’ ì„¤ì •
            const today = new Date();
            recurringStartDate.value = today.toISOString().split('T')[0];
            recurringTaskName.focus();
        }

        function hideAddRecurringForm() {
            addRecurringForm.classList.add('hidden');
            recurringBucketSelect.value = '';
            recurringTaskName.value = '';
            recurringTypeSelect.value = 'daily';
            recurringTimeSelect.value = '09:00';
            recurringStartDate.value = '';
            recurringEndDate.value = '';
            recurringStatus.value = 'active';
        }

        function updateRecurringBucketSelect() {
            recurringBucketSelect.innerHTML = '<option value="">ê´‘ê³ ì£¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            buckets.forEach(bucket => {
                const option = document.createElement('option');
                option.value = bucket.id;
                option.textContent = bucket.name;
                recurringBucketSelect.appendChild(option);
            });
        }

        function addRecurringTask() {
            const bucketId = parseInt(recurringBucketSelect.value);
            const taskName = recurringTaskName.value.trim();
            const type = recurringTypeSelect.value;
            const time = recurringTimeSelect.value;
            const startDate = recurringStartDate.value;
            const endDate = recurringEndDate.value || null;
            const status = recurringStatus.value;

            if (!bucketId || !taskName || !startDate) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const recurringTaskData = {
                id: Date.now(),
                bucket_id: bucketId,
                task_name: taskName,
                recurring_type: type,
                recurring_time: time,
                start_date: startDate,
                end_date: endDate,
                status: status,
                last_generated: null,
                created_at: new Date().toISOString()
            };

            recurringTasks.push(recurringTaskData);
            saveRecurringTasks();
            hideAddRecurringForm();
            renderRecurringView();
            
            showNotification('ë°˜ë³µ ì‘ì—…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        function renderRecurringView() {
            if (recurringTasks.length === 0) {
                recurringList.innerHTML = '';
                recurringEmpty.classList.remove('hidden');
                return;
            }

            recurringEmpty.classList.add('hidden');
            
            recurringList.innerHTML = recurringTasks.map(task => {
                const bucket = buckets.find(b => b.id === task.bucket_id);
                const bucketName = bucket ? bucket.name : 'ì‚­ì œëœ ê´‘ê³ ì£¼';
                
                return `
                    <div class="p-4 border border-gray-200 rounded-lg ${task.status === 'active' ? 'bg-white' : 'bg-gray-50'}">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-gray-800">${task.task_name.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h4>
                                <p class="text-sm text-gray-600">[${bucketName}] - ${task.recurring_type === 'daily' ? 'ë§¤ì¼' : 'ë§¤ì£¼'} ${task.recurring_time}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="toggleRecurringStatus(${task.id})" class="px-2 py-1 text-xs rounded ${task.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">
                                    ${task.status === 'active' ? 'í™œì„±' : 'ì¼ì‹œì •ì§€'}
                                </button>
                                <button onclick="deleteRecurringTask(${task.id})" class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">
                                    ì‚­ì œ
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            <p>ì‹œì‘ì¼: ${task.start_date} ${task.end_date ? `| ì¢…ë£Œì¼: ${task.end_date}` : ''}</p>
                            <p>ë§ˆì§€ë§‰ ìƒì„±: ${task.last_generated || 'ì•„ì§ ìƒì„±ëœ ì‘ì—… ì—†ìŒ'}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleRecurringStatus(taskId) {
            const task = recurringTasks.find(t => t.id === taskId);
            if (!task) return;

            task.status = task.status === 'active' ? 'paused' : 'active';
            saveRecurringTasks();
            renderRecurringView();
            
            showNotification(`ë°˜ë³µ ì‘ì—…ì´ ${task.status === 'active' ? 'í™œì„±í™”' : 'ì¼ì‹œì •ì§€'}ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
        }

        function deleteRecurringTask(taskId) {
            if (!confirm('ì´ ë°˜ë³µ ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            recurringTasks = recurringTasks.filter(task => task.id !== taskId);
            saveRecurringTasks();
            renderRecurringView();
            
            showNotification('ë°˜ë³µ ì‘ì—…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        // ë°˜ë³µ ì‘ì—… ìŠ¤ì¼€ì¤„ë§ - ì„¤ì •ëœ ì‹œê°„ì— ìë™ìœ¼ë¡œ ì•¡ì…˜ì•„ì´í…œ ìƒì„±
        function checkAndCreateRecurringActions() {
            const now = new Date();
            const currentTime = now.toTimeString().slice(0, 5); // HH:MM í˜•ì‹
            const currentDate = now.toISOString().split('T')[0];
            const currentDay = now.getDay(); // 0=ì¼ìš”ì¼, 1=ì›”ìš”ì¼, ...

            recurringTasks.forEach(task => {
                if (task.status !== 'active') return;
                
                // ì¢…ë£Œì¼ ì²´í¬
                if (task.end_date && currentDate > task.end_date) return;
                
                // ì‹œì‘ì¼ ì²´í¬
                if (currentDate < task.start_date) return;
                
                // ì‹œê°„ ì²´í¬ (Â±2ë¶„ ì˜¤ì°¨ í—ˆìš©)
                const taskTime = new Date(`1970-01-01T${task.recurring_time}:00`);
                const currentTimeObj = new Date(`1970-01-01T${currentTime}:00`);
                const timeDiff = Math.abs(currentTimeObj - taskTime) / (1000 * 60); // ë¶„ ë‹¨ìœ„
                
                if (timeDiff > 2) return; // 2ë¶„ ì´ìƒ ì°¨ì´ë‚˜ë©´ íŒ¨ìŠ¤
                
                // ë§ˆì§€ë§‰ ìƒì„±ì¼ ì²´í¬ - ì˜¤ëŠ˜ ì´ë¯¸ ìƒì„±ë˜ì—ˆìœ¼ë©´ íŒ¨ìŠ¤
                if (task.last_generated === currentDate) return;
                
                // ì£¼ê°„ ë°˜ë³µì˜ ê²½ìš° ìš”ì¼ ì²´í¬
                if (task.recurring_type === 'weekly') {
                    const startDay = new Date(task.start_date).getDay();
                    if (startDay !== currentDay) return;
                }
                
                // í•´ë‹¹ ë²„í‚·ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                const bucket = buckets.find(b => b.id === task.bucket_id);
                if (!bucket) return;
                
                // ì•¡ì…˜ì•„ì´í…œ ìƒì„±
                try {
                    if (!bucket.actions) bucket.actions = [];
                    
                    const newAction = {
                        id: Date.now() + Math.random(),
                        text: `${task.task_name} (${currentDate})`,
                        completed: false,
                        deadline: null,
                        recurring_task_id: task.id,
                        created_at: new Date().toISOString()
                    };
                    
                    bucket.actions.push(newAction);
                    
                    // ë§ˆì§€ë§‰ ìƒì„±ì¼ ì—…ë°ì´íŠ¸
                    task.last_generated = currentDate;
                    
                    // ë°ì´í„° ì €ì¥
                    saveData();
                    saveRecurringTasks();
                    
                    console.log(`ë°˜ë³µ ì‘ì—… ìƒì„±ë¨: ${task.task_name} -> [${bucket.name}]`);
                    
                    // í˜„ì¬ ë·° ì—…ë°ì´íŠ¸
                    if (currentView === 'buckets') {
                        renderBuckets();
                    } else if (currentView === 'todo') {
                        renderTodoView();
                    }
                    
                    updateTodayDeadlines();
                    
                } catch (error) {
                    console.error('ë°˜ë³µ ì‘ì—… ìƒì„± ì˜¤ë¥˜:', error);
                }
            });
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì•± ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
